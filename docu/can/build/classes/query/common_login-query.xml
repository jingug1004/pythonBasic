<?xml version="1.0" encoding='EUC-KR'?>
<queryMap desc="LOGIN">
    <query id="tbda_user_login" desc="조회" fetchSize="10">
        <![CDATA[
			SELECT
			         A.USER_ID     -- 사용자ID         
			       , A.USER_NM     -- 사용자명         
			       , A.PSWD        -- 비밀번호         
			       , B.DUTY_GRP_CD -- 업무그룹코드     
			       , A.DEPT_CD     -- 부서코드
			       , A.DEPT_NM	   -- 부서이름
			       , A.TEAM_CD	   -- 팀코드
			       , A.TEAM_NM	   -- 팀이름
			       , A.FLOC		   -- 직위코드
			       , A.FGRADE	   -- 직위         
			       , A.TEL_NO      -- 전화번호         
			       , B.HP_NO       -- 휴대폰번호       
			       , B.STR_DT      -- 유효기간 시작일자
			       , B.END_DT      -- 유효기간 종료일자
			       , B.INST_ID     -- 작성자ID         
			       , B.INST_DTM    -- 작성일시         
			       , B.UPDT_ID     -- 수정자ID         
			       , B.UPDT_DTM    -- 수정일시         
			FROM   USRBM.TBRK_USER A, TBDA_USER B
			WHERE  A.USER_ID = B.USER_ID
			AND	   A.USER_ID = ?
			AND	   B.STR_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')
			AND    B.END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
        ]]>
    </query>
    
    <query id="tbda_nm_login" desc="조회" fetchSize="10">
        <![CDATA[
            SELECT  
                     T1.MN_ID -- 메뉴아이디
                   , MN_NM          -- 메뉴명
                   , ORD_NO         -- 순서번호
                   , UP_MN_ID       -- 상위메뉴ID
                   , SCRN_ID        -- 화면ID
                   , URL            -- 메뉴URL
                   , RMK            -- 비고
                   , SRCH_YN      -- 조회여부
                   , INPT_YN      -- 입력여부
                   , LVL          -- 메뉴 레벨 
            FROM     (
                        SELECT 
                               TM.* ,LEVEL - 1 AS LVL          
                        FROM   TBDA_MN TM
                        START  WITH TM.MN_ID ='000000000'
                        CONNECT BY PRIOR  TM.MN_ID =  TM.UP_MN_ID
                        ORDER SIBLINGS BY UP_MN_ID, ORD_NO
                     ) T1
                   , (
                      SELECT *
                        FROM (  
		                        SELECT 
		                                 MN_ID
		                               , DECODE(SRCH_YN, 'Y', 'T', 'F') SRCH_YN      -- 조회여부
		                               , DECODE(INPT_YN, 'Y', 'T', 'F') INPT_YN      -- 입력여부
		                        FROM   TBDA_MN_AUTH 
		                        WHERE  USER_ID = ?
		                        AND    SRCH_YN = 'Y'
		                        ORDER BY MN_ID
		                     )
		                WHERE MN_ID NOT IN( SELECT MN_ID 
                                              FROM TBDA_MN 
                                             WHERE PERSONAL_DATA_MN = 'Y' 
                                               AND MN_ID NOT IN (SELECT MN_ID 
                                                       FROM TBDA_MN_AUTH
                                                      WHERE USER_ID = ?
                                                        AND PERSONAL_YN = 'Y'  
                                                        AND PERSONAL_AUTH_CHK='Y'
                                                        AND PERSONAL_MN_IP LIKE '%' || ? || '%'
                                                    )
                                          )        
                      ) T2
            WHERE  T1.MN_ID = T2.MN_ID
            ORDER BY TO_NUMBER(SUBSTR(MN_ID,2,4))+NVL(ORD_NO,0)
        ]]>
    </query>
    
	<query id="tbda_user_login_view" desc="조회" fetchSize="10">
        <![CDATA[
			SELECT
			         A.USER_ID     -- 사용자ID         
			       , A.USER_NM     -- 사용자명         
			       , A.PSWD        -- 비밀번호         
			       , B.DUTY_GRP_CD -- 업무그룹코드     
			       , A.DEPT_CD     -- 부서코드
			       , A.DEPT_NM	   -- 부서이름
			       , A.TEAM_CD	   -- 팀코드
			       , A.TEAM_NM	   -- 팀이름
			       , A.FLOC		   -- 직위코드
			       , A.FGRADE	   -- 직위         
			       , A.TEL_NO      -- 전화번호         
			       , B.HP_NO       -- 휴대폰번호       
			       , B.STR_DT      -- 유효기간 시작일자
			       , B.END_DT      -- 유효기간 종료일자
			       , NULL CAN_CD
			       , 'F' ISVALID
			       , B.INST_ID     -- 작성자ID         
			       , B.INST_DTM    -- 작성일시         
			       , B.UPDT_ID     -- 수정자ID         
			       , B.UPDT_DTM    -- 수정일시            
			       , '' LOG_SEQ    -- 개인정보관련, 로그순번
		           , A.PSWD_CHK
		           , A.LOGIN_DT
			FROM   USRBM.TBRK_USER A, TBDA_USER B
			WHERE  A.USER_ID = B.USER_ID
			AND	   B.USER_ID = NVL(?, B.USER_ID)
			AND	   B.STR_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')
			AND    B.END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
        ]]>
    </query>     
    
    
    
    
	<query id="tbda_get_login_info" desc="최종로그인 기록 조회" fetchSize="10">

        <![CDATA[

			SELECT USER_ID, SEQ, IP_ADDR, LOGIN_TIME
			FROM
			(
				SELECT USER_ID, SEQ, IP_ADDR
				, to_char(inst_dt,'YYYY.MM.DD HH24:MI') LOGIN_TIME
				from TBDA_LOGIN
				WHERE  USER_ID =  ?
				ORDER BY LOGIN_TIME DESC
			)
			WHERE ROWNUM<3

        ]]>

    </query>     
    
    
    <query id="tbda_user_login_save" desc="로그인기록 저장" fetchSize="10">

        <![CDATA[

			INSERT INTO TBDA_LOGIN (
				  USER_ID
				, SEQ
				, IP_ADDR
			    , INST_DT			    
			) VALUES (
			     ?             -- USER_ID
			    ,(select nvl(max(seq),0)+1
					from TBDA_LOGIN
					where user_id= ?
				)             -- SEQ
			    , ?				-- IP_ADDR
			    , SYSDATE       -- INST_DT	
			)

        ]]>

    </query>       
    
    
    
      <query id="personal_access_insert" desc="개인정보 접속이력 저장" fetchSize="10">
        <![CDATA[  
			 INSERT  /* personal_access_insert */
			         INTO TBJA_PSNL_ACCESS (
			      USER_ID,
			      LOG_SEQ,
			      SEQ_NO,
			      FORM_ID,
			      ACCESS_DT,
			      JOB_TYPE,
			      ACTION,
			      PARAM)
			  VALUES (
			       ?,
			       ?,
			       (SELECT NVL(MAX(SEQ_NO),0)+1 FROM TBJA_PSNL_ACCESS WHERE USER_ID = ? AND LOG_SEQ = ?),
			       ?,
			       SYSDATE,
			       ?,
			       ?,
			       ?
			      )  
              ]]>
    </query>      
    
    
    
    <query id="user_login_chk_save" desc="중복로그인 확인용 기록 저장" fetchSize="10">

        <![CDATA[

			merge into  TBJA_LOGIN_DUP_CHK
			using       dual
			on	(                      
                       			USER_ID		= ?
				)
			when matched then
            	update set  
                        		SESSION_ID	= ?
			when not matched then
            	insert (
                        		USER_ID
                        		,SESSION_ID   
               	) values (
                        		?
                        		,?
                )

        ]]>

    </query>
    
      <query id="user_login_check" desc="중복로그인 확인용 기록 조회" fetchSize="10">

        <![CDATA[
        	SELECT		SESSION_ID
        	FROM		TBJA_LOGIN_DUP_CHK
        	WHERE		USER_ID		= ?
        ]]>

    </query>
     
     
     <query id="tbrk_user_loginchk_view" desc="조회" fetchSize="10">
        <![CDATA[
			SELECT PSWD_CHK    
				   , LOGIN_DT  
			  FROM USRBM.TBRK_USER
			 WHERE USER_ID = ?
        ]]>
    </query>  
    
    <query id="user_login_pswd_chk_save" desc="로그인 비밀번호 오류 수 저장" fetchSize="10">
        <![CDATA[
			UPDATE USRBM.TBRK_USER 
			SET    PSWD_CHK	= (SELECT CASE WHEN PSWD_CHK IS NULL THEN '1' ELSE TO_CHAR(TO_NUMBER(PSWD_CHK)+1) END AS PSWD_CHK 
			                     FROM USRBM.TBRK_USER 
			                    WHERE USER_ID = ? ),
			       LOGIN_DT = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MI')
			WHERE  USER_ID = ?
        ]]>
    </query>
    
    <query id="user_login_pswd_reset_save" desc="로그인 비밀번호 오류 초기화" fetchSize="10">
        <![CDATA[  
			UPDATE USRBM.TBRK_USER 
			SET    PSWD_CHK	= '0',
			       LOGIN_DT = ''
			WHERE  USER_ID = ?
              ]]>
    </query>    
    
    <query id="personal_mn_access_insert" desc="개인정보처리메뉴 접속이력 저장" fetchSize="10">
        <![CDATA[  
			 INSERT  /* personal_mn_access_insert */
			         INTO TBDA_PERSONAL_MN_ACCESS (
			      LOG_SEQ,
			      SEQ_NO,
			      FORM_ID,
			      ACCESS_DT,
			      JOB_TYPE,
			      ACTION,
			      PARAM,
				  USER_IP,
				  USER_ID
			      )
			  VALUES (
			       ?,
			       (SELECT NVL(MAX(SEQ_NO),0)+1 FROM TBDA_PERSONAL_MN_ACCESS WHERE LOG_SEQ = ?),
			       ?,
			       SYSDATE,
			       ?,
			       ?,
			       ?,
			       ?,
			       ?
			      )  
              ]]>
    </query>  
    
</queryMap>
