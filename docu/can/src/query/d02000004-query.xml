<?xml version="1.0" encoding='EUC-KR'?>
<queryMap desc="tbdb_wk_sche_mngr(주간교육일정)">

    <query id="tbdb_wk_sche_fb001" desc="기수 조회" fetchSize="10">
        <![CDATA[
			SELECT CD_NM AS RACER_PERIO_NO
			FROM TBDA_SPEC_CD	
			WHERE GRP_CD = 'A10001'
			ORDER BY CD DESC		
		]]>
    </query>     
    
    <query id="tbdb_wk_sche_fb000" desc="주차 콤보 조회" fetchSize="10">
        <![CDATA[
			SELECT               
					 DISTINCT(WK) AS CD              
					 , WK || '주차' AS CD_NM
			FROM 
					TBDB_WK_ABS
			WHERE
				    RACER_PERIO_NO=NVL(?,RACER_PERIO_NO)		 
			ORDER BY
					WK ASC	          		 		 		 		 	
		]]>
    </query>
    		   
    <query id="tbdb_wk_sche_fb002" desc="년도 조회" fetchSize="10">
        <![CDATA[
			SELECT
					DISTINCT(YY) YY       
			FROM
					TBDB_WK_ABS 
			ORDER BY 
					YY DESC	
        ]]>
    </query>
    
    <query id="tbdb_wk_sche_fb003" desc="강사 조회" fetchSize="10">
        <![CDATA[
			SELECT 
					GUD_LECTR_ID
					,NM_KOR
					,BLNG
			FROM
				    TBDB_GUD_LECTR
			WHERE	
					RACER_PERIO_NO = ?
					AND USE_YN = '001'
			ORDER BY 
					NM_KOR	
			ASC		
		]]>
    </query>
    
    <query id="tbdb_wk_sche_fb004" desc="주차 조회" fetchSize="10">
        <![CDATA[
			SELECT
					  RACER_PERIO_NO   
					 ,YY               
					 ,MM               
					 ,WK               
					 ,STR_DT           
					 ,END_DT           
					 ,'0'       CHK
			FROM
					 TBDB_WK_ABS 
			WHERE
					 RACER_PERIO_NO = ?
			AND
			         TRIM(WK) = NVL(?,TRIM(WK)) 	 	
			ORDER BY	
				  	 TO_NUMBER(TRIM(WK)) 	 		 		          		 		 		 		 	
			
		]]>
    </query>
    
    <query id="tbdb_wk_sche_fb005" desc="종합 교육개요 조회" fetchSize="10">
        <![CDATA[
			SELECT
					  RACER_PERIO_NO
					 ,GBN
					 ,EDU_STR_DT
					 ,EDU_END_DT
					 ,TOT_EDU_TIME
			FROM
					 TBDB_CMPT_EDU_OUTL
			WHERE
					 RACER_PERIO_NO = ?	
			ORDER BY
					 GBN
		]]>
    </query>
    
    <query id="item_code_d02000004" desc="종목코드 조회" fetchSize="10">
        <![CDATA[
			SELECT 
			        TGC.GRP_CD      	-- 그룹코드
			      , TGC.GRP_NM      	-- 그룹명
			      , TSC.CD              -- 코드
			      , TSC.CD_NM       	-- 코드명
			      , TSC.RMK         	-- 비고
			FROM    TBDA_GRP_CD  TGC
			      , TBDA_SPEC_CD TSC
			WHERE TGC.GRP_CD = TSC.GRP_CD
			AND   TSC.DEL_YN = 'N'
			AND   TGC.GRP_CD IN ('D10064','D10030','D10088','D10089','D10090')
        ]]>
    </query>
    
    <query id="tbdb_wk_sche_fb006" desc="종합교육 시간배정표 조회" fetchSize="10">
        <![CDATA[
			SELECT
					 SECTN_CD
					,CRS_CD
					,NO_RACER_TIME
					,RACER_TIME
			FROM
					TBDB_CMPT_EDU_ASSIGN 
			WHERE
					RACER_PERIO_NO = ?
		]]>
    </query>
    
    <query id="tbdb_wk_sche_fb007" desc="교육일지 교육시간 조회" fetchSize="10">
        <![CDATA[
			SELECT
					 DT
					,SECTN_CD
					,EDU_TIME
			FROM
					TBDB_TRNG_DIARY_DETL 
			WHERE
					RACER_PERIO_NO = ?
		]]>
    </query>
    
    <query id="tbdb_wk_sche_fb008" desc="주간교육일정표 조회" fetchSize="10">
        <![CDATA[
			SELECT
					 RACER_PERIO_NO
					 ,YY
					 ,MM
					 ,TRIM(WK) AS WK
					 ,SEQ            
					 ,DT             
					 ,STR_END_TIME   
					 ,SECTN_CD       
					 ,CRS_CD         
					 ,DETL_EDU_CRS   
					 ,OBJ            
					 ,LECTR          
					 ,PLC            
					 ,TIME           
					 ,'0'   CHK
					 ,'0'   COPY
			FROM
					 TBDB_WK_SCHE 
			WHERE
			         RACER_PERIO_NO = ?
			AND
			         TRIM(WK) = NVL(?,TRIM(WK)) 		 		          		 		 		 		 	
			ORDER BY
					 DT,STR_END_TIME 
		]]>
    </query>
    <query id="tbdb_wk_sche_fb009" desc="주간교육일정표 조회" fetchSize="10">
    <![CDATA[
	    	SELECT 
			    GBN
			   ,TOT_TM
			   ,SIL_TM
			   ,LEE_TM
			   ,ETC_TM
			   ,NVL(ISU_TOT_TM,0) AS ISU_TOT_TM
			   ,NVL(ISU_SIL_TM,0) AS ISU_SIL_TM
			   ,NVL(ISU_LEE_TM,0) AS ISU_LEE_TM
			   ,NVL(ISU_ETC_TM,0) AS ISU_ETC_TM
			   ,NVL(ROUND((ISU_TOT_TM/TOT_TM)*100,2),0) AS JINDO1
			   ,NVL(ROUND((ISU_SIL_TM/SIL_TM)*100,2),0) AS JINDO2
			   ,NVL(ROUND((ISU_LEE_TM/LEE_TM)*100,2),0) AS JINDO3
			   ,NVL(ROUND((ISU_ETC_TM/ETC_TM)*100,2),0) AS ETC_JINDO
			   ,EDU_STR_DT
			   ,EDU_END_DT
			FROM(	   
				SELECT DISTINCT 2 AS GBN 
				,(SELECT SUM(EDU_TIME) FROM TBDB_DETL_EDU_ASSIGN WHERE RACER_PERIO_NO = A.RACER_PERIO_NO) AS TOT_TM
				,(SELECT SUM(EDU_TIME) FROM TBDB_DETL_EDU_ASSIGN WHERE RACER_PERIO_NO = A.RACER_PERIO_NO AND  SECTN_CD=002) AS SIL_TM
				,(SELECT SUM(EDU_TIME) FROM TBDB_DETL_EDU_ASSIGN WHERE RACER_PERIO_NO = A.RACER_PERIO_NO AND  SECTN_CD=001) AS LEE_TM
				,(SELECT SUM(EDU_TIME) FROM TBDB_DETL_EDU_ASSIGN WHERE RACER_PERIO_NO = A.RACER_PERIO_NO AND  SECTN_CD NOT IN('001','002')) AS ETC_TM
				,(SELECT SUM(EDU_TIME) FROM TBDB_TRNG_DIARY_DETL WHERE DT <=  ? and RACER_PERIO_NO = A.RACER_PERIO_NO) AS ISU_TOT_TM
				,(SELECT SUM(EDU_TIME) FROM TBDB_TRNG_DIARY_DETL WHERE SECTN_CD = '002' AND DT  <=  ? and RACER_PERIO_NO = A.RACER_PERIO_NO) AS ISU_SIL_TM
				,(SELECT SUM(EDU_TIME) FROM TBDB_TRNG_DIARY_DETL WHERE SECTN_CD = '001'  AND DT  <=  ? and RACER_PERIO_NO = A.RACER_PERIO_NO) AS ISU_LEE_TM
				,(SELECT SUM(EDU_TIME) FROM TBDB_TRNG_DIARY_DETL WHERE SECTN_CD NOT IN('001','002') AND DT  <=  ? and RACER_PERIO_NO = A.RACER_PERIO_NO) AS ISU_ETC_TM
				,(SELECT MIN(DT) FROM TBDB_DETL_EDU_ASSIGN WHERE RACER_PERIO_NO = ?) AS EDU_STR_DT
				,(SELECT MAX(DT) FROM TBDB_DETL_EDU_ASSIGN WHERE RACER_PERIO_NO = ?) AS EDU_END_DT
				FROM  TBDB_DETL_EDU_ASSIGN A
				WHERE RACER_PERIO_NO = ?
				)
			]]>
    </query>
     <query id="tbdb_wk_sche_fb010" desc="주간교육일정표 조회(PRINT)" fetchSize="10">
    <![CDATA[    			
			  SELECT  
					  SUBSTR(DT ,0,4)||'-'||SUBSTR(DT ,5,2)||'-'||SUBSTR(DT ,7,2) AS DT
					 ,SUBSTR(STR_END_TIME ,0,2) ||':'||SUBSTR(STR_END_TIME ,3,2)||' ~ '||
					  SUBSTR(STR_END_TIME ,5,2) ||':'||SUBSTR(STR_END_TIME ,7,2) AS STR_END_TIME
					 ,(SELECT CD_NM  FROM TBDA_SPEC_CD WHERE GRP_CD  ='D10027' AND CD = T1.SECTN_CD  ) AS SECTN_CD 
					 ,(SELECT CD_NM  FROM TBDA_SPEC_CD WHERE GRP_CD  =(
					  CASE WHEN (SELECT CD  FROM TBDA_SPEC_CD WHERE GRP_CD  ='D10027' AND CD = T1.SECTN_CD  ) ='001' THEN 'D10030' 
					  WHEN (SELECT CD  FROM TBDA_SPEC_CD WHERE GRP_CD  ='D10027' AND CD = T1.SECTN_CD  ) ='002' THEN 'D10064' 
					  WHEN (SELECT CD  FROM TBDA_SPEC_CD WHERE GRP_CD  ='D10027' AND CD = T1.SECTN_CD  ) ='003' THEN 'D10028' 
					  WHEN (SELECT CD  FROM TBDA_SPEC_CD WHERE GRP_CD  ='D10027' AND CD = T1.SECTN_CD  ) ='004' THEN 'D10058' 
					  WHEN (SELECT CD  FROM TBDA_SPEC_CD WHERE GRP_CD  ='D10027' AND CD = T1.SECTN_CD  ) ='005' THEN 'D10073'
					  WHEN (SELECT CD  FROM TBDA_SPEC_CD WHERE GRP_CD  ='D10027' AND CD = T1.SECTN_CD  ) ='006' THEN 'D10065' END 
					  )  AND CD = T1.CRS_CD  ) AS CRS_CD 
					 ,DETL_EDU_CRS   
					 ,(SELECT CD_NM  FROM TBDA_SPEC_CD WHERE GRP_CD  ='D10005' AND CD = T1.OBJ  ) AS OBJ
					 ,(SELECT NM_KOR FROM  TBDB_GUD_LECTR WHERE GUD_LECTR_ID = T1.LECTR) AS LECTR 
					 ,(SELECT CD_NM  FROM TBDA_SPEC_CD WHERE GRP_CD  ='D10061' AND CD = T1.PLC  ) AS PLC                            
					 ,TIME           
				FROM
						 TBDB_WK_SCHE T1
				WHERE
				         RACER_PERIO_NO = ?
					AND  TRIM(WK) = ?	 		          		 		 		 		 	
				ORDER BY DT
				]]>
    </query>
    <query id="tbdb_wk_sche_fb011" desc="년월주간순서" fetchSize="10">
    <![CDATA[  
	    SELECT ROWNUM AS NUM,RACER_PERIO_NO,YY,MM,WK
	    ,RACER_PERIO_NO||YY||MM||WK AS SEQ
	     FROM (
		   SELECT *
				FROM
						 TBDB_WK_ABS 
				WHERE 
						 RACER_PERIO_NO = ? 
						 order by yy, mm , wk 
		) 
    ]]>
    </query> 
    <query id="tbdb_wk_sche_fb012" desc="주간교육일정 가져오기" fetchSize="10">
        <![CDATA[
			SELECT  T1.RACER_PERIO_NO
					,T1.YY
					,T1.MM
			       	,T2.WK
			       	,T1.DT             
			       	,T1.STR_END_TIME
			       	,T1.SECTN_CD
			       	,T1.CRS_CD         
			       	,T1.DETL_EDU_CRS
			       	,T1.LECTR
			       	,T1.PLC            
			       	,T1.EDU_TIME TIME
			       	,T1.OBJ
			       	,'0' CHK
					,'0' COPY
			FROM    TBDB_DETL_EDU_ASSIGN T1
					, TBDB_WK_ABS T2
			WHERE   DT >= STR_DT AND DT <= END_DT
			        AND T1.RACER_PERIO_NO = T2.RACER_PERIO_NO
			        AND T2.RACER_PERIO_NO = ?
			        AND T2.WK = ?
			ORDER BY T1.DT, STR_END_TIME
		]]>
    </query> 	
    <query id="tbdb_wk_sche_ib001" desc="주간교육일정표 삽입" fetchSize="10">
        <![CDATA[
			INSERT INTO TBDB_WK_SCHE (
				     RACER_PERIO_NO		        
				    ,WK
				    ,SEQ          
				    ,DT           
				    ,STR_END_TIME 
				    ,SECTN_CD     
				    ,CRS_CD       
				    ,DETL_EDU_CRS 
				    ,OBJ          
				    ,LECTR        
				    ,PLC          
				    ,TIME     
				    ,INST_ID      
				    ,INST_DTM     
			)
			SELECT
					 ?	
					,?
					,NVL(MAX(SEQ), 0) + 1
					,?
					,?
					,?
					,?
					,?
					,?
					,?
					,?
					,?
					,?
					,SYSDATE
			FROM
					TBDB_WK_SCHE
			WHERE
					RACER_PERIO_NO = ?
        ]]>
    </query>
    
    <query id="tbdb_wk_sche_ub001" desc="주간교육일정표 갱신" fetchSize="10">
        <![CDATA[
			UPDATE TBDB_WK_SCHE 
			SET
					 DT				= ?
					,STR_END_TIME	= ?
					,SECTN_CD		= ?
					,CRS_CD			= ?
					,DETL_EDU_CRS	= ?
					,OBJ			= ?
					,LECTR			= ?
					,PLC     		= ?
					,TIME		    = ?
					,UPDT_ID        = ?
					,UPDT_DTM       = SYSDATE
			WHERE	RACER_PERIO_NO	= ?
			AND		SEQ				= ?	
        ]]>
    </query>
    
    <query id="tbdb_wk_sche_db001" desc="주간교육일정표 삭제" fetchSize="10">
        <![CDATA[
			DELETE 
			FROM   	TBDB_WK_SCHE 
			WHERE	RACER_PERIO_NO	= ?
			AND		SEQ				= ?	
        ]]>
    </query>
   
</queryMap>