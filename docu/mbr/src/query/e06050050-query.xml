<?xml version="1.0" encoding='EUC-KR'?>
<queryMap desc="e06050050 출고등록 ">
	<query id="e06050050_s01" desc="출고 리스트 조회 " fetchSize="50">
        <![CDATA[
            -- 출고 리스트 조회
			SELECT  /* e06050050_s01 */
			        IO_DT AS OUT_DT
			       ,GET_SUPP_NM(MIN(SUPP_CD))||DECODE(COUNT(*), 1, '', ' 외 '||TRIM(TO_CHAR(COUNT(*) -1,'999'))||'종 / ') ||SUM(QTY)||'개'AS OUT_CON
			       ,MAX(ACCEPT_ID) AS ACCEPT_NM
				   ,NVL(USRBM.FC_GET_USERNAME(MAX(OUT_ID)),MAX(OUT_ID)) AS OUT_NM
			FROM    TBEF_SUPP_IO
			WHERE   IO_TYPE = '4'
			AND     IO_DT BETWEEN ? AND ?
			GROUP BY IO_DT
			ORDER BY IO_DT DESC            
        ]]>
    </query>         
    <query id="e06050050_s02" desc="출고 상세 내역 조회 " fetchSize="50">
        <![CDATA[
            -- 출고 상세 내역 조회  
			SELECT /* e06050050_s02 */
			        A.IO_DT	AS OUT_DT			-- 출고일자
			       ,A.SUPP_CD					-- 소모품코드
			       ,B.SUPP_NM					-- 소모품명
			       ,A.SEQ						-- 연번
			       ,B.SPEC						-- 사양
			       ,A.QTY AS OUT_QTY			-- 출고수량
			       ,B.DANGA						-- 사양
			       ,A.ACCEPT_ID AS ACCEPT_NM	-- 수령자 이름
			       ,A.RMK						-- 비고
			FROM   TBEF_SUPP_IO A
			      ,TBEF_SUPP_CD B
			WHERE  A.SUPP_CD = B.SUPP_CD
			AND    A.IO_TYPE = '4'
			AND    A.IO_DT   = ?           	-- 출고일자
			ORDER BY A.SUPP_CD
        ]]>
    </query>
    
    <query id="e06050050_s03" desc="재고가 존재하는 소모품 조회 " fetchSize="50">
        <![CDATA[
            -- 재고가 존재하는 소모품 조회(무조건 현시점 기준. 현재년도에 이월이 안되어 있으면 조회 안됨)
			SELECT  A.SUPP_CD
			       ,B.SUPP_NM
			       ,B.SPEC
			       ,A.BALC_QTY
			       ,B.DANGA
			FROM (          
			        SELECT SUPP_CD
			              ,SUM(DECODE(IO_TYPE, '1',QTY, '3',QTY,'4',QTY*-1))  AS BALC_QTY
			        FROM   TBEF_SUPP_IO
			        WHERE  IO_TYPE IN ('1','3','4')
			        AND    IO_DT LIKE TO_CHAR(SYSDATE, 'YYYY')||'%'
			        GROUP BY SUPP_CD
			      ) A
			      , TBEF_SUPP_CD B
			WHERE 1=1
				  AND A.SUPP_CD = B.SUPP_CD
				  AND B.SUPP_NM LIKE '%'||?||'%'
			ORDER BY SUPP_CD
        ]]>
    </query>
        <query id="e06050050_m01" desc="출고 등록/수정  " fetchSize="10">        <![CDATA[        	/* 출고내역 등록 및 수정  */            MERGE /* e06050050_m01 */
                  INTO TBEF_SUPP_IO DST            USING (
            	SELECT 				   ?   AS IO_DT,       	-- 출고일자
	               ?   AS IO_TYPE,		-- 입출구분 				   ?   AS SUPP_CD, 		-- 소모품코드
				   ?   AS SEQ,			-- 연번
				   ?   AS QTY,			-- 출고수량
			       ?   AS AMOUNT,		-- 금액
			       ?   AS ACCEPT_ID, 	-- 수령자
			       ?   AS RMK,
				   ?   AS USER_ID 		-- 작성자 아이디 				FROM DUAL
			) SRC
            ON (    DST.IO_DT   = SRC.IO_DT		-- 출고일자
            	AND DST.IO_TYPE = SRC.IO_TYPE	-- 입출구분
				AND DST.SUPP_CD = SRC.SUPP_CD	-- 소모품코드
				AND DST.SEQ     = SRC.SEQ		-- 연번
			    )
			WHEN MATCHED THEN				UPDATE							 	SET	DST.QTY       = SRC.QTY,			-- 출고수량				    DST.AMOUNT    = SRC.AMOUNT,			-- 출고금액				    DST.ACCEPT_ID = SRC.ACCEPT_ID,		-- 수령자
				    DST.RMK       = SRC.RMK,				-- 비고
				    DST.OUT_ID    = SRC.USER_ID,		-- 출고자
				    DST.UPDT_ID   = SRC.USER_ID,		-- 수정자 ID
				    DST.UPDT_DT   = SYSDATE   			WHEN NOT MATCHED THEN				INSERT (				    IO_DT		               ,IO_TYPE 				   ,SUPP_CD 				   ,SEQ					   ,QTY	
			       ,AMOUNT	
			       ,ACCEPT_ID
			       ,RMK
			       ,OUT_ID
			       ,INST_ID 				   ,INST_DT  				   ) 				VALUES ( 
				    SRC.IO_DT
				   ,SRC.IO_TYPE
				   ,SRC.SUPP_CD
				   ,(SELECT NVL(MAX(SEQ)+1,0)
				     FROM   TBEF_SUPP_IO
				     WHERE  IO_DT   = ?
				     AND    IO_TYPE = ?
				     AND    SUPP_CD = ?)
				   ,SRC.QTY
				   ,SRC.AMOUNT
				   ,SRC.ACCEPT_ID
				   ,SRC.RMK
				   ,SRC.USER_ID				   ,SRC.USER_ID  				   ,SYSDATE)
        ]]>
    </query>
     
    <query id="e06050050_d01" desc="출고내역 삭제  " fetchSize="10">
        <![CDATA[
            DELETE /* e06050050_d01 */
                  FROM TBEF_SUPP_IO 
            WHERE 1=1
            AND   IO_DT   = ?
            AND   IO_TYPE = '4'		--출고
            AND   SUPP_CD = ?
            AND   SEQ     = ?
        ]]>
    </query>
     </queryMap>