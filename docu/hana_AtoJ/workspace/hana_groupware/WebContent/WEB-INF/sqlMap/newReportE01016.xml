<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 
  * @파일명 : newReportE01016.xml
  * @메뉴명 : 원부자재 납부확인서
  * @최초작성일 : 2016/01/25            
  * @author : 전산팀                  
  * @수정내역 :	
-->
<mapper namespace="newReportE01016">
	<!-- 원부자재 납품확인서 -->
	<insert id="insertDelivery" parameterType="com.hanaph.gw.ea.newReport.vo.DeliveryVO" >
		INSERT INTO GW_EA_DELIVERY
        (
        	SEQ, APPROVAL_SEQ, YMD, SLIP_NO, CUST_ID, 
		       CUST_NM,	MATERIAL_ID, MATERIAL_NM, STANDARD, QTY, 
		       UNIT, DANGA,	AMT, BALJU_NO, AMT_SUM, 
		       VAT_SUM ,BIGO ,WAREHOUSINGNO
        )
     	VALUES
     	(
     		SEQ_GW_EA_DELIVERY.nextval, #{approval_seq}, #{ymd}, #{slip_no}, #{cust_id}, 
     		#{cust_nm}, #{material_id}, #{material_nm}, #{standard}, #{qty}, 
     		#{unit}, #{danga}, #{amt}, #{balju_no}, #{amt_sum}, 
     		#{vat_sum}, #{bigo}, #{warehousingno}
        )
	</insert>
	
	<select id="deliveryDetail" parameterType="string" resultType="com.hanaph.gw.ea.newReport.vo.DeliveryVO">
		SELECT SEQ, APPROVAL_SEQ, YMD, SLIP_NO, CUST_ID, 
		       CUST_NM,	MATERIAL_ID, MATERIAL_NM, STANDARD, TO_CHAR(QTY, '999,999,999.00') QTY, 
		       UNIT, TO_CHAR(DANGA, '999,999,999.00') DANGA,	TO_CHAR(AMT, '999,999,999.00') AMT, BALJU_NO, BIGO,
		       TO_CHAR(AMT_SUM, '999,999,999.00') AMT_SUM, TO_CHAR(VAT_SUM, '999,999,999.00') VAT_SUM,
		       TO_CHAR(NVL(AMT_SUM,0)+ NVL(VAT_SUM,0), '999,999,999.00') TOT_SUM, BIGO
		  FROM GW_EA_DELIVERY
		 WHERE APPROVAL_SEQ = #{approval_seq}
	</select>
	
	<delete id="deleteDelivery" parameterType="com.hanaph.gw.ea.newReport.vo.DeliveryVO">
		DELETE FROM GW_EA_DELIVERY WHERE APPROVAL_SEQ = #{approval_seq}
	</delete>
	
	<!--원부자재 납풉확인서 CHOE 20160125 다른 결재 문서와 다른 점 : 1.입고일자로 조회하기  -->
	<select id="searchSlipNo" parameterType="string" resultType="com.hanaph.gw.ea.newReport.vo.DeliveryVO">
		SELECT TO_CHAR(MIN(WRH.WAREHOUSINGDT), 'YYYYMMDD') AS YMD
		,WRH.GROUPWARENO AS SLIP_NO
		,'-' AS SAWON_NM
		FROM ORAGMP.WAREHOUSING WRH
		WHERE TO_CHAR(WRH.WAREHOUSINGDT, 'YYYYMMDD') = REPLACE(#{search_ymd} ,'-','')
		GROUP BY WRH.GROUPWARENO 
        ORDER BY WRH.GROUPWARENO 
	</select>
	
	<!--물품 구입 청구서 CHOE 20151214 다른 결재 문서와 다른 점 : 2.전표번호로 data 조회하기  -->
	<select id="searchSlipData" parameterType="string" resultType="com.hanaph.gw.ea.newReport.vo.DeliveryVO">
		SELECT TO_CHAR(WRH.WAREHOUSINGDT, 'YYYYMMDD') AS YMD  
        ,WRH.GROUPWARENO AS SLIP_NO
        ,WRH.ITEMCODE AS MATERIAL_ID
        ,MATERIAL.ITEMNAME AS MATERIAL_NM
        ,MATERIAL.UNIT AS UNIT
        ,MATERIAL.STANDARDTEXT AS STANDARD                
        ,WRH.CUSTCODE AS CUST_ID
        ,CUST.CUSTNAME AS CUST_NM
        ,TO_CHAR(NVL(WRH.TOTALWAREHOUSINGQTY ,0) , '999,999,999.00') AS QTY
        ,TO_CHAR(NVL(WRH.WAREHOUSINGPRICE ,0), '999,999,999.00') AS DANGA
        ,TO_CHAR(NVL(WRH.WAREHOUSINGAMT ,0), '999,999,999.00') AMT
        ,WRH.ORDERNO AS BALJU_NO
        ,TO_CHAR(NVL(TOT.WAREHOUSINGAMT ,0), '999,999,999.00') AS AMT_SUM
        ,TO_CHAR(NVL(TOT.VAT ,0), '999,999,999.00') AS VAT_SUM 
        ,TO_CHAR(NVL(TOT.WAREHOUSINGAMT ,0) + NVL(TOT.VAT ,0), '999,999,999.00') AS TOT_SUM
        ,WRH.WAREHOUSINGREMARK AS BIGO  
        ,'-ERP' AS SAWON_NM
        ,WRH.WAREHOUSINGNO AS WAREHOUSINGNO      
        FROM ORAGMP.WAREHOUSING WRH
        ,ORAGMP.CMCUSTM CUST 
        ,(        
                SELECT ITEMCODE ,ITEMNAME ,UNIT ,STANDARDTEXT
                ,'01' AS WAREHOUSINGDIV  
                FROM ORAGMP.CMITEMM ITM                 
                UNION
                SELECT ITEMCODE ,ITEMNAME ,PACKINGTYPEDIVNAME AS UNIT ,ITEMUNITNAME AS STANDARDTEXT
                 ,'03' AS WAREHOUSINGDIV
                FROM ORAGMP.NVITEMGPOS                                
        ) MATERIAL 
        ,(        
                SELECT GROUPWARENO
                ,SUM(NVL(WAREHOUSINGAMT ,0)) AS WAREHOUSINGAMT
                ,SUM(NVL(VAT ,0)) AS VAT
                FROM ORAGMP.WAREHOUSING
                WHERE GROUPWARENO IS NOT NULL
                GROUP BY GROUPWARENO                
        ) TOT
        WHERE WRH.GROUPWARENO = #{search_no}
        AND WRH.CUSTCODE = CUST.CUSTCODE(+)
        AND WRH.ITEMCODE = MATERIAL.ITEMCODE(+)
        AND DECODE(WRH.WAREHOUSINGDIV ,'03', '03' ,'01') = MATERIAL.WAREHOUSINGDIV(+)
        AND WRH.GROUPWARENO = TOT.GROUPWARENO(+)
	</select>
</mapper>