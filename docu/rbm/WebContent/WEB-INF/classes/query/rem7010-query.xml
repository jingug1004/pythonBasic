<?xml version="1.0" encoding='EUC-KR'?>

<queryMap desc="rem7010(지정좌석실 좌석현황)">
  
    <query id="rem7010_s01" desc="지정좌석실 좌석현황 조회" fetchSize="10">
      <![CDATA[
            WITH SEAT_NUM AS (	/*rem7010_s01 지정좌석실 좌석현황 조회*/--좌석수
				SELECT BRNC_CD COMM_NO, ENT_FIX_NUM, SEAT_NUM_NORMAL, SEAT_NUM_FIXED, SEAT_NUM_GREEN,
				(SEAT_NUM_NORMAL+SEAT_NUM_FIXED+SEAT_NUM_GREEN) SEAT_NUM_TOT
				FROM TBRA_COMM_DESC
				WHERE 1=1
				AND BRNC_CD NOT IN ('29') --교차제외
				AND STND_YEAR = SUBSTR(?,0,4)
			),
			SALES_FIXED AS (	--지정좌석실 매출액
				SELECT
					RACE_DAY, COMM_NO,
					SUM(DECODE(GRN_ZN_CD,'001',AMT,0)) NORMAL_AMT,
					SUM(DECODE(GRN_ZN_CD,'002',AMT,'003',AMT,0)) FIXED_AMT,
					SUM(DECODE(GRN_ZN_CD,'004',AMT,0)) GREEN_AMT,
					SUM(AMT) AMT_TOTAL
				FROM TBJI_PC_TELMP_FIXEDSEAT
				WHERE 1=1
				AND RACE_DAY BETWEEN ? AND ?
				GROUP BY RACE_DAY, COMM_NO
			)
			
			SELECT
				DECODE(COMM_NO, '98', '09', COMM_NO) ORD_NO,
				COMM_NO,
				FC_CODE_NM('018',COMM_NO) COMM_NM,
				ENT_FIX_NUM,
				(NORMAL_AMT+FIXED_AMT+GREEN_AMT) TOTAL_AMT,
				SEAT_NUM_TOT,
				AMT_TOTAL,
				
				SEAT_NUM_NORMAL,
				DECODE(SEAT_NUM_TOT,0,0,ROUND(SEAT_NUM_NORMAL/SEAT_NUM_TOT*100,2)) SEAT_NUM_NORMAL_RATIO,
				NORMAL_AMT,
				DECODE(AMT_TOTAL,0,0,ROUND(NORMAL_AMT/AMT_TOTAL*100,2)) NORMAL_AMT_RATIO,
			
				SEAT_NUM_FIXED,
				DECODE(SEAT_NUM_TOT,0,0,ROUND(SEAT_NUM_FIXED/SEAT_NUM_TOT*100,2)) SEAT_NUM_FIXED_RATIO,
				FIXED_AMT,
				DECODE(AMT_TOTAL,0,0,ROUND(FIXED_AMT/AMT_TOTAL*100,2)) FIXED_AMT_RATIO,
			
				SEAT_NUM_GREEN,
				DECODE(SEAT_NUM_TOT,0,0,ROUND(SEAT_NUM_GREEN/SEAT_NUM_TOT*100,2)) SEAT_NUM_GREEN_RATIO,
				GREEN_AMT,
				DECODE(AMT_TOTAL,0,0,ROUND(GREEN_AMT/AMT_TOTAL*100,2)) GREEN_AMT_RATIO
			FROM (
				SELECT
					T1.COMM_NO,
					MAX(ENT_FIX_NUM) ENT_FIX_NUM,
					MAX(SEAT_NUM_NORMAL) SEAT_NUM_NORMAL,
					MAX(SEAT_NUM_TOT) SEAT_NUM_TOT,
					MAX(SEAT_NUM_FIXED) SEAT_NUM_FIXED,
					MAX(SEAT_NUM_GREEN) SEAT_NUM_GREEN,
					SUM(NORMAL_AMT) NORMAL_AMT,
					SUM(FIXED_AMT) FIXED_AMT,
					SUM(GREEN_AMT) GREEN_AMT,
					SUM(AMT_TOTAL) AMT_TOTAL
				FROM SEAT_NUM T1, SALES_FIXED T5, VW_SDL_INFO T6
				WHERE 1=1
				AND T6.RACE_DAY = T5.RACE_DAY
				AND T1.COMM_NO = T5.COMM_NO(+)
				AND T6.MEET_CD IN ('001','003')
				AND LENGTH(ROUND(TO_NUMBER(SUBSTR(T6.MEET_CD,3,1))/3,5)) =
					( CASE WHEN ? = '003' THEN 1 --경정
						   WHEN ? = '001' THEN 6 --경륜
						   ELSE LENGTH(ROUND(TO_NUMBER(SUBSTR(T6.MEET_CD,3,1))/3,5)) --전체
						   END
					)
				GROUP BY T1.COMM_NO
			)
			ORDER BY 1

        ]]>
    </query> 
    
</queryMap>