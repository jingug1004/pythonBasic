<?xml version="1.0" encoding='EUC-KR'?>

<queryMap desc="rem3022(경주별 회차별 체류인원)">
    <query id="rem3022_s01" desc="경주별 회차별 체류인원  조회" fetchSize="10">
      <![CDATA[
			WITH STAY_MANA AS( /*rem3022_s01*/
			       SELECT A.MEET_CD
                         ,B.TMS
                         ,RACE_DT
                         ,CASE WHEN RACE_DT >='20130607' AND RACE_DT <='20130714' THEN
                                    DECODE(A.RACE_NO,0,1,A.RACE_NO) + 1
                               ELSE  DECODE(RACE_NO,0,1,A.RACE_NO)
                               END RACE_NO
                         ,BRNC_CD
                         ,ENT_PRSN_NUM 
                         ,LEAV_PRSN_NUM 
                         ,SUM(ENT_PRSN_NUM) OVER (PARTITION BY A.MEET_CD, BRNC_CD, RACE_DT ORDER BY  RACE_NO RANGE UNBOUNDED PRECEDING) -  
                          SUM(LEAV_PRSN_NUM) OVER (PARTITION BY A.MEET_CD, BRNC_CD, RACE_DT ORDER BY  RACE_NO RANGE UNBOUNDED PRECEDING) AS CUM_DIFF
                         ,COUNT(*) OVER (PARTITION BY RACE_DT, BRNC_CD) -1 AS CNT  
	             FROM TBRC_STAY_MANA A
                      ,VW_SDL_INFO B
	             WHERE 1=1
	             AND     A.RACE_DT   = B.RACE_DAY
	             AND     B.MEET_CD IN('001','003')
	             AND     B.MEET_CD   =  ?
	             AND     B.STND_YEAR =  ? 
             )
             SELECT      TMS
                        ,SUM(CUM1) AS CUM1
                        ,SUM(CUM2) AS CUM2
                        ,SUM(CUM3) AS CUM3
                        ,SUM(CUM4) AS CUM4
                        ,SUM(CUM5) AS CUM5
                        ,SUM(CUM6) AS CUM6
                        ,SUM(CUM7) AS CUM7
                        ,SUM(CUM8) AS CUM8
                        ,SUM(CUM9) AS CUM9
                        ,SUM(CUM10) AS CUM10
                        ,SUM(CUM11) AS CUM11
                        ,SUM(CUM12) AS CUM12
                        ,SUM(CUM13) AS CUM13
                        ,SUM(CUM14) AS CUM14
                        ,SUM(CUM15) AS CUM15
                        ,SUM(CUM16) AS CUM16
                        ,SUM(CUM17) AS CUM17
                        ,SUM(CUM18) AS CUM18                        
                        ,ROUND(SUM(CUM)/CNT) AS CUM_AVG
            FROM (            
                         SELECT TMS  
                                    ,CASE WHEN RACE_NO = 1 THEN CUM_DIFF END CUM1  
                                    ,CASE WHEN RACE_NO = 2 THEN CUM_DIFF END CUM2  
                                    ,CASE WHEN RACE_NO = 3 THEN CUM_DIFF END CUM3
                                    ,CASE WHEN RACE_NO = 4 THEN CUM_DIFF END CUM4
                                    ,CASE WHEN RACE_NO = 5 THEN CUM_DIFF END CUM5
                                    ,CASE WHEN RACE_NO = 6 THEN CUM_DIFF END CUM6
                                    ,CASE WHEN RACE_NO = 7 THEN CUM_DIFF END CUM7
                                    ,CASE WHEN RACE_NO = 8 THEN CUM_DIFF END CUM8
                                    ,CASE WHEN RACE_NO = 9 THEN CUM_DIFF END CUM9
                                    ,CASE WHEN RACE_NO = 10 THEN CUM_DIFF END CUM10
                                    ,CASE WHEN RACE_NO = 11 THEN CUM_DIFF END CUM11
                                    ,CASE WHEN RACE_NO = 12 THEN CUM_DIFF END CUM12
                                    ,CASE WHEN RACE_NO = 13 THEN CUM_DIFF END CUM13
                                    ,CASE WHEN RACE_NO = 14 THEN CUM_DIFF END CUM14
                                    ,CASE WHEN RACE_NO = 15 THEN CUM_DIFF END CUM15
                                    ,CASE WHEN RACE_NO = 16 THEN CUM_DIFF END CUM16
                                    ,CASE WHEN RACE_NO = 17 THEN CUM_DIFF END CUM17
                                    ,CASE WHEN RACE_NO = 18 THEN CUM_DIFF END CUM18
                                    ,CUM_DIFF AS CUM
                                    ,CNT
                         FROM STAY_MANA
                         WHERE BRNC_CD LIKE  ?||'%'
                )
            GROUP BY TMS, CNT          
            ORDER BY 1
         ]]>
    </query> 
   
   <query id="rem3022_s02" desc="체류인원  경주별 현황  조회" fetchSize="10">
      <![CDATA[
			SELECT /*rem3022_s02*/
			       MEET_CD
			      ,STND_YEAR
			      ,TMS
			      ,DAY_ORD
			      ,RACE_DAY
			FROM VW_SDL_INFO
			WHERE MEET_CD IN ('001','003')
			AND RACE_DAY = ?
        ]]>
    </query> 
   
</queryMap>