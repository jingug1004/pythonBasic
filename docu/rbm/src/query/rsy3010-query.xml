<?xml version="1.0" encoding='EUC-KR'?>

<queryMap desc="rsy3010(특별관리자 관리)">

    <query id="rsy3010_s01" desc="메뉴사용자조회" fetchSize="10">

        <![CDATA[

            SELECT  /*rsy3010_s01*/
                    A.USER_ID       -- 사용자ID     
                    , USER_NM       -- 사용자명         
                    , PSWD          -- 비밀번호
                    , DEPT_CD       -- 부서코드
                    , DEPT_NM       -- 부서이름
                    , TEAM_CD       -- 팀코드
                    , TEAM_NM       -- 팀이름
                    , ASSO_CD       -- 대분류코드
                    , ASSO_NM       -- 대분류명
                    , FLOC          -- 직위코드
                    , FGRADE        -- 직위         
                    , TEL_NO        -- 전화번호         
                    , EMAIL         -- 이메일       
                    , '0' AS CHK
                    , DECODE(?, NULL, DECODE(B.USER_ID, NULL, 'N', 'Y'), 
                                              DECODE(C.USER_ID, NULL, DECODE(B.USER_ID, NULL, 'N', 'Y'), 
                                                                      'M')) AS ISAUTH
              FROM  TBRK_USER A, (SELECT DISTINCT(USER_ID) FROM TBRK_ADMIN_INFO) B,
                    (SELECT DISTINCT(USER_ID) FROM TBRK_ADMIN_INFO WHERE MN_ID LIKE '%'|| ? ||'%') C
             WHERE  A.DEPT_CD LIKE '%'||'GA12'||'%'
               AND  A.USER_NM LIKE NVL('%'|| ? ||'%', A.USER_NM)
               AND  A.TEAM_CD LIKE NVL('%'|| ? ||'%', A.TEAM_CD)
               AND  B.USER_ID (+)= A.USER_ID
               AND  C.USER_ID (+)= A.USER_ID
          ORDER BY A.ORD_NO, A.TEAM_CD, A.FGRADE, A.USER_ID

        ]]>

    </query>       


    <query id="rsy3010_s02" desc="메뉴권한리스트조회" fetchSize="10">

        <![CDATA[

            SELECT  A.USER_ID  /*rsy3010_s02*/
                    , DECODE(B.LVL, '2', B.UP_MN_ID, B.UPUP_MN_ID) UPUP_MN_ID
                    , DECODE(B.LVL, '2', B.UPMNNM, B.UPUPMN_NM) UPUPMN_NM
                    , B.UP_MN_ID
                    , B.UPMNNM
                    , B.MN_ID
                    , B.MN_NM
                    , DECODE(NVL(A.USER_ID,''),'','0','1') CHK
                    , B.LVL 
                    , B.ORD_NO
                    , B.MN_LEVEL
                    , A.INST_ID
                    , A.INST_DT
                    , A.UPDT_ID
                    , A.UPDT_DT        
                
              FROM  (SELECT USER_ID    
                            , MN_ID    
                            , INST_ID    
                            , INST_DT    
                            , UPDT_ID    
                            , UPDT_DT    
                       FROM TBRK_ADMIN_INFO
                      WHERE USER_ID = ?
                    ) A
                    
                    ,(SELECT A.MN_ID
                            , A.MN_NM
                            , A.UP_MN_ID
                            , C.MN_NM UPMNNM
                            , D.MN_ID UPUP_MN_ID
                            , D.MN_NM UPUPMN_NM
                            , A.LVL 
                            , A.ORD_NO
                            , A.MN_LEVEL 
                            , ROWNUM AS SEQ           
                      FROM  (SELECT MN_ID
                                    , MN_NM
                                    , UP_MN_ID
                                    , ORD_NO
                                    , MN_LEVEL
                                    , URL
                                    , LEVEL - 1 AS LVL       
                    
                               FROM TBRK_MN        
                               START WITH MN_ID = 'R000000'
                               CONNECT BY PRIOR  MN_ID =  UP_MN_ID
                               ORDER SIBLINGS BY UP_MN_ID, ORD_NO, TO_NUMBER(MN_LEVEL)
                             ) A
                             , TBRK_MN B, TBRK_MN C, TBRK_MN D
                    
                     WHERE A.MN_ID    = B.MN_ID
                       AND A.UP_MN_ID = C.MN_ID
                       AND C.UP_MN_ID = D.MN_ID
                       AND A.URL IS NOT NULL
                    
                   ORDER BY A.ORD_NO, TO_NUMBER(A.MN_LEVEL) ASC
                   ) B
            
             WHERE A.MN_ID(+) = B.MN_ID 
             ORDER BY B.ORD_NO, B.SEQ

        ]]>

    </query> 
    

    <query id="rsy3010_i01" desc="메뉴권한입력" fetchSize="10">

        <![CDATA[

            INSERT INTO TBRK_ADMIN_INFO (   /*rsy3010_i01*/
                  USER_ID               -- 사용자 ID
                , MN_ID                 -- 메뉴 ID
                , INST_ID               -- 작성자
                , INST_DT               -- 작성일시
                
            ) VALUES (
                  ?                             -- USER_ID
                , ?                             -- MN_ID           
                , ?                             -- INST_ID
                , SYSDATE                       -- INST_DT
            )

        ]]>

    </query> 
    
    <query id="rsy3010_i02" desc="권한 추가" fetchSize="10">
        <![CDATA[
			INSERT /* rsy3010_i02 */
			       INTO TBRK_MN_AUTH_HIST (
			      USER_ID
			    , MN_ID
			    , STR_DT_TM
			    , END_DT_TM
			    , SRCH_YN
			    , INPT_YN
			    , APRO_YN
			    , RMK
			    , INST_ID
			    , INST_DT
			) VALUES (
			      ?                 -- USER_ID
			    , ?                 -- MN_ID
			    , ? 				-- 작업기준일시
			    , '299912312359'
			    , ?                 -- SRCH_YN
			    , ?                 -- INPT_YN
			    , ?                 -- APRO_YN
			    , ?                 -- RMK
			    , ?                 -- INST_ID			    
			    , SYSDATE           -- INST_DT
			)
        ]]>
    </query> 
    
    <query id="rsy3010_m01" desc="메뉴권한 입력" fetchSize="10">

        <![CDATA[            
             MERGE INTO TBRK_ADMIN_INFO A  --메뉴권한  관리 /* rsy3010_m01 */
             USING   
                     (SELECT                     
	                      ? AS USER_ID                       -- 사용자ID
		                , ? AS MN_ID                  	 -- 메뉴ID
		                , ? AS INST_ID                    -- 작성자		                                       
                     FROM    DUAL ) B                   
             ON (    
                         A.USER_ID = B.USER_ID   
                     AND A.MN_ID   = B.MN_ID
             )                        
             WHEN NOT MATCHED THEN                 
                 INSERT (
                          A.USER_ID                       -- 사용자ID
		                , A.MN_ID                      -- 메뉴ID
		                , A.INST_ID                       -- 작성자
		                , A.INST_DT                       -- 작성일시
                 ) VALUES (                 
                          B.USER_ID                       -- 사용자ID
                        , B.MN_ID                      -- 메뉴ID
                        , B.INST_ID                       -- 작성자
                        , SYSDATE                       -- 작성일시
                 )
        ]]>

    </query>     
    <query id="rsy3010_m02" desc="권한적용부서 입력" fetchSize="10">

        <![CDATA[            
             MERGE INTO TBRK_AUTH_APLY_DEPT A  --권한적용부서  관리 /* rsy3010_m02 */
             USING   
                     (SELECT                     
	                      USER_ID                       -- 사용자ID
		                , ? AS AUTH_GBN                   -- 권한구분
		                , ASSO_CD                       -- 대분류코드              
		                , DEPT_CD                       -- 부서코드             
		                , TEAM_CD                       -- 팀코드
		                , ? AS INST_ID                    -- 작성자
		                                       
                     FROM    TBRK_USER 
                     WHERE USER_ID   = ? ) B  
                 
             ON (    
                     A.USER_ID = B.USER_ID   
                     AND A.AUTH_GBN   = B.AUTH_GBN
             )           
             
             WHEN MATCHED THEN
                 UPDATE SET

                     A.ASSO_CD          = B.ASSO_CD            --대분류코드
                    ,A.DEPT_CD          = B.DEPT_CD            --부서코드
                    ,A.TEAM_CD          = B.TEAM_CD            --팀코드

             WHEN NOT MATCHED THEN 
                 
                 INSERT (
                 
		                  A.USER_ID                       -- 사용자ID
		                , A.AUTH_GBN                      -- 권한구분
		                , A.ASSO_CD                       -- 대분류코드              
		                , A.DEPT_CD                       -- 부서코드             
		                , A.TEAM_CD                       -- 팀코드
		                , A.INST_ID                       -- 작성자
		                , A.INST_DT                       -- 작성일시
                 ) VALUES (
                 
                          B.USER_ID                       -- 사용자ID
                        , B.AUTH_GBN                      -- 권한구분
                        , B.ASSO_CD                       -- 대분류코드              
                        , B.DEPT_CD                       -- 부서코드             
                        , B.TEAM_CD                       -- 팀코드
                        , B.INST_ID                       -- 작성자
                        , SYSDATE                       -- 작성일시
                 )

        ]]>

    </query>      


    <query id="rsy3010_d01" desc="메뉴권한삭제" fetchSize="10">

        <![CDATA[

            DELETE  FROM TBRK_ADMIN_INFO /*rsy3010_d01*/
                    WHERE USER_ID = ? 
                      AND MN_ID   = ?                   

        ]]>

    </query>    
    
    <query id="rsy3010_d02" desc="권한부서삭제" fetchSize="10">

        <![CDATA[

			DELETE FROM TBRK_AUTH_APLY_DEPT A /*rsy3010_d02*/
			WHERE USER_ID = ?
			  AND AUTH_GBN = ?
			  AND NOT EXISTS (SELECT 1 
			               FROM TBRK_ADMIN_INFO
			               WHERE USER_ID = A.USER_ID)                  

        ]]>

    </query>  
    
    <query id="rsy3010_d03" desc="권한부서삭제" fetchSize="10">

        <![CDATA[

            DELETE FROM TBRK_AUTH_APLY_DEPT A  /*rsy3010_d03*/
            WHERE USER_ID = ?
              AND AUTH_GBN = ?
              AND NOT EXISTS (SELECT 1 
                           FROM TBRK_MN_AUTH
                           WHERE USER_ID = A.USER_ID)                  

        ]]>

    </query>
    
    
    <query id="rsy3010_s04" desc="메뉴권한유무" fetchSize="10">

        <![CDATA[

            SELECT * FROM TBRK_ADMIN_INFO  /*rsy3010_s04*/
                    WHERE USER_ID = ? 
                      AND MN_ID   = ?                   

        ]]>

    </query>
    
    <query id="rsy3010_s05" desc="관리자메뉴건수" fetchSize="10">

        <![CDATA[

            SELECT * FROM TBRK_ADMIN_INFO /*rsy3010_s05*/
                    WHERE USER_ID = ?               

        ]]>

    </query>
  
  <query id="rsy3010_d06" desc="관리자메뉴권한전체삭제" fetchSize="10">

        <![CDATA[

            DELETE  FROM TBRK_ADMIN_INFO
                    WHERE USER_ID = ?                   

        ]]>

    </query>        
    

</queryMap>