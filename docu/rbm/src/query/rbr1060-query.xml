<?xml version="1.0" encoding='EUC-KR'?>

<queryMap desc="rbr1060(경주개최 준비상황 관리 )">
   <query id="rbr1060_s01" desc="경주개최 준비인원 조회" fetchSize="10">
      <![CDATA[
                SELECT /* rbr1060_s01 */
                       ?  AS RACE_DAY                	-- 경주일자
                       ,B.CD AS DEPT_SEQ                      	-- 부서연번
                       ,B.CD_NM AS DEPT_NM                    	-- 부서명
                       ,NVL(WRKG_NUM,0) AS WRKG_NUM           	-- 출근인원
                       ,NVL(DUTY_OFF_NUM,0) AS DUTY_OFF_NUM   	-- 휴가인원
                       ,B.ORD_NO								-- 조회순서
                FROM   TBRA_RPT_PREP_SITU A
                      ,TBRK_SPEC_CD B
             WHERE     B.GRP_CD = '168'
             AND       A.COMM_NO(+) = B.CD
             AND       A.RACE_DAY(+) = ?
             AND       B.CD_TERM1 = ?
             UNION ALL
             SELECT     RACE_DAY
                       ,'999' AS DEPT_SEQ
                       ,TO_CHAR(COUNT(*))||'개 지점' AS DEPT_NM
                       ,SUM (WRKG_NUM) AS WRKG_NUM
                       ,SUM (DUTY_OFF_NUM) AS DUTY_OFF_NUM
                       ,999 AS ORD_NO
             FROM       TBRA_RPT_PREP_SITU
             WHERE      COMM_NO > '10' 
             AND        RACE_DAY = ?
             GROUP BY RACE_DAY
             ORDER BY 2
        ]]>
     </query>
    
   <query id="rbr1060_s02" desc="경주개최 준비상황 조회" fetchSize="10">
      <![CDATA[
              SELECT   /* rbr1060_s02 */
                        A.RACE_DAY                  --경주일자
				       ,B.COMM_NO                   --지점코드
				       ,B.WRKG_NUM                  --출근인원
				       ,B.DUTY_OFF_NUM              --휴가인원
				       ,B.NUM_CHK_RSLT              --인원점검 결과
				       ,B.CHK_POINT                 --점검사항
				       ,(SELECT MAX(CHK_POINT_RSLT)
				         FROM   TBRA_RPT_PREP_SITU
				         WHERE  RACE_DAY = A.RACE_DAY
				         ) AS CHK_POINT_RSLT      --점검결과
				       ,B.SIGNFT_POINT              --특이사항
				       ,B.STAT                      --처리상태
				 FROM  (SELECT ? AS RACE_DAY
				        FROM   DUAL) A,
				       TBRA_RPT_PREP_SITU B
				 WHERE A.RACE_DAY = B.RACE_DAY(+)
				 AND   B.COMM_NO(+)  = ?            
        ]]>
     </query>
    
   <query id="rbr1060_s03" desc="지점 특이사항 조회" fetchSize="10">
      <![CDATA[
			SELECT  /* rbr1060_s03 */
                    ?  AS RACE_DAY           	--경주일자
                   ,B.CD COMM_NO             	--지점코드
                   ,B.CD_NM AS COMM_NM			--지점명
                   ,SIGNFT_POINT             	--특이사항
                   ,CHK_POINT_RSLT				--이상유무
                   ,B.GRP_CD
                   ,B.ORD_NO
            FROM    TBRA_RPT_PREP_SITU A 
                   ,TBRK_SPEC_CD B
            WHERE   B.CD       = A.COMM_NO
            AND     B.GRP_CD   = '060'
            AND     B.CD BETWEEN '11' AND '30'
            AND     A.STAT    >= '001'
            AND     A.SIGNFT_POINT IS NOT NULL
            AND     A.RACE_DAY = ?
            UNION ALL
            SELECT  /* rbr1060_s03 */
                    ?  AS RACE_DAY           	--경주일자
                   ,B.CD COMM_NO             	--지점코드
                   ,B.CD_NM AS COMM_NM			--지점명
                   ,SIGNFT_POINT             	--특이사항
                   ,CHK_POINT_RSLT				--이상유무
                   ,B.GRP_CD
                   ,B.ORD_NO
            FROM    TBRA_RPT_PREP_SITU A 
                   ,TBRK_SPEC_CD B
            WHERE   B.CD       = A.COMM_NO
            AND     B.GRP_CD   = '168'
            AND     A.STAT    >= '001'
            AND     A.SIGNFT_POINT IS NOT NULL
            AND     A.RACE_DAY = ?
            ORDER BY 6 DESC, 7      
        ]]>
     </query>
    
     <query id="rbr1060_u01" desc="경주개최 준비상황 수정" fetchSize="10">
      <![CDATA[
               UPDATE  /* rbr1060_u01 */
                       TBRA_RPT_PREP_SITU
			   SET     STAT           = ?           --처리상태
			          ,UPDT_ID        = ?
			          ,UPDT_DT        = SYSDATE
				 WHERE RACE_DAY = ?
				 AND   COMM_NO  = '00'           
        ]]>
    </query>
      
     <query id="rbr1060_m01" desc="경주개최 준비인원 저장" fetchSize="10">
      <![CDATA[
               MERGE  /* rbr1050_m01 */
                      INTO TBRA_RPT_PREP_SITU_NUM DST
               USING (
                      SELECT  ? RACE_DAY                  --경주일자
                             ,? DEPT_SEQ                  --부서코드
                             ,? DEPT_NM                   --부서명
                             ,? WRKG_NUM                  --출근인원
                             ,? DUTY_OFF_NUM              --휴가인원
                             ,? AS USER_ID
                      FROM   DUAL       
                      ) SRC
                   ON (
                            DST.RACE_DAY = SRC.RACE_DAY
                        AND DST.DEPT_SEQ = SRC.DEPT_SEQ    
                      )
                   WHEN MATCHED THEN
                       UPDATE SET
                            DST.WRKG_NUM       = SRC.WRKG_NUM
                           ,DST.DUTY_OFF_NUM   = SRC.DUTY_OFF_NUM
                           ,DST.UPDT_ID        = SRC.USER_ID
                           ,DST.UPDT_DT        = SYSDATE
                   WHEN NOT MATCHED THEN
                       INSERT (
                                RACE_DAY                  --경주일자
                               ,DEPT_SEQ                  --부서코드
                               ,DEPT_NM                   --부서명
                               ,WRKG_NUM                  --출근인원
                               ,DUTY_OFF_NUM              --휴가인원
                               ,INST_ID                   --입력자 사번
                               ,INST_DT                   --입력일시
                               ) VALUES (
                                SRC.RACE_DAY
                               ,SRC.DEPT_SEQ
                               ,SRC.DEPT_NM
                               ,SRC.WRKG_NUM
                               ,SRC.DUTY_OFF_NUM
                               ,SRC.USER_ID
                               ,SYSDATE
                               )       
        ]]>
    </query>
       
</queryMap>