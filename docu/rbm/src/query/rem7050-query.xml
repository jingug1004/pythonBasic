<?xml version="1.0" encoding='EUC-KR'?>

<queryMap desc="rem7050 매출현황(그린카드)">
  
    <query id="rem7050_s01" desc="지정좌석실 매출현황(그린카드)" fetchSize="10">
      <![CDATA[
            WITH SEAT_NUM AS (	/* rem7050_s01*/--좌석수
				SELECT BRNC_CD COMM_NO, SEAT_NUM_NORMAL, SEAT_NUM_FIXED, SEAT_NUM_GREEN
				FROM TBRA_COMM_DESC
				WHERE 1=1
				AND BRNC_CD NOT IN ('29') --교차제외
				AND STND_YEAR = SUBSTR(?,0,4)
			),
			WIN_NUM AS (	--발매기수
				SELECT
					COMM_NO, COUNT(DISTINCT WIN_NO) WIN_CNT
				FROM TBJI_PC_TELMP_FIXEDSEAT
				WHERE 1=1
				AND RACE_DAY BETWEEN ? AND ?
				AND GRN_ZN_CD IN ('002','003')
				AND WIN_TYPE = '14'
				GROUP BY COMM_NO
				ORDER BY COMM_NO
			),
			SALES_FIXED AS (	--지정좌석실 매출액
				SELECT
					RACE_DAY, COMM_NO, WIN_NO,
					AMT GREEN_AMT_FIXED,
					NUM GREEN_NUM_FIXED
				FROM TBJI_PC_TELMP_FIXEDSEAT
				WHERE 1=1
				AND RACE_DAY BETWEEN ? AND ?
				AND GRN_ZN_CD IN ('002','003')
				AND WIN_TYPE = '14'
			)
			
			SELECT
				DECODE(COMM_NO, '98', '09', COMM_NO) ORD_NO,
				COMM_NO,
				FC_CODE_NM('018',COMM_NO) COMM_NM,
				MAX(WIN_CNT) WIN_CNT,
				SUM(GREEN_AMT_FIXED) GREEN_AMT_FIXED, 	--총매출액
			    ROUND(SUM(GREEN_AMT_FIXED)/MAX(WIN_CNT),0) AMT_PER_WIN,	--발매기당 매출액
				SUM(CASE WHEN GREEN_AMT_AVG <= 99900 THEN 1 ELSE 0 END) NUM_01, --99,900원이하
				SUM(CASE WHEN GREEN_AMT_AVG >= 100000 AND GREEN_AMT_AVG <= 299900 THEN 1 ELSE 0 END) NUM_02, --100,000~299,900
				SUM(CASE WHEN GREEN_AMT_AVG >= 300000 AND GREEN_AMT_AVG <= 499900 THEN 1 ELSE 0 END) NUM_03, --300,000~499,900
				SUM(CASE WHEN GREEN_AMT_AVG >= 500000 AND GREEN_AMT_AVG <= 699900 THEN 1 ELSE 0 END) NUM_04, --500,000~699,900
				SUM(CASE WHEN GREEN_AMT_AVG >= 700000 AND GREEN_AMT_AVG <= 999900 THEN 1 ELSE 0 END) NUM_05, --700,000~999,900
				SUM(CASE WHEN GREEN_AMT_AVG >= 1000000 THEN 1 ELSE 0 END) NUM_06 --100,000원이상
			
			FROM (
				SELECT
					T1.COMM_NO,
					T5.WIN_NO,
					MAX(T2.WIN_CNT) WIN_CNT,
					SUM(GREEN_AMT_FIXED) GREEN_AMT_FIXED,
					SUM(GREEN_NUM_FIXED) GREEN_NUM_FIXED,
					ROUND(SUM(GREEN_AMT_FIXED)/COUNT(T6.RACE_DAY),2) GREEN_AMT_AVG
				FROM SEAT_NUM T1, WIN_NUM T2, SALES_FIXED T5, VW_SDL_INFO T6
				WHERE 1=1
				AND T6.RACE_DAY = T5.RACE_DAY
				AND T1.COMM_NO = T2.COMM_NO(+)
				AND T1.COMM_NO = T5.COMM_NO(+)
				AND T6.MEET_CD IN ('001','003')
				AND LENGTH(ROUND(TO_NUMBER(SUBSTR(T6.MEET_CD,3,1))/3,5)) =
					( CASE WHEN ? = '003' THEN 1 --경정
						   WHEN ? = '001' THEN 6 --경륜
						   ELSE LENGTH(ROUND(TO_NUMBER(SUBSTR(T6.MEET_CD,3,1))/3,5)) --전체
						   END
					)
				GROUP BY T1.COMM_NO, T5.WIN_NO
			)
			GROUP BY COMM_NO
			ORDER BY 1
        ]]>
    </query> 
    
</queryMap>