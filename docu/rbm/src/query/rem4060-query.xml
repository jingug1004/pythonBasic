<?xml version="1.0" encoding='EUC-KR'?>

<queryMap desc="rem4060(이벤트 추첨처리 )">
  
    <query id="rem4060_s01" desc="당일 입장 카드 조회" fetchSize="10">
      <![CDATA[
            SELECT /* rem4060_s01 */
			       CARD_ID, 
			       COMM_NO,
			       TRADE_DATE,
			       CARD_USER_TYPE,
			       WIN_FLAG
			FROM   TBRC_T_TRADE_EVENT
			WHERE  TRADE_DATE LIKE ?||'%'
			  --AND  WIN_FLAG = 'Y'
			ORDER BY CARD_ID
        ]]>
    </query> 
    
    <query id="rem4060_s02" desc="당일 입장 카드 자리수 조회" fetchSize="10">
      <![CDATA[
            WITH   /* rem4060_s02 */
                   EVENT_POOL AS (
                   SELECT *
                   FROM TBRC_T_TRADE_EVENT
                   WHERE TRADE_DATE LIKE ?||'%' )
			SELECT '0' AS NPOS, SUBSTR(CARD_ID,1,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,1,1)
			UNION ALL
			SELECT '1' AS NPOS, SUBSTR(CARD_ID,2,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,2,1)
			UNION ALL
			SELECT '2' AS NPOS, SUBSTR(CARD_ID,3,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,3,1)
			UNION ALL
			SELECT '3' AS NPOS, SUBSTR(CARD_ID,4,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,4,1)
			UNION ALL
			SELECT '4' AS NPOS, SUBSTR(CARD_ID,5,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,5,1)
			UNION ALL
			SELECT '5' AS NPOS, SUBSTR(CARD_ID,6,1) AS NVAL
			FROM TBRC_T_TRADE_EVENT
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,6,1)
			UNION ALL
			SELECT '6' AS NPOS, SUBSTR(CARD_ID,7,1) AS NVAL
			FROM TBRC_T_TRADE_EVENT
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,7,1)
			UNION ALL
			SELECT '7' AS NPOS, SUBSTR(CARD_ID,8,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,8,1)
			UNION ALL
			SELECT '8' AS NPOS, SUBSTR(CARD_ID,9,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,9,1)
			UNION ALL
			SELECT '9' AS NPOS, SUBSTR(CARD_ID,10,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,10,1)
			UNION ALL
			SELECT '10' AS NPOS, SUBSTR(CARD_ID,11,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,11,1)
			UNION ALL
			SELECT '11' AS NPOS, SUBSTR(CARD_ID,12,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,12,1)
			UNION ALL
			SELECT '12' AS NPOS, SUBSTR(CARD_ID,13,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,13,1)
			UNION ALL
			SELECT '13' AS NPOS, SUBSTR(CARD_ID,14,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,14,1)
			UNION ALL
			SELECT '14' AS NPOS, SUBSTR(CARD_ID,15,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,15,1)
			UNION ALL
			SELECT '15' AS NPOS, SUBSTR(CARD_ID,16,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,16,1)
			UNION ALL
			SELECT '16' AS NPOS, SUBSTR(CARD_ID,17,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,17,1)     
			UNION ALL
			SELECT '17' AS NPOS, SUBSTR(CARD_ID,18,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,18,1)
			UNION ALL
			SELECT '18' AS NPOS, SUBSTR(CARD_ID,19,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,19,1)
			UNION ALL
			SELECT '19' AS NPOS, SUBSTR(CARD_ID,20,1) AS NVAL
			FROM  EVENT_POOL
			WHERE WIN_FLAG = 'Y'
			GROUP BY SUBSTR(CARD_ID,20,1)    
			ORDER BY 1,2
        ]]>
    </query> 
    
    <query id="rem4060_i01" desc="당일 입장 카드내역 입력" fetchSize="10">
      <![CDATA[
            INSERT /* rem4060_i01 */
			       INTO TBRC_T_TRADE_EVENT (
			       TRADE_DATE, CARD_ID, COMM_NO, CARD_USER_TYPE, WIN_FLAG
			       )
            SELECT MIN(TRADE_DATE) AS TRADE_DATE,
			       CARD_ID, 
			       MIN(COMM_NO) AS COMM_NO,
			       MIN(CARD_USER_TYPE) AS CARD_USER_TYPE,
			       'Y' AS WIN_FLAG
			FROM             
			      (
			            SELECT TRADE_DATE         -- 무임대체: 전체인원(중복포함)
			                       ,COMM_NO
			                       ,'1' AS CARD_USER_TYPE
			                       ,0 AS FEE                                       
			                       ,KSPO_DECRYPT(CARD_ID) AS CARD_ID         
			            FROM TBRC_T_TRADE
			            WHERE 1=1
			            AND    CARD_USER_TYPE = '1'
			            AND    TRADE_DATE LIKE ?||'%'
			            UNION ALL                            
			            SELECT TRADE_DATE         -- 일반: 입장료발생인원(중복포함)
			                       ,COMM_NO
			                       ,'4' AS CARD_USER_TYPE
			                       ,REQUEST_FEE AS FEE               
			                       ,KSPO_DECRYPT(CARD_ID) AS CARD_ID
			            FROM TBRC_T_TRADE
			            WHERE 1=1
			            AND    REQUEST_FEE > 0
			            AND    TRADE_DATE LIKE ?||'%'        
			            UNION ALL                         
			            SELECT MIN(TRADE_DATE)         -- 무임카드 : 중복제거인원
			                       ,COMM_NO
			                       ,'5' AS CARD_USER_TYPE
			                       ,0 AS FEE               
			                       ,KSPO_DECRYPT(CARD_ID) AS CARD_ID
			            FROM TBRC_T_TRADE
			            WHERE 1=1
			            AND    CARD_USER_TYPE = '5'
			            AND    TRADE_DATE LIKE ?||'%'
			            GROUP BY COMM_NO, CARD_ID
			      )
			GROUP BY CARD_ID
			ORDER BY CARD_ID
        ]]>
    </query> 
    
    <query id="rem4060_u01" desc="미당첨번호로 처리" fetchSize="10">
      <![CDATA[
            UPDATE /* rem4060_u01 */
			       TBRC_T_TRADE_EVENT
			   SET WIN_FLAG = 'N'
			WHERE  WIN_FLAG = 'Y'
			   AND SUBSTR(CARD_ID, ? + 1, 1) <> ?   
			   AND TRADE_DATE LIKE ?||'%'    
        ]]>
    </query>  
       
    <query id="rem4060_u02" desc="당첨 대상으로 수정" fetchSize="10">
      <![CDATA[
            UPDATE /* rem4060_u02 */
			       TBRC_T_TRADE_EVENT
			   SET WIN_FLAG = 'Y'
			WHERE  WIN_FLAG = 'N'   
			   AND TRADE_DATE LIKE ?||'%'    
        ]]>
    </query>  
       
       
    <query id="rem4060_u03" desc="최종 당첨번호가 아닌 것은 비대상으로 저장" fetchSize="10">
      <![CDATA[
            UPDATE /* rem4060_u03 */
			       TBRC_T_TRADE_EVENT
			   SET WIN_FLAG = 'N'
			WHERE  WIN_FLAG = 'Y'
			   AND TRADE_DATE LIKE ?||'%'  
			   AND CARD_ID NOT LIKE '%'|| ? 
        ]]>
    </query>  
       
    <query id="rem4060_u04" desc="최종 당첨번호를 저장" fetchSize="10">
      <![CDATA[
            UPDATE /* rem4060_u04 */
			       TBRC_T_TRADE_EVENT
			   SET WIN_FLAG = 'Y'
			WHERE  WIN_FLAG = 'Y'
			   AND TRADE_DATE LIKE ?||'%'   
			   AND CARD_ID LIKE '%'|| ?
        ]]>
    </query>  
       
       
    <query id="rem4060_d01" desc="당일 입장 카드내역 삭제" fetchSize="10">
      <![CDATA[
            DELETE /* rem4060_d01 */
  	      	FROM   TBRC_T_TRADE_EVENT
  	      	WHERE  TRADE_DATE LIKE ?||'%'
			      
        ]]>
    </query>  
       
    
</queryMap>