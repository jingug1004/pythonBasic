<?xml version="1.0" encoding="EUC-KR"?>

<queryMap desc="rbo4050(출고승인)">
    <query id="rbo4050_s01" desc="출고승인 조회" fetchSize="10">
      <![CDATA[
			
			SELECT  /* rbo4050_s01 */
                     '0' AS CHK
                     ,A.PARTS_CD                     AS PARTS_CD     -- 부품코드 
                     ,A.BRNC_CD                      AS BRNC_CD      -- 지점코드 
                     ,FC_CODE_NM('018', A.BRNC_CD)   AS BRNC_NM      -- 지점명 
                     ,A.SEQ                          AS SEQ          -- 순번 
                     ,A.REQ_DT                       AS REQ_DT       -- 신청일자 
                     ,A.REQ_NO                       AS REQ_NO       -- 신청자 
                     ,NVL(A.REQ_CNT, 0)              AS REQ_CNT      -- 신청수량 
                     ,A.APRV_STAS                    AS APRV_STAS    -- 승인상태코드 
                     ,FC_CODE_NM('099', A.APRV_STAS) AS APRV_STAS_NM -- 승인상태명 
                     ,NVL(A.APRV_CNT, A.REQ_CNT)             AS APRV_CNT     -- 승인수량 
                     ,A.APRV_OFIR_NO                 AS APRV_OFIR_NO -- 승인자 
                     ,A.REQ_RSN                      AS REQ_RSN      -- 신청사유 
                     ,NVL(B.STK_CNT, 0)              AS STK_CNT      -- 신청가능(현재고) 수량 
                     ,C.PARTS_LCD                    AS PARTS_LCD    -- 발매기코드 
                     ,FC_CODE_NM('097', C.PARTS_LCD) AS PARTS_LCD_NM -- 발매기명 
                     ,C.PARTS_MCD                    AS PARTS_MCD    -- 부품그룹코드 
                     ,FC_CODE_NM('098', C.PARTS_MCD) AS PARTS_MCD_NM -- 부품그룹명 
                     ,C.PARTS_NM                     AS PARTS_NM     -- 부품명 
                     ,FC_CODE_NM('112', C.MADE_GBN)  AS MADE_GBN 
                     ,C.USE_YN                       AS USE_YN       -- 사용여부   
                     ,A.APRV_DT                      AS APRV_DT      -- 승인날짜
                     ,C.ATT_FILE_KEY				 AS ATT_FILE_KEY -- 첨부파일키
                     ,(SELECT REAL_FILE_NM 
                     	 FROM TBRK_FILE_MANA 
                     	WHERE ATT_FILE_KEY = C.ATT_FILE_KEY 
                     	  AND SEQ = (SELECT MAX(SEQ)
                                       FROM TBRK_FILE_MANA
                                      WHERE ATT_FILE_KEY = C.ATT_FILE_KEY)) AS REAL_FILE_NM	-- 첨부파일명
                     ,A.BRNC_IN_DT
                     ,A.BRNC_IN_ID
                     ,A.BRNC_IN_YN
                     ,SUBSTR(A.REQ_DT,0,4)||'-'||SUBSTR(A.REQ_DT,5,2)||'-'||SUBSTR(A.REQ_DT,7,2) AS F_REQ_DT  -- FORMAT 신청일자(YYYY-MM-DD) 
             FROM   TBRB_PARTS_REQ_APPR A 
                   ,(SELECT PARTS_CD 
                           ,NVL(SUM(STK_CNT), 0) AS STK_CNT 
                       FROM TBRB_PARTS_STOCK 
                      WHERE BRNC_CD = '00'  
                      GROUP BY PARTS_CD) B 
                   ,TBRB_PARTS_MODEL C 
            WHERE 1 = 1  
              AND  A.PARTS_CD = B.PARTS_CD               
              AND  A.PARTS_CD = C.PARTS_CD 
              AND  A.APRV_STAS IN ('002', '003','004') 
              AND  A.REQ_DT BETWEEN NVL(?, '19000101') AND NVL(?, '99991231')  -- 신청일자
              AND  C.PARTS_LCD LIKE '%' || NVL(?, C.PARTS_LCD) || '%'          -- 발매기
              AND  A.BRNC_CD LIKE '%' || NVL(?, A.BRNC_CD) || '%'              -- 지점
              AND  A.APRV_STAS LIKE '%' || NVL(?, A.APRV_STAS) || '%'          -- 승인상태  
              ORDER BY A.REQ_DT,A.BRNC_CD,C.PARTS_LCD,C.PARTS_MCD
			  
      ]]>
    </query>
    
    <query id="rbo4050_s02" desc="재고량 조회" fetchSize="10">
      <![CDATA[
			  SELECT  /* rbo4050_s02 */
			  		 NVL(STK_CNT, 0) AS STK_CNT
	            FROM TBRB_PARTS_STOCK  
	           WHERE 1=1  
	             AND PARTS_CD = ?
	             AND BRNC_CD  = '00'  
      ]]>
    </query>
    
	<query id="rbo4050_u01" desc="출고 신청 정보 수정" fetchSize="10">
      <![CDATA[
      
			UPDATE  TBRB_PARTS_REQ_APPR     /* rbo4050_u01 */
			SET
			      APRV_STAS = ?        -- 승인상태
			    , APRV_CNT = NVL(?, 0) -- 승인수량
			    , APRV_DT = ?		   -- 승인일자
			    , APRV_OFIR_NO = ?     -- 승인자
			    , UPDT_ID = ?          -- 수정자 ID
			    , UPDT_DT = SYSDATE    -- 수정일시
			WHERE PARTS_CD = ?         -- 부품코드
			AND   BRNC_CD = ?          -- 지점코드
			AND   SEQ = ?              -- 순번
			
      ]]>
    </query>
    
  
</queryMap>