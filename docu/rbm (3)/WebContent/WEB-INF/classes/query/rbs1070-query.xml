<?xml version="1.0" encoding='EUC-KR'?>

<queryMap desc="RBS1070(사업별 계획대비 집행내역등록)">
    
    
    <query id="rbs1070_s01" desc="사업별 계획대비 집행내역등록 조회" fetchSize="10">
        <![CDATA[
                   
			SELECT   /* rbs1070_s01 */
			         A.PREP_AMT_CD,  -- 시개금 코드
			         A.ACC_BGN_CD,   -- 회계구분코드
			         A.BUSI_NM,      -- 사업명
			         
			         A.QUAR_SUM,     -- 계획 분기 합
			         A.QUAR_1,       -- 1분기 계획
			         A.QUAR_2,       -- 2분기 계획
			         A.QUAR_3,       -- 3분기 계획
			         A.QUAR_4,       -- 4분기 계획
			         
			         --B.EXEC_QUAR_SUM, -- 집행분기 합         
			         --B.EXEC_QUAR_1,   -- 1분기 집행금액
			         --B.EXEC_QUAR_2,   -- 2분기 집행금액
			         --B.EXEC_QUAR_3,   -- 3분기 집행금액
			         --B.EXEC_QUAR_4,   -- 4분기 집행금액
			         
			       
			         CASE A.QUAR_SUM 
			         WHEN 0 THEN 0
			                ELSE ROUND((B.EXEC_QUAR_SUM / A.QUAR_SUM) * 100, 2) -- 집행/계획 * 100
			         END AS SUM_PERCENT,
			         
			         CASE A.QUAR_1 
			         WHEN 0 THEN 0
			                ELSE ROUND((B.EXEC_QUAR_1 / A.QUAR_1) * 100, 2) -- 집행/계획 * 100
			         END AS QUAR1_PERCENT,
			         
			         CASE A.QUAR_2 
			         WHEN 0 THEN 0
			                ELSE ROUND((B.EXEC_QUAR_2 / A.QUAR_2) * 100, 2) -- 집행/계획 * 100
			         END AS QUAR2_PERCENT,
			         
			         CASE A.QUAR_3 
			         WHEN 0 THEN 0
			                ELSE ROUND((B.EXEC_QUAR_3 / A.QUAR_3) * 100, 2) -- 집행/계획 * 100
			         END AS QUAR3_PERCENT,
			         
			         CASE A.QUAR_4 
			         WHEN 0 THEN 0
			                ELSE ROUND((B.EXEC_QUAR_4 / A.QUAR_4) * 100, 2) -- 집행/계획 * 100
			         END AS QUAR4_PERCENT
			         
			
			FROM     (
			          -- 당해년도 분기 계획
			          SELECT   A.PREP_AMT_CD,
			                   A.ACC_BGN_CD,  
			                   A.BUSI_NM,  
			                   
			                   NVL(A.QUAR_1, 0) + NVL(A.QUAR_2, 0) + NVL(A.QUAR_3, 0) + NVL(A.QUAR_4, 0) AS QUAR_SUM,  -- 계획 분기 합
			                   
			                   NVL(A.QUAR_1, 0) AS QUAR_1,   -- 1분기 계획
			                   NVL(A.QUAR_2, 0) AS QUAR_2,   -- 2분기 계획
			                   NVL(A.QUAR_3, 0) AS QUAR_3,   -- 3분기 계획
			                   NVL(A.QUAR_4, 0) AS QUAR_4    -- 4분기 계획
			                                                                            
			          FROM     TBRE_BUSI_PLAN A
			          WHERE    A.ACC_BGN_CD LIKE '%' || NVL(?, A.ACC_BGN_CD) || '%'  -- 1. 회계구분  
			          AND      A.BUSI_YEAR = ?                                       -- 2. 사업년도  
			          AND      A.BUSI_NM LIKE '%' || NVL(?, A.BUSI_NM) || '%'        -- 3. 사업명
			          
			         ) A,
			         (
			          -- 당해년도 분기 실행
			          SELECT   A.PREP_AMT_CD,
			                   A.ACC_BGN_CD,  
			                   A.BUSI_NM,                 
			                   
			                   SUM(NVL(B.EXEC_QUAR_1, 0)) + SUM(NVL(B.EXEC_QUAR_2, 0)) + SUM(NVL(B.EXEC_QUAR_3, 0)) + SUM(NVL(B.EXEC_QUAR_4, 0)) AS EXEC_QUAR_SUM, -- 분기 합
			                   SUM(NVL(B.EXEC_QUAR_1, 0)) AS EXEC_QUAR_1,  -- 1분기 집행금액
			                   SUM(NVL(B.EXEC_QUAR_2, 0)) AS EXEC_QUAR_2,  -- 2분기 집행금액
			                   SUM(NVL(B.EXEC_QUAR_3, 0)) AS EXEC_QUAR_3,  -- 3분기 집행금액
			                   SUM(NVL(B.EXEC_QUAR_4, 0)) AS EXEC_QUAR_4   -- 4분기 집행금액
			                   
			          FROM     TBRE_BUSI_PLAN A, 
			                   (
			                    SELECT   B.PREP_AMT_CD, 
			                             
				                         DECODE(SUBSTR(B.EXEC_DT, 5, 2)||SUBSTR(B.EXEC_DT, 0, 4), '01'||C.BUSI_YEAR, B.EXEC_AMT, '02'||C.BUSI_YEAR, B.EXEC_AMT, '03'||C.BUSI_YEAR, B.EXEC_AMT) AS EXEC_QUAR_1,    
                                         DECODE(SUBSTR(B.EXEC_DT, 5, 2)||SUBSTR(B.EXEC_DT, 0, 4), '04'||C.BUSI_YEAR, B.EXEC_AMT, '05'||C.BUSI_YEAR, B.EXEC_AMT, '06'||C.BUSI_YEAR, B.EXEC_AMT) AS EXEC_QUAR_2,  
                                         DECODE(SUBSTR(B.EXEC_DT, 5, 2)||SUBSTR(B.EXEC_DT, 0, 4), '07'||C.BUSI_YEAR, B.EXEC_AMT, '08'||C.BUSI_YEAR, B.EXEC_AMT, '09'||C.BUSI_YEAR, B.EXEC_AMT) AS EXEC_QUAR_3,  
                                         DECODE(SUBSTR(B.EXEC_DT, 5, 2)||SUBSTR(B.EXEC_DT, 0, 4), '10'||C.BUSI_YEAR, B.EXEC_AMT, '11'||C.BUSI_YEAR, B.EXEC_AMT, '12'||C.BUSI_YEAR, B.EXEC_AMT) AS EXEC_QUAR_4 

			                    FROM     TBRE_BUSI_EXEC B
			                             ,TBRE_BUSI_PLAN C
			                    WHERE  B.PREP_AMT_CD = C.PREP_AMT_CD 

			                   )B
			          WHERE    A.PREP_AMT_CD = B.PREP_AMT_CD(+)  
			          AND      A.ACC_BGN_CD LIKE '%' || NVL(?, A.ACC_BGN_CD) || '%'  -- 6. 회계구분  
			          AND      A.BUSI_YEAR = ?                                       -- 7. 사업년도  
			          AND      A.BUSI_NM LIKE '%' || NVL(?, A.BUSI_NM) || '%'        -- 8. 사업명
			          GROUP BY A.PREP_AMT_CD, A.ACC_BGN_CD, A.BUSI_NM  
			         ) B         
			         
			WHERE    A.PREP_AMT_CD = B.PREP_AMT_CD 
			ORDER BY A.PREP_AMT_CD, A.ACC_BGN_CD       

			
        ]]>
    </query>       

	
        
</queryMap>