<?xml version="1.0" encoding='EUC-KR'?>

<queryMap desc="REV4030(개인통계현황)">
	<query id="rev4030_s01" desc="개인통계현황 조회" fetchSize="10">
		<![CDATA[
 			SELECT /* rev4030_s01 */
 			       A3.ESTM_YEAR 
		          ,A3.ESTM_NUM  
		          ,A3.DEPT_CD 
		          ,A3.DEPT_NM 
		          ,A3.WK_JOB_CD 
		          ,A3.WK_JOB_NM 
		          ,A3.EMP_NO 
		          ,A3.EMP_NM 
		          ,A3.CNTR_ITM_CD 
		          ,A1.TOT_GRD AS GRD_1  
		          ,A2.TOT_GRD AS GRD_2  
		          ,A3.TOT_GRD AS GRD_3
                  ,E.WK_JOB_CD AS WK_JOB_CD_ORG
                  ,(SELECT WK_JOB_NM FROM TBRF_EV_WORK_JOB WHERE ESTM_YEAR = A3.ESTM_YEAR AND ESTM_NUM = A3.ESTM_NUM AND WK_JOB_CD = E.WK_JOB_CD) AS WK_JOB_NM_ORG  
		      FROM TBRF_EV_TOTAL_RSLT A3 
		          ,(SELECT ESTM_YEAR 
		                  ,ESTM_NUM  
		                  ,DEPT_CD 
		                  ,DEPT_NM 
		                  ,WK_JOB_CD 
		                  ,WK_JOB_NM 
		                  ,EMP_NO 
		                  ,EMP_NM 
		                  ,TOT_GRD 
		              FROM TBRF_EV_TOTAL_RSLT 
		             WHERE 1 = 1 
		               AND ESTM_YEAR = (SELECT ESTM_YEAR 
		                                        
		                                    FROM (   
		                                      SELECT  ESTM_YEAR 
		                                             ,ESTM_NUM  
		                                           ,RANK() OVER (ORDER BY ESTM_YEAR DESC, ESTM_NUM DESC) AS RNK 
		                                      FROM TBRF_EV_TOTAL_RSLT      
		                                     GROUP BY ESTM_YEAR 
		                                             ,ESTM_NUM    
		                                        )  
		                                      WHERE RNK = (     
		                                                     SELECT  A.RNK + 1 
		                                                       FROM ( 
		                                                                SELECT ESTM_YEAR 
		                                                                      ,ESTM_NUM 
		                                                                      ,RANK() OVER (ORDER BY ESTM_YEAR DESC, ESTM_NUM DESC) AS RNK 
		                                                                  FROM TBRF_EV_TOTAL_RSLT      
		                                                                 GROUP BY ESTM_YEAR 
		                                                                         ,ESTM_NUM 
		                                                                        
		                                                            ) A         
		                                                             WHERE 1 = 1 
		                                                               AND A.ESTM_YEAR = ?
		                                                               AND A.ESTM_NUM  = ? 
		                       )             
		                 ) 
		               AND ESTM_NUM = (SELECT ESTM_NUM 
		        FROM (   
		          SELECT  ESTM_NUM  
		               ,RANK() OVER (ORDER BY ESTM_YEAR DESC, ESTM_NUM DESC) AS RNK 
		          FROM TBRF_EV_TOTAL_RSLT      
		         GROUP BY ESTM_YEAR 
		                 ,ESTM_NUM    
		            )  
		          WHERE RNK = (     
		                         SELECT  A.RNK + 1 
		                           FROM ( 
		                                    SELECT ESTM_YEAR 
		                                          ,ESTM_NUM 
		                                          ,RANK() OVER (ORDER BY ESTM_YEAR DESC, ESTM_NUM DESC) AS RNK 
		                                      FROM TBRF_EV_TOTAL_RSLT      
		                                     GROUP BY ESTM_YEAR 
		                                             ,ESTM_NUM 
		                                            
		                                ) A         
		                                 WHERE 1 = 1 
		                                   AND A.ESTM_YEAR = ? 
		                                   AND A.ESTM_NUM  = ? 
		                       )             
		                 )) A2  
		          ,(SELECT ESTM_YEAR 
		                  ,ESTM_NUM  
		                  ,DEPT_CD 
		                  ,DEPT_NM 
		                  ,WK_JOB_CD 
		                  ,WK_JOB_NM 
		                  ,EMP_NO 
		                  ,EMP_NM 
		                  ,TOT_GRD 
		              FROM TBRF_EV_TOTAL_RSLT 
		             WHERE 1 = 1 
		               AND ESTM_YEAR = (SELECT ESTM_YEAR 
		                                        
		                                    FROM (   
		                                      SELECT  ESTM_YEAR 
		                                             ,ESTM_NUM  
		                                           ,RANK() OVER (ORDER BY ESTM_YEAR DESC, ESTM_NUM DESC) AS RNK 
		                                      FROM TBRF_EV_TOTAL_RSLT      
		                                     GROUP BY ESTM_YEAR 
		                                             ,ESTM_NUM    
		                                        )  
		                                      WHERE RNK = (     
		                                                     SELECT  A.RNK + 2 
		                                                       FROM ( 
		                                                                SELECT ESTM_YEAR 
		                                                                      ,ESTM_NUM 
		                                                                      ,RANK() OVER (ORDER BY ESTM_YEAR DESC, ESTM_NUM DESC) AS RNK 
		                                                                  FROM TBRF_EV_TOTAL_RSLT      
		                                                                 GROUP BY ESTM_YEAR 
		                                                                         ,ESTM_NUM 
		                                                                        
		                                                            ) A         
		                                                             WHERE 1 = 1 
		                                                               AND A.ESTM_YEAR = ? 
		                                                               AND A.ESTM_NUM  = ? 
		                                                   )             
		                                             ) 
		               AND ESTM_NUM = (SELECT ESTM_NUM 
		                                    FROM (   
		                                      SELECT  ESTM_YEAR 
		                                             ,ESTM_NUM  
		                                           ,RANK() OVER (ORDER BY ESTM_YEAR DESC, ESTM_NUM DESC) AS RNK 
		                                      FROM TBRF_EV_TOTAL_RSLT      
		                                     GROUP BY ESTM_YEAR 
		                                             ,ESTM_NUM    
		                                        )  
		                                      WHERE RNK = (     
		                                                     SELECT  A.RNK + 2 
		                                                       FROM ( 
		                                                                SELECT ESTM_YEAR 
		                                                                      ,ESTM_NUM 
		                                                                      ,RANK() OVER (ORDER BY ESTM_YEAR DESC, ESTM_NUM DESC) AS RNK 
		                                                                  FROM TBRF_EV_TOTAL_RSLT      
		                                                                 GROUP BY ESTM_YEAR 
		                                                                         ,ESTM_NUM 
		                                                                        
		                                                            ) A         
		                                                             WHERE 1 = 1 
		                                                               AND A.ESTM_YEAR = ? 
		                                                               AND A.ESTM_NUM  = ? 
		                                                   )             
		                 )) A1 ,
                   TBRF_EV_EMP E       
		     WHERE 1 = 1 
		       AND A3.EMP_NO = A2.EMP_NO(+) 
		       AND A3.EMP_NO = A1.EMP_NO(+) 
               AND A3.ESTM_YEAR = E.ESTM_YEAR
               AND A3.ESTM_NUM  = E.ESTM_NUM
               AND A3.EMP_NO    = E.EMP_NO
               AND E.WRK_GBN    = '001'
		       AND A3.ESTM_YEAR = ? 
		       AND A3.ESTM_NUM  = ? 
		       AND DECODE(?, '', '1', A3.DEPT_CD ) = DECODE(?, '', '1', ?)
		       AND A3.EMP_NM LIKE '%'||NVL(?, A3.EMP_NM)||'%'
		      ORDER BY A3.CNTR_ITM_CD, A3.DEPT_CD 
        ]]>
	</query>
	<query id="rev4030_s02" desc="모든 평가년도, 평가회차 조회" fetchSize="10">
        <![CDATA[
		  SELECT /* rev4030_s02 */
		         ESTM_YEAR||LPAD(ESTM_NUM,2,0) AS CD
		        ,ESTM_YEAR
		        ,ESTM_NUM
		    FROM TBRF_EV_TOTAL_RSLT
		GROUP BY ESTM_YEAR
		        ,ESTM_NUM
		ORDER BY ESTM_YEAR||LPAD(ESTM_NUM,2,0) DESC 
        ]]>
    </query> 
</queryMap>