<?xml version="1.0" encoding='EUC-KR'?>
<queryMap desc="tbeb_race_day_ord(경주일차)">
    <query id="tbef_equip_lot_fb001" desc="조회" fetchSize="10">
        <![CDATA[
            SELECT
                     TE   .STND_YEAR
                   , TE   .MBR_CD
                   , TE   .EQUIP_TPE_CD
                   , TE   .EQUIP_NO
                   , SUBSTR(TE.EQUIP_NO, 6, 3) VIEW_EQUIP_NO			         
                   , TE   .EQUIP_REG_NO
                   , TEL  .TRAN_USE_YN
                   , ABS(? - TMRAS.AVG_RANK_SCR) GAP_AVG_RANK_SCR
                   , TMRAS.TMS                            
                   , TMRAS.RUN_CNT                        
                   , TMRAS.RACE_CNT                       
                   , TMRAS.RACE_DAY_CNT                   
                   , TMRAS.RANK_1_CNT                     
                   , TMRAS.RANK_2_CNT                     
                   , TMRAS.RANK_3_CNT                     
                   , TMRAS.RANK_4_CNT                     
                   , TMRAS.RANK_5_CNT                     
                   , TMRAS.RANK_6_CNT                     
                   , TMRAS.AMU_RANK_SCR                  
                   , TMRAS.AVG_RANK_SCR                   
                   , TMRAS.WIN_RATIO                      
                   , TMRAS.HIGH_RANK_RATIO                
                   , TMRAS.HIGH_3_RANK_RATIO              
                   , TMRAS.TMS_3_ITRDT_RUN_TM             
                   , TMRAS.AVG_ITRDT_RUN_TM               
                   , TMRAS.MAX_ITRDT_RUN_TM               
                   , TMRAS.MIN_ITRDT_RUN_TM               
                   , TMRAS.ITRDT_RUN_TM_DVTN              
            FROM     TBEF_EQUIP        TE
                   , (
                        SELECT *
                        FROM   (
                                  SELECT   RANK() OVER (PARTITION BY TMRAS.MOT_NO 
                                                            ORDER BY TMRAS.STND_YEAR DESC
                                                                   , TMRAS.TMS DESC 
                                                       ) RANK
                                         , TMRAS.*
                                  FROM   TBEB_MOT_RECD_ACCU_SUM TMRAS
                                  WHERE  TMRAS.MBR_CD = ?
                                  AND    TMRAS.STND_YEAR || LPAD(TMRAS.TMS, 3, '0') <= ? || LPAD(?, 3, '0')
                               )
                        WHERE  RANK = 1
                     ) TMRAS
                   , TBEF_EQUIP_LOT TEL
            WHERE  TE   .MBR_CD       = TMRAS.MBR_CD(+)
            AND    TE   .EQUIP_NO     = TMRAS.MOT_NO(+)
            AND    TE   .STND_YEAR    = TEL  .STND_YEAR
            AND    TE   .MBR_CD       = TEL  .MBR_CD
            AND    TE   .EQUIP_TPE_CD = TEL  .EQUIP_TPE_CD
            AND    TE   .EQUIP_NO     = TEL  .EQUIP_NO
            AND    TEL  .STND_YEAR    = ?
            AND    TEL  .MBR_CD       = ?
            AND    TEL  .TMS          = ?
            AND    TEL  .EQUIP_TPE_CD = 'M'
            AND    TEL  .EQUIP_NO     = NVL(?, TEL.EQUIP_NO)
            AND    TEL  .PREPAR_YN    = 'Y'
            ORDER BY ABS(? - TMRAS.AVG_RANK_SCR)
        ]]>
    </query> 
    <query id="tbef_equip_lot_fb002" desc="조회" fetchSize="10">
        <![CDATA[
            SELECT
                     TE   .STND_YEAR
                   , TE   .MBR_CD
                   , TE   .EQUIP_TPE_CD
                   , TE   .EQUIP_NO
                   , SUBSTR(TE.EQUIP_NO, 6, 3) VIEW_EQUIP_NO			         
                   , TE   .EQUIP_REG_NO
                   , TEL  .TRAN_USE_YN
                   , ABS(? - TBRAS.AVG_RANK_SCR) GAP_AVG_RANK_SCR
                   , TBRAS.TMS                            
                   , TBRAS.RUN_CNT                        
                   , TBRAS.RACE_CNT                       
                   , TBRAS.RACE_DAY_CNT                   
                   , TBRAS.RANK_1_CNT                     
                   , TBRAS.RANK_2_CNT                     
                   , TBRAS.RANK_3_CNT                     
                   , TBRAS.RANK_4_CNT                     
                   , TBRAS.RANK_5_CNT                     
                   , TBRAS.RANK_6_CNT                     
                   , TBRAS.AMU_RANK_SCR                  
                   , TBRAS.AVG_RANK_SCR                   
                   , TBRAS.WIN_RATIO                      
                   , TBRAS.HIGH_RANK_RATIO                
                   , TBRAS.HIGH_3_RANK_RATIO              
                   , TBRAS.TMS_3_ITRDT_RUN_TM             
                   , TBRAS.AVG_ITRDT_RUN_TM               
                   , TBRAS.MAX_ITRDT_RUN_TM               
                   , TBRAS.MIN_ITRDT_RUN_TM               
                   , TBRAS.ITRDT_RUN_TM_DVTN              
            FROM     TBEF_EQUIP        TE
                   , (
                        SELECT *
                        FROM   (
                                  SELECT   RANK() OVER (PARTITION BY TBRAS.BOAT_NO 
                                                            ORDER BY TBRAS.STND_YEAR DESC
                                                                   , TBRAS.TMS DESC 
                                                       ) RANK
                                         , TBRAS.*
                                  FROM   TBEB_BOAT_RECD_ACCU_SUM TBRAS
                                  WHERE  TBRAS.MBR_CD = ?
                                  AND    TBRAS.STND_YEAR || LPAD(TBRAS.TMS, 3, '0') <= ? || LPAD(?, 3, '0')
                               )
                        WHERE  RANK = 1
                     ) TBRAS
                   , TBEF_EQUIP_LOT TEL
            WHERE  TE   .MBR_CD       = TBRAS.MBR_CD(+)
            AND    TE   .EQUIP_NO     = TBRAS.BOAT_NO(+)
            AND    TE   .STND_YEAR    = TEL  .STND_YEAR
            AND    TE   .MBR_CD       = TEL  .MBR_CD
            AND    TE   .EQUIP_TPE_CD = TEL  .EQUIP_TPE_CD
            AND    TE   .EQUIP_NO     = TEL  .EQUIP_NO
            AND    TEL  .STND_YEAR    = ?
            AND    TEL  .MBR_CD       = ?
            AND    TEL  .TMS          = ?
            AND    TEL  .EQUIP_TPE_CD = 'B'
            AND    TEL  .EQUIP_NO     = NVL(?, TEL.EQUIP_NO)
            AND    TEL  .PREPAR_YN    = 'Y'
            ORDER BY ABS(? - TBRAS.AVG_RANK_SCR)
        ]]>
    </query> 
    <query id="tbef_equip_lot_ub001" desc="저장" fetchSize="10">
        <![CDATA[
        	/* tbef_equip_lot_ub001 장비변경내역 저장 */
			UPDATE TBEF_EQUIP_LOT SET
			         TRAN_USE_YN    = 'Y'
			       , UPDT_ID        = ?
			       , UPDT_DTM       = SYSDATE
			WHERE  STND_YEAR        = ?
			AND    MBR_CD           = ?
			AND    TMS              = ?
			AND    EQUIP_TPE_CD     = ?
			AND    EQUIP_NO         = ?
			AND    PREPAR_YN        = 'Y'
        ]]>
    </query> 
</queryMap>