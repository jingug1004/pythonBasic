<?xml version="1.0" encoding='EUC-KR'?>
<queryMap desc="tbeb_race_rank(Æ¯º°½Â°­±Þ ´ë»ó¼±¼ö)">
    <query id="tbeb_race_rank_fb001" desc="Á¶È¸" fetchSize="10">
        <![CDATA[
            SELECT
                     TRM.RACER_NO
                   , TRM.NM_KOR
                   , TRM.RACER_GRD_CD
                   , TRM.RACER_GRD_CD NEW_RACER_GRD
                   , WIN_COUNT .CNT   CONT_WIN_CNT
                   , HIGH_COUNT.CNT   CONT_HIGH_CNT
                   , LOST_COUNT.CNT   CONT_LOSE_CNT
            FROM     TBEC_RACER_MASTER TRM
                   , (
                        SELECT
                                  RACER_NO
                                , MIN(NVL(SEQ, 0)) CNT
                        FROM    (
                                    SELECT
                                             TOR.RACER_NO
                                           , WIN_CNT
                        			       , LEAD(WIN_CNT) OVER (PARTITION BY TOR .RACER_NO
                                                                     ORDER BY SEQ
                                                                           ) PRE
                                           , SEQ
                                    FROM   (
                                                SELECT   TOR.RACER_NO
                                                       , DECODE(TOR.RANK, 1, 1, 0) WIN_CNT
                                                       , RANK() OVER (PARTITION BY TOR.RACER_NO
                                                                          ORDER BY TOR.RACE_DAY DESC
                                                                                 , TOR.RACE_NO  DESC ) SEQ
                                                FROM   TBEB_ORGAN TOR
                                                WHERE  TOR.RACE_DAY BETWEEN ?
                                                                        AND ?
                                                AND    TOR.RACER_NO IN (
                                                                            SELECT
                                                                                     TOR.RACER_NO
                                                                            FROM   (
                                                                                        SELECT   TOR.RACER_NO
                                                                                               , FIRST_VALUE(RANK) OVER (PARTITION BY TOR .RACER_NO 
                                                                                                                                ORDER BY TOR.RACE_DAY DESC
                                                                                                                                       , TOR.RACE_NO  DESC ) FIRST_CNT
                                                                                        FROM   TBEB_ORGAN TOR
                                                                                        WHERE  TOR.RACE_DAY BETWEEN ?
                                                                                                                AND ?
                                                                                   ) TOR
                                                                            WHERE  FIRST_CNT IN (1)
                                                                            GROUP BY TOR.RACER_NO
                                                                       )
                        
                        
                                           ) TOR
                                )
                        WHERE  WIN_CNT = 1
                        AND    PRE     = 0
                        GROUP BY RACER_NO
                     ) WIN_COUNT -- ½Â¸®È½¼ö
                   , (
                        SELECT
                                  RACER_NO
                                , MIN(NVL(SEQ, 0)) CNT
                        FROM    (
                                    SELECT
                                             TOR.RACER_NO
                                           , WIN_CNT
                        			       , LEAD(WIN_CNT) OVER (PARTITION BY TOR .RACER_NO
                                                                     ORDER BY SEQ
                                                                           ) PRE
                                           , SEQ
                                    FROM   (
                                                SELECT   TOR.RACER_NO
                                                       , DECODE(TOR.RANK, 1, 1, 2, 1, 0) WIN_CNT
                                                       , RANK() OVER (PARTITION BY TOR.RACER_NO
                                                                          ORDER BY TOR.RACE_DAY DESC
                                                                                 , TOR.RACE_NO  DESC ) SEQ
                                                FROM   TBEB_ORGAN TOR
                                                WHERE  TOR.RACE_DAY BETWEEN ?
                                                                        AND ?
                                                AND    TOR.RACER_NO IN (
                                                                            SELECT
                                                                                     TOR.RACER_NO
                                                                            FROM   (
                                                                                        SELECT   TOR.RACER_NO
                                                                                               , FIRST_VALUE(RANK) OVER (PARTITION BY TOR .RACER_NO 
                                                                                                                                ORDER BY TOR.RACE_DAY DESC
                                                                                                                                       , TOR.RACE_NO  DESC ) FIRST_CNT
                                                                                        FROM   TBEB_ORGAN TOR
                                                                                        WHERE  TOR.RACE_DAY BETWEEN ?
                                                                                                                AND ?
                                                                                   ) TOR
                                                                            WHERE  FIRST_CNT IN (1, 2)
                                                                            GROUP BY TOR.RACER_NO
                                                                       )
                        
                        
                                           ) TOR
                                )
                        WHERE  WIN_CNT = 1
                        AND    PRE     = 0
                        GROUP BY RACER_NO
                     ) HIGH_COUNT -- ¿¬´ëÈ½¼ö
                   , (
                        SELECT
                                  RACER_NO
                                , MIN(NVL(SEQ, 0)) CNT
                        FROM    (
                                    SELECT
                                             TOR.RACER_NO
                                           , WIN_CNT
                        			       , LEAD(WIN_CNT) OVER (PARTITION BY TOR .RACER_NO
                                                                     ORDER BY SEQ
                                                                           ) PRE
                                           , SEQ
                                    FROM   (
                                                SELECT   TOR.RACER_NO
                                                       , DECODE(TOR.RANK, 5, 1, 6, 1, 0) WIN_CNT
                                                       , RANK() OVER (PARTITION BY TOR.RACER_NO
                                                                          ORDER BY TOR.RACE_DAY DESC
                                                                                 , TOR.RACE_NO  DESC ) SEQ
                                                FROM   TBEB_ORGAN TOR
                                                WHERE  TOR.RACE_DAY BETWEEN ?
                                                                        AND ?
                                                AND    TOR.RACER_NO IN (
                                                                            SELECT
                                                                                     TOR.RACER_NO
                                                                            FROM   (
                                                                                        SELECT   TOR.RACER_NO
                                                                                               , FIRST_VALUE(RANK) OVER (PARTITION BY TOR .RACER_NO 
                                                                                                                                ORDER BY TOR.RACE_DAY DESC
                                                                                                                                       , TOR.RACE_NO  DESC ) FIRST_CNT
                                                                                        FROM   TBEB_ORGAN TOR
                                                                                        WHERE  TOR.RACE_DAY BETWEEN ?
                                                                                                                AND ?
                                                                                   ) TOR
                                                                            WHERE  FIRST_CNT IN (5, 6)
                                                                            GROUP BY TOR.RACER_NO
                                                                       )
                        
                        
                                           ) TOR
                                )
                        WHERE  WIN_CNT = 1
                        AND    PRE     = 0
                        GROUP BY RACER_NO
                     ) LOST_COUNT -- ¿¬ÆÐÈ½¼ö
            WHERE  TRM.RACER_NO = WIN_COUNT .RACER_NO(+)
            AND    TRM.RACER_NO = HIGH_COUNT.RACER_NO(+)
            AND    TRM.RACER_NO = LOST_COUNT.RACER_NO(+)
            AND    TRM.RACER_STAT_CD IN ('001', '002')
            ORDER BY TRM.RACER_NO
        ]]>
    </query>
    <query id="tbeb_race_rank_fb002" desc="¼±¼ö»ó¼¼¼ºÀûÁ¶È¸Á¶È¸" fetchSize="10">
        <![CDATA[
			SELECT
			         TOR .STND_YEAR
			       , TOR .MBR_CD
			       , TOR .TMS
			       , TOR .DAY_ORD
			       , TOR .RACE_NO
			       , DECODE(TOR.ABSE_CD, '001', DECODE(TOR.IMMT_CLS_CD, '003', (SELECT CD_NM FROM TBEA_SPEC_CD WHERE GRP_CD = 'E00113' AND CD = TOR.IMMT_CLS_CD), TO_CHAR(TOR.RANK)), (SELECT CD_NM FROM TBEA_SPEC_CD WHERE GRP_CD = 'E00110' AND CD = TOR.ABSE_CD)) RANK
			       , TRS .RACE_SCR
			       , NVL(TRVA.ACDNT_SCR, 0) ACDNT_SCR
			FROM     TBEB_ORGAN         TOR
			       , TBEB_RACE          TR
			       , TBEB_RANK_SCR      TRS
			       , TBEB_RACE_DAY_ORD  TRDO
			       , (
                        SELECT
			                     TRVA.STND_YEAR
			                   , TRVA.MBR_CD
			                   , TRVA.TMS
			                   , TRVA.DAY_ORD
			                   , TRVA.RACE_NO
			                   , TRVA.RACE_REG_NO
			                   , NVL(TRVB.ACDNT_SCR, TRVA.ACDNT_SCR) ACDNT_SCR
                        FROM     (
            			            SELECT
            			                     TRVA.STND_YEAR
            			                   , TRVA.MBR_CD
            			                   , TRVA.TMS
            			                   , TRVA.DAY_ORD
            			                   , TRVA.RACE_NO
            			                   , TRVA.RACE_REG_NO
            			                   , SUM(TAS.ACDNT_SCR) ACDNT_SCR
            			            FROM     TBED_RACE_VOIL_ACT TRVA
            			                   , TBEB_ACDNT_SCR     TAS
            			            WHERE  TRVA.STND_YEAR    = TAS.STND_YEAR
            			            AND    TRVA.VOIL_CD      = TAS.VOIL_CD
            			            AND    TRVA.RACE_DAY BETWEEN ?
            			                                     AND ?
            			            GROUP BY
            			                     TRVA.STND_YEAR
            			                   , TRVA.MBR_CD
            			                   , TRVA.TMS
            			                   , TRVA.DAY_ORD
            			                   , TRVA.RACE_NO
            			                   , TRVA.RACE_REG_NO
			                     ) TRVA
			                   , (
            			            SELECT
            			                     TRVA.STND_YEAR
            			                   , TRVA.MBR_CD
            			                   , TRVA.TMS
            			                   , TRVA.DAY_ORD
            			                   , TRVA.RACE_NO
            			                   , TRVA.RACE_REG_NO
            			                   , TAS .ACDNT_SCR
            			            FROM     TBED_RACE_VOIL_ACT TRVA
            			                   , TBEB_ACDNT_SCR     TAS
            			            WHERE  TRVA.STND_YEAR    = TAS.STND_YEAR
            			            AND    TRVA.VOIL_CD      = TAS.VOIL_CD
            			            AND    TRVA.RACE_DAY BETWEEN ?
            			                                     AND ?
            			            AND   TRVA.VOIL_CD      IN ('110', '120')
                                 ) TRVB
                        WHERE  TRVA.STND_YEAR   = TRVB.STND_YEAR  (+)
			            AND    TRVA.MBR_CD      = TRVB.MBR_CD     (+)
			            AND    TRVA.TMS         = TRVB.TMS        (+)
			            AND    TRVA.DAY_ORD     = TRVB.DAY_ORD    (+)
			            AND    TRVA.RACE_NO     = TRVB.RACE_NO    (+)
			            AND    TRVA.RACE_REG_NO = TRVB.RACE_REG_NO(+)
			         ) TRVA
			WHERE  TOR .STND_YEAR    = TR  .STND_YEAR
			AND    TOR .MBR_CD       = TR  .MBR_CD
			AND    TOR .TMS          = TR  .TMS
			AND    TOR .DAY_ORD      = TR  .DAY_ORD
			AND    TOR .RACE_NO      = TR  .RACE_NO
			AND    TOR .STND_YEAR    = TRDO.STND_YEAR
			AND    TOR .MBR_CD       = TRDO.MBR_CD
			AND    TOR .TMS          = TRDO.TMS
			AND    TOR .DAY_ORD      = TRDO.DAY_ORD
			AND    TRDO.ORGAN_STAT_CD = '002'
			AND    TR  .STND_YEAR    = TRS .STND_YEAR
			AND    TR  .RACE_DGRE_CD = TRS .RACE_DGRE_CD
			AND    TOR .RANK         = TRS .RANK
			AND    TOR .STND_YEAR    = TRVA.STND_YEAR  (+)
			AND    TOR .MBR_CD       = TRVA.MBR_CD     (+)
			AND    TOR .TMS          = TRVA.TMS        (+)
			AND    TOR .DAY_ORD      = TRVA.DAY_ORD    (+)
			AND    TOR .RACE_NO      = TRVA.RACE_NO    (+)
			AND    TOR .RACE_REG_NO  = TRVA.RACE_REG_NO(+)
            AND    TOR .RACE_DAY BETWEEN ?
                                     AND ?
			AND    TOR.RACER_NO      = NVL(?, TOR.RACER_NO)
			AND    TOR.MOT_NO        = NVL(?, TOR.MOT_NO  )
			AND    TOR.BOAT_NO       = NVL(?, TOR.BOAT_NO )
            ORDER BY
                       TOR.RACE_DAY  DESC
                     , TOR.RACE_NO   DESC
        ]]>
    </query>    
    <query id="tbeb_race_rank_fb003" desc="¼±¼öº° ¿¬½ÂÈ¸¼ö Á¶È¸(ÀüÃ¼)" fetchSize="10">
        <![CDATA[
            SELECT
                     TRM.RACER_NO
                   , TRM.NM_KOR
                   , TRM.RACER_GRD_CD
                   , TRM.RACER_GRD_CD NEW_RACER_GRD
                   , WIN_COUNT .TERM   CONT_WIN_CNT
                   , HIGH_COUNT.TERM   CONT_HIGH_CNT
                   , LOST_COUNT.TERM   CONT_LOSE_CNT
            FROM     TBEC_RACER_MASTER TRM
                   , (
                        SELECT
                                 TOR.RACER_NO
                               , TRM.NM_KOR
                               , TOR.STND_YEAR
                               , TOR.TERM
                               , TOR.SEQ
                        FROM     (
                                    SELECT
                                             RACER_NO
                                           , STND_YEAR
                                           , MAX(TERM) TERM
                                           , RANK() OVER (PARTITION BY RACER_NO ORDER BY MAX(TERM) DESC) SEQ
                                    FROM   (
                                                SELECT
                                                         RACER_NO
                                                       , STND_YEAR
                                                       , WIN_CNT
                                    			       , PRE
                                                       , SEQ
                                                       , LEAD(SEQ) OVER (PARTITION BY RACER_NO, STND_YEAR ORDER BY SEQ) - SEQ TERM
                                                FROM   (
                                                            SELECT
                                                                     RACER_NO
                                                                   , STND_YEAR
                                                                   , WIN_CNT
                                                			       , LEAD(WIN_CNT) OVER (PARTITION BY RACER_NO, STND_YEAR ORDER BY SEQ) PRE
                                                                   , SEQ
                                                            FROM   (
                                                                        SELECT   TOR.RACER_NO
                                                                               , TOR.STND_YEAR
                                                                               , CASE WHEN TOR.RANK = 1 AND TOR.RANK > 0 THEN 1 ELSE 0 END WIN_CNT
                                                                               , RANK() OVER (PARTITION BY TOR.RACER_NO
                                                                                                         , STND_YEAR
                                                                                                  ORDER BY TOR.RACE_DAY DESC
                                                                                                         , TOR.RACE_NO  DESC ) SEQ
                                                                        FROM   (
                                                                                    SELECT
                                                                                             STND_YEAR
                                                                                           , RACER_NO
                                                                                           , RACE_DAY
                                                                                           , RACE_NO
                                                                                           , RANK
                                                                                    FROM   TBEB_ORGAN TOR
                                                                                    WHERE  RACE_DAY BETWEEN ?
                                                                                                        AND ?
                                                                                    
                                                                                    UNION ALL
                                                                                    
                                                                                    SELECT
                                                                                             STND_YEAR
                                                                                           , RACER_NO
                                                                                           , STND_YEAR || '1231'
                                                                                           , '99'
                                                                                           , 6
                                                                                    FROM   TBEB_ORGAN TOR
                                                                                    WHERE  RACE_DAY BETWEEN ?
                                                                                                        AND ?
                                                                                    AND    RACER_NO      IN (
                                                                                                                SELECT
                                                                                                                       RACER_NO
                                                                                                                FROM   (
                                                                                                                            SELECT   TOR.RACER_NO
                                                                                                                                   , FIRST_VALUE(RANK) OVER (PARTITION BY TOR .RACER_NO 
                                                                                                                                                                    ORDER BY TOR.RACE_DAY DESC
                                                                                                                                                                           , TOR.RACE_NO  DESC ) FIRST_CNT
                                                                                                                            FROM   TBEB_ORGAN TOR
                                                                                                                            WHERE  RACE_DAY BETWEEN ?
                                                                                                                                                AND ?
                                                                                                                       )
                                                                                                                WHERE  FIRST_CNT  = 1
                                                                                                            )
                                                                                    GROUP BY STND_YEAR
                                                                                           , RACER_NO
                                                                               ) TOR
                                                                   )
                                                       )
                                                WHERE  (WIN_CNT = 1 AND PRE = 0)
                                                OR     (WIN_CNT = 0 AND PRE = 1)
                                                OR     (WIN_CNT = 1 AND PRE IS NULL)
                                           )
                                    WHERE WIN_CNT = 0 
                                    AND   PRE     = 1
                                    AND   TERM IS NOT NULL
                                    GROUP BY 
                                             RACER_NO
                                           , STND_YEAR
                                 ) TOR
                               , TBEC_RACER_MASTER TRM
                        WHERE  TOR.RACER_NO = TRM.RACER_NO
                        AND    SEQ = 1
                        AND    TOR.TERM >= 3
                     ) WIN_COUNT -- ½Â¸®È½¼ö
                   , (
                        SELECT
                                 TOR.RACER_NO
                               , TRM.NM_KOR
                               , TOR.STND_YEAR
                               , TOR.TERM
                               , TOR.SEQ
                        FROM     (
                                    SELECT
                                             RACER_NO
                                           , STND_YEAR
                                           , MAX(TERM) TERM
                                           , RANK() OVER (PARTITION BY RACER_NO ORDER BY MAX(TERM) DESC) SEQ
                                    FROM   (
                                                SELECT
                                                         RACER_NO
                                                       , STND_YEAR
                                                       , WIN_CNT
                                    			       , PRE
                                                       , SEQ
                                                       , LEAD(SEQ) OVER (PARTITION BY RACER_NO, STND_YEAR ORDER BY SEQ) - SEQ TERM
                                                FROM   (
                                                            SELECT
                                                                     RACER_NO
                                                                   , STND_YEAR
                                                                   , WIN_CNT
                                                			       , LEAD(WIN_CNT) OVER (PARTITION BY RACER_NO, STND_YEAR ORDER BY SEQ) PRE
                                                                   , SEQ
                                                            FROM   (
                                                                        SELECT   TOR.RACER_NO
                                                                               , TOR.STND_YEAR
                                                                               , CASE WHEN TOR.RANK <= 2 AND TOR.RANK > 0 THEN 1 ELSE 0 END WIN_CNT
                                                                               , RANK() OVER (PARTITION BY TOR.RACER_NO
                                                                                                         , STND_YEAR
                                                                                                  ORDER BY TOR.RACE_DAY DESC
                                                                                                         , TOR.RACE_NO  DESC ) SEQ
                                                                        FROM   (
                                                                                    SELECT
                                                                                             STND_YEAR
                                                                                           , RACER_NO
                                                                                           , RACE_DAY
                                                                                           , RACE_NO
                                                                                           , RANK
                                                                                    FROM   TBEB_ORGAN TOR
                                                                                    WHERE  RACE_DAY BETWEEN ?
                                                                                                        AND ?
                                                                                    
                                                                                    UNION ALL
                                                                                    
                                                                                    SELECT
                                                                                             STND_YEAR
                                                                                           , RACER_NO
                                                                                           , STND_YEAR || '1231'
                                                                                           , '99'
                                                                                           , 6
                                                                                    FROM   TBEB_ORGAN TOR
                                                                                    WHERE  RACE_DAY BETWEEN ?
                                                                                                        AND ?
                                                                                    AND    RACER_NO      IN (
                                                                                                                SELECT
                                                                                                                       RACER_NO
                                                                                                                FROM   (
                                                                                                                            SELECT   TOR.RACER_NO
                                                                                                                                   , FIRST_VALUE(RANK) OVER (PARTITION BY TOR .RACER_NO 
                                                                                                                                                                    ORDER BY TOR.RACE_DAY DESC
                                                                                                                                                                           , TOR.RACE_NO  DESC ) FIRST_CNT
                                                                                                                            FROM   TBEB_ORGAN TOR
                                                                                                                            WHERE  RACE_DAY BETWEEN ?
                                                                                                                                                AND ?
                                                                                                                       )
                                                                                                                WHERE  FIRST_CNT IN ( 1, 2)
                                                                                                            )
                                                                                    GROUP BY STND_YEAR
                                                                                           , RACER_NO
                                                                               ) TOR
                                                                   )
                                                       )
                                                WHERE  (WIN_CNT = 1 AND PRE = 0)
                                                OR     (WIN_CNT = 0 AND PRE = 1)
                                                OR     (WIN_CNT = 1 AND PRE IS NULL)
                                           )
                                    WHERE WIN_CNT = 0 
                                    AND   PRE     = 1
                                    AND   TERM IS NOT NULL
                                    GROUP BY 
                                             RACER_NO
                                           , STND_YEAR
                                 ) TOR
                               , TBEC_RACER_MASTER TRM
                        WHERE  TOR.RACER_NO = TRM.RACER_NO
                        AND    SEQ = 1
                        AND    TOR.TERM >= 3
                     ) HIGH_COUNT -- ¿¬´ëÈ½¼ö
                   , (
                        SELECT
                                 TOR.RACER_NO
                               , TRM.NM_KOR
                               , TOR.STND_YEAR
                               , TOR.TERM
                               , TOR.SEQ
                        FROM     (
                                    SELECT
                                             RACER_NO
                                           , STND_YEAR
                                           , MAX(TERM) TERM
                                           , RANK() OVER (PARTITION BY RACER_NO ORDER BY MAX(TERM) DESC) SEQ
                                    FROM   (
                                                SELECT
                                                         RACER_NO
                                                       , STND_YEAR
                                                       , WIN_CNT
                                    			       , PRE
                                                       , SEQ
                                                       , LEAD(SEQ) OVER (PARTITION BY RACER_NO, STND_YEAR ORDER BY SEQ) - SEQ TERM
                                                FROM   (
                                                            SELECT
                                                                     RACER_NO
                                                                   , STND_YEAR
                                                                   , DECODE(SEQ, 1, 0, WIN_CNT) WIN_CNT
                                                			       , LEAD(WIN_CNT) OVER (PARTITION BY RACER_NO, STND_YEAR ORDER BY SEQ) PRE
                                                                   , SEQ
                                                            FROM   (
                                                                        SELECT   TOR.RACER_NO
                                                                               , TOR.STND_YEAR
                                                                               , CASE WHEN TOR.RANK >= 5 AND TOR.RANK > 0 THEN 1 ELSE 0 END WIN_CNT
                                                                               , RANK() OVER (PARTITION BY TOR.RACER_NO
                                                                                                         , STND_YEAR
                                                                                                  ORDER BY TOR.RACE_DAY DESC
                                                                                                         , TOR.RACE_NO  DESC ) SEQ
                                                                        FROM   (
                                                                                    SELECT
                                                                                             STND_YEAR
                                                                                           , RACER_NO
                                                                                           , RACE_DAY
                                                                                           , RACE_NO
                                                                                           , RANK
                                                                                    FROM   TBEB_ORGAN TOR
                                                                                    WHERE  RACE_DAY BETWEEN ?
                                                                                                        AND ?
                                                                                    
                                                                                    UNION ALL
                                                                                    
                                                                                    SELECT
                                                                                             STND_YEAR
                                                                                           , RACER_NO
                                                                                           , STND_YEAR || '1231'
                                                                                           , '99'
                                                                                           , 1
                                                                                    FROM   TBEB_ORGAN TOR
                                                                                    WHERE  RACE_DAY BETWEEN ?
                                                                                                        AND ?
                                                                                    AND    RACER_NO      IN (
                                                                                                                SELECT
                                                                                                                       RACER_NO
                                                                                                                FROM   (
                                                                                                                            SELECT   TOR.RACER_NO
                                                                                                                                   , FIRST_VALUE(RANK) OVER (PARTITION BY TOR .RACER_NO 
                                                                                                                                                                    ORDER BY TOR.RACE_DAY DESC
                                                                                                                                                                           , TOR.RACE_NO  DESC ) FIRST_CNT
                                                                                                                            FROM   TBEB_ORGAN TOR
                                                                                                                            WHERE  RACE_DAY BETWEEN ?
                                                                                                                                                AND ?
                                                                                                                       )
                                                                                                                WHERE  FIRST_CNT >= 5
                                                                                                            )
                                                                                    GROUP BY STND_YEAR
                                                                                           , RACER_NO
                                                                               ) TOR
                                                                   )
                                                       )
                                                WHERE  (WIN_CNT = 1 AND PRE = 0)
                                                OR     (WIN_CNT = 0 AND PRE = 1)
                                                OR     (WIN_CNT = 1 AND PRE IS NULL)
                                           )
                                    WHERE WIN_CNT = 0 
                                    AND   PRE     = 1
                                    AND   TERM IS NOT NULL
                                    GROUP BY 
                                             RACER_NO
                                           , STND_YEAR
                                 ) TOR
                               , TBEC_RACER_MASTER TRM
                        WHERE  TOR.RACER_NO = TRM.RACER_NO
                        AND    SEQ = 1
                        AND    TOR.TERM >= 3
                     ) LOST_COUNT -- ¿¬ÆÐÈ½¼ö
            WHERE  TRM.RACER_NO = WIN_COUNT .RACER_NO(+)
            AND    TRM.RACER_NO = HIGH_COUNT.RACER_NO(+)
            AND    TRM.RACER_NO = LOST_COUNT.RACER_NO(+)
            AND    TRM.RACER_STAT_CD IN ('001', '002')
            ORDER BY TRM.RACER_NO
        ]]>
    </query>
    <query id="tbeb_race_rank_fb004" desc="¼±¼öº° ¿¬½ÂÈ¸¼ö Á¶È¸" fetchSize="10">
        <![CDATA[
            SELECT
                     TRM.RACER_NO
                   , TRM.NM_KOR
                   , TRM.RACER_GRD_CD
                   , TRM.RACER_GRD_CD NEW_RACER_GRD
                   , WIN_COUNT .TERM   CONT_WIN_CNT
                   , HIGH_COUNT.TERM   CONT_HIGH_CNT
                   , LOST_COUNT.TERM   CONT_LOSE_CNT
            FROM     TBEC_RACER_MASTER TRM
                   , (
                        SELECT
                                 TOR.RACER_NO
                               , TRM.NM_KOR
                               , TOR.STND_YEAR
                               , TOR.TERM
                               , TOR.SEQ
                        FROM     (
                                    SELECT
                                             RACER_NO
                                           , STND_YEAR
                                           , MAX(TERM) TERM
                                           , RANK() OVER (PARTITION BY RACER_NO ORDER BY MAX(TERM) DESC) SEQ
                                    FROM   (
                                                SELECT
                                                         RACER_NO
                                                       , STND_YEAR
                                                       , WIN_CNT
                                    			       , PRE
                                                       , SEQ
                                                       , LEAD(SEQ) OVER (PARTITION BY RACER_NO, STND_YEAR ORDER BY SEQ) - SEQ TERM
                                                FROM   (
                                                            SELECT
                                                                     RACER_NO
                                                                   , STND_YEAR
                                                                   , WIN_CNT
                                                			       , LEAD(WIN_CNT) OVER (PARTITION BY RACER_NO, STND_YEAR ORDER BY SEQ) PRE
                                                                   , SEQ
                                                            FROM   (
                                                                        SELECT   TOR.RACER_NO
                                                                               , TOR.STND_YEAR
                                                                               , CASE WHEN TOR.RANK = 1 AND TOR.RANK > 0 THEN 1 ELSE 0 END WIN_CNT
                                                                               , RANK() OVER (PARTITION BY TOR.RACER_NO
                                                                                                         , STND_YEAR
                                                                                                  ORDER BY TOR.RACE_DAY DESC
                                                                                                         , TOR.RACE_NO  DESC ) SEQ
                                                                        FROM   (
                                                                                    SELECT
                                                                                             STND_YEAR
                                                                                           , RACER_NO
                                                                                           , RACE_DAY
                                                                                           , RACE_NO
                                                                                           , RANK
                                                                                    FROM   TBEB_ORGAN TOR
                                                                                    WHERE  RACE_DAY BETWEEN ?
                                                                                                        AND ?
                                                                                    
                                                                                    UNION ALL
                                                                                    
                                                                                    SELECT
                                                                                             STND_YEAR
                                                                                           , RACER_NO
                                                                                           , STND_YEAR || '1231'
                                                                                           , '99'
                                                                                           , 6
                                                                                    FROM   TBEB_ORGAN TOR
                                                                                    WHERE  RACE_DAY BETWEEN ?
                                                                                                        AND ?
                                                                                    AND    RACER_NO      IN (
                                                                                                                SELECT
                                                                                                                       RACER_NO
                                                                                                                FROM   (
                                                                                                                            SELECT   TOR.RACER_NO
                                                                                                                                   , FIRST_VALUE(RANK) OVER (PARTITION BY TOR .RACER_NO 
                                                                                                                                                                    ORDER BY TOR.RACE_DAY DESC
                                                                                                                                                                           , TOR.RACE_NO  DESC ) FIRST_CNT
                                                                                                                            FROM   TBEB_ORGAN TOR
                                                                                                                            WHERE  RACE_DAY BETWEEN ?
                                                                                                                                                AND ?
                                                                                                                       )
                                                                                                                WHERE  FIRST_CNT  = 1
                                                                                                            )
                                                                                    GROUP BY STND_YEAR
                                                                                           , RACER_NO
                                                                               ) TOR
                                                                   )
                                                       )
                                                WHERE  (WIN_CNT = 1 AND PRE = 0)
                                                OR     (WIN_CNT = 0 AND PRE = 1)
                                                OR     (WIN_CNT = 1 AND PRE IS NULL)
                                           )
                                    WHERE WIN_CNT = 0 
                                    AND   PRE     = 1
                                    AND   TERM IS NOT NULL
                                    GROUP BY 
                                             RACER_NO
                                           , STND_YEAR
                                 ) TOR
                               , TBEC_RACER_MASTER TRM
                        WHERE  TOR.RACER_NO = TRM.RACER_NO
                        AND    SEQ = 1
                        AND    TOR.TERM >= 3
                     ) WIN_COUNT -- ½Â¸®È½¼ö
                   , (
                        SELECT
                                 TOR.RACER_NO
                               , TRM.NM_KOR
                               , TOR.STND_YEAR
                               , TOR.TERM
                               , TOR.SEQ
                        FROM     (
                                    SELECT
                                             RACER_NO
                                           , STND_YEAR
                                           , MAX(TERM) TERM
                                           , RANK() OVER (PARTITION BY RACER_NO ORDER BY MAX(TERM) DESC) SEQ
                                    FROM   (
                                                SELECT
                                                         RACER_NO
                                                       , STND_YEAR
                                                       , WIN_CNT
                                    			       , PRE
                                                       , SEQ
                                                       , LEAD(SEQ) OVER (PARTITION BY RACER_NO, STND_YEAR ORDER BY SEQ) - SEQ TERM
                                                FROM   (
                                                            SELECT
                                                                     RACER_NO
                                                                   , STND_YEAR
                                                                   , WIN_CNT
                                                			       , LEAD(WIN_CNT) OVER (PARTITION BY RACER_NO, STND_YEAR ORDER BY SEQ) PRE
                                                                   , SEQ
                                                            FROM   (
                                                                        SELECT   TOR.RACER_NO
                                                                               , TOR.STND_YEAR
                                                                               , CASE WHEN TOR.RANK <= 2 AND TOR.RANK > 0 THEN 1 ELSE 0 END WIN_CNT
                                                                               , RANK() OVER (PARTITION BY TOR.RACER_NO
                                                                                                         , STND_YEAR
                                                                                                  ORDER BY TOR.RACE_DAY DESC
                                                                                                         , TOR.RACE_NO  DESC ) SEQ
                                                                        FROM   (
                                                                                    SELECT
                                                                                             STND_YEAR
                                                                                           , RACER_NO
                                                                                           , RACE_DAY
                                                                                           , RACE_NO
                                                                                           , RANK
                                                                                    FROM   TBEB_ORGAN TOR
                                                                                    WHERE  RACE_DAY BETWEEN ?
                                                                                                        AND ?
                                                                                    
                                                                                    UNION ALL
                                                                                    
                                                                                    SELECT
                                                                                             STND_YEAR
                                                                                           , RACER_NO
                                                                                           , STND_YEAR || '1231'
                                                                                           , '99'
                                                                                           , 6
                                                                                    FROM   TBEB_ORGAN TOR
                                                                                    WHERE  RACE_DAY BETWEEN ?
                                                                                                        AND ?
                                                                                    AND    RACER_NO      IN (
                                                                                                                SELECT
                                                                                                                       RACER_NO
                                                                                                                FROM   (
                                                                                                                            SELECT   TOR.RACER_NO
                                                                                                                                   , FIRST_VALUE(RANK) OVER (PARTITION BY TOR .RACER_NO 
                                                                                                                                                                    ORDER BY TOR.RACE_DAY DESC
                                                                                                                                                                           , TOR.RACE_NO  DESC ) FIRST_CNT
                                                                                                                            FROM   TBEB_ORGAN TOR
                                                                                                                            WHERE  RACE_DAY BETWEEN ?
                                                                                                                                                AND ?
                                                                                                                       )
                                                                                                                WHERE  FIRST_CNT IN ( 1, 2)
                                                                                                            )
                                                                                    GROUP BY STND_YEAR
                                                                                           , RACER_NO
                                                                               ) TOR
                                                                   )
                                                       )
                                                WHERE  (WIN_CNT = 1 AND PRE = 0)
                                                OR     (WIN_CNT = 0 AND PRE = 1)
                                                OR     (WIN_CNT = 1 AND PRE IS NULL)
                                           )
                                    WHERE WIN_CNT = 0 
                                    AND   PRE     = 1
                                    AND   TERM IS NOT NULL
                                    GROUP BY 
                                             RACER_NO
                                           , STND_YEAR
                                 ) TOR
                               , TBEC_RACER_MASTER TRM
                        WHERE  TOR.RACER_NO = TRM.RACER_NO
                        AND    SEQ = 1
                        AND    TOR.TERM >= 3
                     ) HIGH_COUNT -- ¿¬´ëÈ½¼ö
                   , (
                        SELECT
                                 TOR.RACER_NO
                               , TRM.NM_KOR
                               , TOR.STND_YEAR
                               , TOR.TERM
                               , TOR.SEQ
                        FROM     (
                                    SELECT
                                             RACER_NO
                                           , STND_YEAR
                                           , MAX(TERM) TERM
                                           , RANK() OVER (PARTITION BY RACER_NO ORDER BY MAX(TERM) DESC) SEQ
                                    FROM   (
                                                SELECT
                                                         RACER_NO
                                                       , STND_YEAR
                                                       , WIN_CNT
                                    			       , PRE
                                                       , SEQ
                                                       , LEAD(SEQ) OVER (PARTITION BY RACER_NO, STND_YEAR ORDER BY SEQ) - SEQ TERM
                                                FROM   (
                                                            SELECT
                                                                     RACER_NO
                                                                   , STND_YEAR
                                                                   , DECODE(SEQ, 1, 0, WIN_CNT) WIN_CNT
                                                			       , LEAD(WIN_CNT) OVER (PARTITION BY RACER_NO, STND_YEAR ORDER BY SEQ) PRE
                                                                   , SEQ
                                                            FROM   (
                                                                        SELECT   TOR.RACER_NO
                                                                               , TOR.STND_YEAR
                                                                               , CASE WHEN TOR.RANK >= 5 AND TOR.RANK > 0 THEN 1 ELSE 0 END WIN_CNT
                                                                               , RANK() OVER (PARTITION BY TOR.RACER_NO
                                                                                                         , STND_YEAR
                                                                                                  ORDER BY TOR.RACE_DAY DESC
                                                                                                         , TOR.RACE_NO  DESC ) SEQ
                                                                        FROM   (
                                                                                    SELECT
                                                                                             STND_YEAR
                                                                                           , RACER_NO
                                                                                           , RACE_DAY
                                                                                           , RACE_NO
                                                                                           , RANK
                                                                                    FROM   TBEB_ORGAN TOR
                                                                                    WHERE  RACE_DAY BETWEEN ?
                                                                                                        AND ?
                                                                                    
                                                                                    UNION ALL
                                                                                    
                                                                                    SELECT
                                                                                             STND_YEAR
                                                                                           , RACER_NO
                                                                                           , STND_YEAR || '1231'
                                                                                           , '99'
                                                                                           , 1
                                                                                    FROM   TBEB_ORGAN TOR
                                                                                    WHERE  RACE_DAY BETWEEN ?
                                                                                                        AND ?
                                                                                    AND    RACER_NO      IN (
                                                                                                                SELECT
                                                                                                                       RACER_NO
                                                                                                                FROM   (
                                                                                                                            SELECT   TOR.RACER_NO
                                                                                                                                   , FIRST_VALUE(RANK) OVER (PARTITION BY TOR .RACER_NO 
                                                                                                                                                                    ORDER BY TOR.RACE_DAY DESC
                                                                                                                                                                           , TOR.RACE_NO  DESC ) FIRST_CNT
                                                                                                                            FROM   TBEB_ORGAN TOR
                                                                                                                            WHERE  RACE_DAY BETWEEN ?
                                                                                                                                                AND ?
                                                                                                                       )
                                                                                                                WHERE  FIRST_CNT >= 5
                                                                                                            )
                                                                                    GROUP BY STND_YEAR
                                                                                           , RACER_NO
                                                                               ) TOR
                                                                   )
                                                       )
                                                WHERE  (WIN_CNT = 1 AND PRE = 0)
                                                OR     (WIN_CNT = 0 AND PRE = 1)
                                                OR     (WIN_CNT = 1 AND PRE IS NULL)
                                           )
                                    WHERE WIN_CNT = 0 
                                    AND   PRE     = 1
                                    AND   TERM IS NOT NULL
                                    GROUP BY 
                                             RACER_NO
                                           , STND_YEAR
                                 ) TOR
                               , TBEC_RACER_MASTER TRM
                        WHERE  TOR.RACER_NO = TRM.RACER_NO
                        AND    SEQ = 1
                        AND    TOR.TERM >= 3
                     ) LOST_COUNT -- ¿¬ÆÐÈ½¼ö
                   , (
                        SELECT RACER_NO
                        FROM   TBEB_ORGAN
                        WHERE  STND_YEAR = ?
                        AND    MBR_CD    = ?
                        AND    TMS       = ?
                        GROUP BY RACER_NO
                     ) TOR -- ¿¬ÆÐÈ½¼ö
            WHERE  TRM.RACER_NO = WIN_COUNT .RACER_NO(+)
            AND    TRM.RACER_NO = HIGH_COUNT.RACER_NO(+)
            AND    TRM.RACER_NO = LOST_COUNT.RACER_NO(+)
            AND    TRM.RACER_NO = TOR       .RACER_NO
            ORDER BY TRM.RACER_NO
        ]]>
    </query>
</queryMap>