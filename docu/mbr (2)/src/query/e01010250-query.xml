<?xml version="1.0" encoding='EUC-KR'?>

<queryMap desc="E01010250(개인정보처리메뉴 권한 관리)">
  <query id="e01010250_s01" desc="메뉴그룹조회" fetchSize="10">
        <![CDATA[
            SELECT A.*
              FROM (SELECT TM.MN_ID
				          , TM.MN_NM
				          , TM.UP_MN_ID
				          , (
				             SELECT TMC.MN_NM 
				               FROM TBEA_MN TMC
				              WHERE TMC.MN_ID = TM.UP_MN_ID
				             ) UP_MN_NM
				          , TM.SCRN_ID   
				          , '0' AS CHK  
				          , RANK() OVER (PARTITION BY UP_MN_ID ORDER BY RR) SEQ
				          , TM.PERSONAL_DATA_MN
				     FROM (
				           SELECT MN_ID
				                  , MN_NM
				                  , SUBSTR(UP_MN_ID, 0, 3) || '000000' UP_MN_ID
				                  , SCRN_ID
				                  , ROWNUM RR
				                  , PERSONAL_DATA_MN
				             FROM TBEA_MN
				            START WITH UP_MN_ID = '000000000'
				            CONNECT BY UP_MN_ID = PRIOR MN_ID
				            ORDER SIBLINGS BY UP_MN_ID , ORD_NO
				           ) TM
				    ORDER BY TM.RR
				    ) A
			 WHERE A.SCRN_ID IS NOT NULL
			   AND A.PERSONAL_DATA_MN = 'Y'
			   AND A.UP_MN_ID = NVL(?, A.UP_MN_ID)
        ]]>
    </query>

 
    <query id="e01010250_s02" desc="사용자 조회" fetchSize="10">
        <![CDATA[
            SELECT  
                      A.USER_ID          -- 사용자ID     
                    , A.USER_NM        -- 사용자명         
                    , A.PSWD           -- 비밀번호
                    , A.DEPT_CD        -- 부서코드
                    , A.DEPT_NM       -- 부서이름
                    , A.TEAM_CD       -- 팀코드
                    , A.TEAM_NM       -- 팀이름
                    , A.FLOC          -- 직위코드
                    , A.FGRADE            -- 직위         
                    , A.TEL_NO         -- 전화번호         
                    , A.EMAIL         -- 이메일       
                    , '0' AS CHK
                    ,NVL(B.SRCH_YN,0) SRCH_YN
                    ,NVL(B.PERSONAL_YN,0) PERSONAL_YN
                    , B.PERSONAL_MN_IP
                    , B.STR_DT_TM
              FROM  VWEA_USER A, 
                    (SELECT 
                              USER_ID    
                            , MN_ID
                            , STR_DT_TM    
                            , DECODE(SRCH_YN, 'Y', 1, 0) SRCH_YN    
                            , DECODE(PERSONAL_YN, 'Y', 1, 0) PERSONAL_YN 
                            , PERSONAL_MN_IP
                            , INST_ID    
                            , INST_DTM    
                            , UPDT_ID    
                            , UPDT_DTM    
                       FROM TBEA_MN_AUTH_HIST    
                      WHERE MN_ID = ?
                      AND   TO_CHAR(SYSDATE, 'YYYYMMDDHH24MI') BETWEEN STR_DT_TM AND END_DT_TM
                    ) B
             WHERE  A.USER_ID= B.USER_ID(+)
               AND  SRCH_YN = '1'
               AND A.TEAM_CD LIKE  '%' || NVL(? , A.TEAM_CD) || '%' 
               AND A.USER_NM = NVL(?, A.USER_NM)
             ORDER BY A.TEAM_CD, A.FGRADE, A.USER_ID      
        ]]>
    </query>  
    
    <query id="tbea_mn_grp" desc="메뉴그룹조회(조건)" fetchSize="10">
		<![CDATA[
			SELECT
					 MN_ID               -- 메뉴아이디
				   , MN_NM                  -- 메뉴명
				   , ORD_NO                 -- 순서번호
				   , UP_MN_ID               -- 상위메뉴ID
				   , SCRN_ID  -- 화면ID
				   , URL                    -- 메뉴URL
				   , RMK                    -- 비고
			FROM  TBEA_MN
			WHERE  UP_MN_ID = '000000000'
			ORDER BY ORD_NO
		]]>
	</query>
	
	<query id="e01010250_i01" desc="권한 추가" fetchSize="10">
        <![CDATA[
			INSERT 
			       INTO TBEA_MN_AUTH_HIST (
			      USER_ID
			    , MN_ID
			    , STR_DT_TM
			    , END_DT_TM
			    , PERSONAL_YN
			    , INST_ID
			    , INST_DTM
			    , PERSONAL_MN_IP
			    , PERSONAL_AUTH_ID
			    , PERSONAL_AUTH_CHK
			    , PERSONAL_AUTH_DT
			    , SRCH_YN
			) VALUES (
			      ?                 -- USER_ID
			    , ?                 -- MN_ID
			    , ? 				-- 작업기준일시
			    , '299912312359'
			    , ?                 -- PERSONAL_YN
			    , ?                 -- INST_ID			    
			    , SYSDATE           -- INST_DT
			    , ?					-- PERSONAL_MN_IP
			    , ?					-- PERSONAL_AUTH_ID
			    , ?					-- PERSONAL_AUTH_CHK
			    , SYSDATE			-- PERSONAL_AUTH_DT
			    , ?					-- SRCH_YN
			)
        ]]>
    </query> 
    
    <query id="e01010250_i02" desc="개인정보 처리내역 저장" fetchSize="10">
        <![CDATA[
			INSERT 
			  INTO TBEA_PERSONAL_MN_AUTH_HIST (
			            SEQ_NO
			          , PERSONAL_MN_ID
			          , PERSONAL_AUTH_ID
			          , PERSONAL_AUTH_CHK
			          , PERSONAL_AUTH_DT
			          , USER_ID
			          , PERSONAL_MN_IP
				) VALUES (
				        (SELECT NVL(MAX(SEQ_NO),0)+1 FROM TBEA_PERSONAL_MN_AUTH_HIST)         -- SEQ_NO
				      , ? 		  -- PERSONAL_MN_ID
				      , ?		  -- PERSONAL_AUTH_ID
				      , ?		  -- PERSONAL_AUTH_CHK
				      , SYSDATE	  -- PERSONAL_AUTH_DT
				      , ?		  -- USER_ID
				      , ?		  -- PERSONAL_MN_IP
			)
        ]]>
    </query>
    
    <query id="e01010250_u01" desc="권한 수정" fetchSize="10">
        <![CDATA[
			UPDATE 
			       TBEA_MN_AUTH_HIST
			SET    PERSONAL_YN = ?				-- 개인정보처리메뉴 사용여부(Y:사용, N:미사용)
			     , PERSONAL_MN_IP = ?			-- 개인정보처리메뉴 사용자 IP
			     , PERSONAL_AUTH_ID = ?			-- 개인정보처리메뉴 권한부여자
			     , PERSONAL_AUTH_CHK = ?		-- 개인정보처리메뉴 권한체크(Y:부여, N:말소)
			     , PERSONAL_AUTH_DT = SYSDATE	-- 개인정보처리메뉴 권한부여일시 
			     , UPDT_ID = ?					-- 수정자 사번
			     , UPDT_DTM = SYSDATE			-- 수정일시
			WHERE  USER_ID = ?					-- 사용자 사번
			AND    MN_ID   = ?					-- 메뉴ID
			AND    STR_DT_TM  = ?				-- 시작일시분
        ]]>
    </query> 
    
</queryMap>