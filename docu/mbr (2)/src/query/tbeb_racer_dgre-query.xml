<?xml version="1.0" encoding='EUC-KR'?>
<queryMap desc="tbeb_racer_dgre(선수등급)">
    <query id="tbeb_racer_dgre_fb001" desc="선수등급조회" fetchSize="10">
        <![CDATA[
			SELECT 
					  0 CHK
				    , RACER_NO                                      -- 등록번호
				    , NM_KOR                                        -- 성명
				    , RACER_GRD_CD                                  -- 선수등급
				    , NEW_RACER_GRD                                 -- 변경등급
				    , AVG_SCR                                       -- 평균득점
				    , AVG_STRT_TM                                   -- 평균ST
				    , DGRE_JUDG_F_CNT                               -- 연간F횟수
				    , DGRE_JUDG_L_CNT                               -- 연간L횟수
				    , BAS_SCR                                       -- 기준점수
				    , RACE_ESC_1_CNT                                -- 출주제외1
				    , RACE_ESC_2_CNT                                -- 출주제외2
				    , FOUL_ELIM_CNT                                 -- 반칙실격
				    , ELIM_CNT                                      -- 실격
				    , FOUL_WARN_CNT                                 -- 반칙경고
				    , WARN_CNT                                      -- 경고
				    , ATTEN_CNT                                     -- 주의
				    , RACER_STAT_CD                                 -- 선수구분
				    , RUN_CNT                                       -- 출전횟수
				    , RACE_DAY_CNT                                  -- 출전일수
				    , RACE_CNT                                      -- 출주횟수
				    , GEN_RACE                                      -- 일반경주
				    , SPC_RACE                                      -- 특선경주
				    , AVG_RANK_SCR                                  -- 평균착순점
				    , WIN_RATIO                                     -- 승률
				    , HIGH_RANK_RATIO                               -- 연간연대율
				    , HIGH_3_RANK_RATIO                             -- 연간삼연대율
				    , AVG_ACDNT_SCR                                 -- 평균사고점
				    , NEW_RANKING
			FROM    (SELECT 
						      RACER_NO                                      -- 등록번호
						    , NM_KOR                                        -- 성명
						    , RACER_GRD_CD                                  -- 선수등급
						    , NEW_RACER_GRD                                 -- 변경등급
						    , AVG_SCR                                       -- 평균득점
						    , AVG_STRT_TM                                   -- 평균ST
						    , DGRE_JUDG_F_CNT                               -- 연간F횟수
						    , DGRE_JUDG_L_CNT                               -- 연간L횟수
						    , BAS_SCR                                       -- 기준점수
						    , RACE_ESC_1_CNT                                -- 출주제외1
						    , RACE_ESC_2_CNT                                -- 출주제외2
						    , FOUL_ELIM_CNT                                 -- 반칙실격
						    , ELIM_CNT                                      -- 실격
						    , FOUL_WARN_CNT                                 -- 반칙경고
						    , WARN_CNT                                      -- 경고
						    , ATTEN_CNT                                     -- 주의
						    , RACER_STAT_CD                                 -- 선수구분
						    , RUN_CNT                                       -- 출전횟수
						    , RACE_DAY_CNT                                  -- 출전일수
						    , RACE_CNT                                      -- 출주횟수
						    , GEN_RACE                                      -- 일반경주
						    , SPC_RACE                                      -- 특선경주
						    , AVG_RANK_SCR                                  -- 평균착순점
						    , WIN_RATIO                                     -- 승률
						    , HIGH_RANK_RATIO                               -- 연간연대율
						    , HIGH_3_RANK_RATIO                             -- 연간삼연대율
						    , AVG_ACDNT_SCR                                 -- 평균사고점
						    , ROW_NUMBER() OVER(PARTITION BY NEW_RACER_GRD ORDER BY AVG_RANK_SCR DESC) NEW_RANKING
						FROM (SELECT DISTINCT
						              A.RACER_NO                                        -- 등록번호
						            , NM_KOR                                            -- 성명
						            , RACER_GRD_CD                                      -- 선수등급
						            , B.NEW_RACER_GRD                                   -- 변경등급
						            , B.AVG_SCR                                         -- 평균득점
						            , B.AVG_STRT_TM                                     -- 평균ST
						            , B.DGRE_JUDG_F_CNT                                 -- 연간F횟수
						            , B.DGRE_JUDG_L_CNT                                 -- 연간L횟수
						            , B.BAS_SCR                                         -- 기준점수
						            , B.RACE_ESC_1_CNT                                  -- 출주제외1
						            , B.RACE_ESC_2_CNT                                  -- 출주제외2
						            , B.FOUL_ELIM_CNT                                   -- 반칙실격
						            , B.ELIM_CNT                                        -- 실격
						            , B.FOUL_WARN_CNT                                   -- 반칙경고
						            , B.WARN_CNT                                        -- 경고
						            , B.ATTEN_CNT                                       -- 주의
						            , A.RACER_STAT_CD                                   -- 선수구분
						            , B.RUN_CNT                                         -- 출전횟수
						            , B.RACE_DAY_CNT                                    -- 출전일수
						            , RACE_CNT                                          -- 출주횟수
						            , A.GEN_RACE                                        -- 일반경주
						            , A.SPC_RACE                                        -- 특선경주
						            , B.AVG_RANK_SCR                              -- 평균착순점
						            , B.WIN_RATIO                             -- 승률
						            , B.HIGH_RANK_RATIO                       -- 연간연대율
						            , B.HIGH_3_RANK_RATIO                     -- 연간삼연대율
						            , B.AVG_ACDNT_SCR                           -- 평균사고점
						        FROM (SELECT
						                      NM_KOR                                    -- 선수명
						                    , RACER_GRD_CD                              -- 선수등급
						                    , X.RACER_NO                                -- 선수번호
						                    , SUM(GEN_RACE) GEN_RACE                    -- 일반경주
						                    , SUM(SPC_RACE) SPC_RACE                    -- 특선경주
						                    , X.STND_YEAR                               -- 기준년도
						                    , X.TMS                                     -- 회차
						                    , X.DAY_ORD                                 -- 일차
						                    , X.MBR_CD                                  -- 경정장코드
						                    , X.RACER_STAT_CD
						                FROM (SELECT  
						                              C.NM_KOR                          -- 선수명
						                            , C.RACER_GRD_CD                    -- 선수등급
						                            , C.RACER_NO                        -- 선수번호
						                            , (CASE WHEN A.RACE_DGRE_CD = '101' THEN 1 ELSE 0 END) GEN_RACE -- 일반경주
						                            , (CASE WHEN A.RACE_DGRE_CD = '501' THEN 1 ELSE 0 END) SPC_RACE -- 특선경주
						                            , A.STND_YEAR                       -- 기준년도
						                            , A.TMS                             -- 회차
						                            , A.DAY_ORD                         -- 일차
						                            , A.MBR_CD                          -- 경정장코드
						                            , C.RACER_STAT_CD                   -- 선수구분코드
						                        FROM  TBEB_RACE A
						                            , (SELECT 
						                                      RACER_NO
						                                    , MBR_CD
						                                    , TMS
						                                    , DAY_ORD
						                                    , STND_YEAR
						                                FROM TBEB_ORGAN 
						                                GROUP BY 
						                                      STND_YEAR
						                                    , MBR_CD
						                                    , TMS
						                                    , DAY_ORD
						                                    , RACER_NO) B
						                            , TBEC_RACER_MASTER C
						                        WHERE A.STND_YEAR       = B.STND_YEAR
						                        AND   A.MBR_CD          = B.MBR_CD
						                        AND   A.TMS             = B.TMS
						                        AND   A.DAY_ORD         = B.DAY_ORD
						                        AND   B.RACER_NO        = C.RACER_NO
						                        --AND   C.RACER_NO        = '01-021'
						                        ) X
						                        , TBEB_RACER_RECD_ACCU_SUM D
						                WHERE X.STND_YEAR   = D.STND_YEAR(+)
						                AND   X.MBR_CD      = D.MBR_CD(+)
						                AND   X.TMS         = D.TMS(+)
						                AND   X.RACER_NO    = D.RACER_NO(+)
						                AND   D.ST_MTHD_CD = '000' --ST방식전체설정
						                GROUP BY NM_KOR
						                    , RACER_GRD_CD
						                    , X.RACER_NO
						                    , X.STND_YEAR
						                    , X.TMS
						                    , X.DAY_ORD
						                    , X.MBR_CD
						                    , X.RACER_STAT_CD) A
						                , (SELECT
						                        STND_YEAR                                           -- 기준년도
						                      , MBR_CD                                              -- 경정장코드
						                      , TMS                                                 -- 회차
						                      , RACER_NO                                            -- 선수번호                  
						                      , RUN_CNT                                           -- 출전횟수
						                      , RACE_DAY_CNT                                          -- 출전일수
						                      , RACE_CNT                                            -- 출주횟수
						                      , AVG_RANK_SCR                                  -- 평균착순점
						                      , WIN_RATIO                                 -- 승률
						                      , HIGH_RANK_RATIO                           -- 연간연대율
						                      , HIGH_3_RANK_RATIO                         -- 연간삼연대율
						                      , AVG_ACDNT_SCR                               -- 평균사고점
						                      , AVG_SCR                                             -- 평균득점
						                      , AVG_STRT_TM                                   -- 연간ST
						                      , DGRE_JUDG_F_CNT                                     -- 연간F횟수
						                      , DGRE_JUDG_L_CNT                                     -- 연간L횟수
						                      , BAS_SCR                                             -- 기준점수
						                      , RACE_ESC_1_CNT                                      -- 출주제외1
						                      , RACE_ESC_2_CNT                                      -- 출주제외2
						                      , FOUL_ELIM_CNT                                       -- 반칙실격
						                      , ELIM_CNT                                            -- 실격
						                      , FOUL_WARN_CNT                                       -- 반칙경고
						                      , WARN_CNT                                            -- 경고
						                      , ATTEN_CNT                                           -- 주의        
			                                  , (CASE WHEN ( AVG_ACDNT_SCR < ? AND RACE_CNT < ? ) 
								                        THEN 'B2' 
								                        ELSE (
								                          CASE  WHEN (    AVG_ACDNT_SCR     >= ? AND AVG_ACDNT_SCR    < ?
								                                      AND RACE_CNT          >= ? AND RACE_CNT         < ?
								                                      AND HIGH_RANK_RATIO   >= ? AND HIGH_RANK_RATIO  < ? ) THEN ?
								                                ELSE 'B2' END                   
								                             ) -- END ELSE
								                END) NEW_RACER_GRD
			
						                    FROM (SELECT
						                                STND_YEAR                                           -- 기준년도
						                              , MBR_CD                                              -- 경정장코드
						                              , TMS                                                 -- 회차
						                              , RACER_NO                                            -- 선수번호                  
						                              , SUM(RUN_CNT) RUN_CNT                                             -- 출전횟수
						                              , SUM(RACE_DAY_CNT) RACE_DAY_CNT                                        -- 출전일수
						                              , SUM(RACE_CNT) RACE_CNT                                            -- 출주횟수
						                              , SUM(AVG_RANK_SCR) AVG_RANK_SCR                                  -- 평균착순점
						                              , SUM(WIN_RATIO) WIN_RATIO                                 -- 승률
						                              , SUM(HIGH_RANK_RATIO) HIGH_RANK_RATIO                           -- 연간연대율
						                              , SUM(HIGH_3_RANK_RATIO) HIGH_3_RANK_RATIO                         -- 연간삼연대율
						                              --, SUM(AVG_ACDNT_SCR) AVG_ACDNT_SCR                                -- 평균사고점
						                              , SUM(B.AVG_ACDNT_SCR) AVG_ACDNT_SCR
						                              , SUM(AVG_SCR) AVG_SCR                                       -- 평균득점
						                              , SUM(AVG_STRT_TM) AVG_STRT_TM                                   -- 연간ST
						                              , SUM(DGRE_JUDG_F_CNT) DGRE_JUDG_F_CNT                -- 연간F횟수
						                              , SUM(DGRE_JUDG_L_CNT) DGRE_JUDG_L_CNT                -- 연간L횟수
						                              , SUM(1) AS BAS_SCR                                       -- 기준점수
						                              , SUM(RACE_ESC_1_CNT) RACE_ESC_1_CNT                  -- 출주제외1
						                              , SUM(RACE_ESC_2_CNT) RACE_ESC_2_CNT                  -- 출주제외2
						                              , SUM(FOUL_ELIM_CNT) FOUL_ELIM_CNT                    -- 반칙실격
						                              , SUM(ELIM_CNT) ELIM_CNT                              -- 실격
						                              , SUM(FOUL_WARN_CNT) FOUL_WARN_CNT                    -- 반칙경고
						                              , SUM(WARN_CNT) WARN_CNT                              -- 경고
						                              , SUM(ATTEN_CNT) ATTEN_CNT                            -- 주의
						                        FROM TBEB_RACER_RECD_ACCU_SUM
						                            , (SELECT ROUND(dbms_random.VALUE(1,10),0) AVG_ACDNT_SCR FROM DUAL) B
						                        WHERE ST_MTHD_CD = '000' --ST방식전체설정
						                        GROUP BY 
						                              STND_YEAR
						                            , MBR_CD
						                            , TMS
						                            , RACER_NO
						                            ) XX           
						                 ) B                            
						        WHERE A.TMS         =   B.TMS
						        AND   A.RACER_NO    =   B.RACER_NO
						        
						        ORDER BY B.NEW_RACER_GRD) X
						) XX
						        
			WHERE NEW_RANKING <= ?
        ]]>
    </query> 
    
    <query id="tbeb_racer_dgre_fb002" desc="선수등급조회" fetchSize="10">
        <![CDATA[
			SELECT
			      A.STND_YEAR
			    , A.TMS
			    , A.DAY_ORD
			    , A.RACE_NO
			    , A.RANK
			    , CASE WHEN LENGTH(A.ENTRY_COURSE) = 1 
			            THEN '00' || TO_CHAR(A.ENTRY_COURSE)
			            ELSE TO_CHAR(A.ENTRY_COURSE)
			      END ENTRY_COURSE
			    , SUM(C.RACE_SCR) RACE_SCR
			    , SUM(E.ACDNT_SCR) ACDNT_SCR
			FROM  TBEB_ORGAN            A
			    , TBEB_RACE             B
			    , TBEB_RANK_SCR         C
			    , TBED_RACE_VOIL_ACT    D
			    , TBEB_ACDNT_SCR        E
			    
			WHERE   A.STND_YEAR     = B.STND_YEAR
			AND     A.MBR_CD        = B.MBR_CD
			AND     A.TMS           = B.TMS
			AND     A.DAY_ORD       = B.DAY_ORD
			AND     A.RACE_NO       = B.RACE_NO
			AND     B.STND_YEAR     = C.STND_YEAR
			AND     B.RACE_DGRE_CD  = C.RACE_DGRE_CD
			AND     A.STND_YEAR     = D.STND_YEAR(+)
			AND     A.MBR_CD        = D.MBR_CD(+)
			AND     A.TMS           = D.TMS(+)
			AND     A.DAY_ORD       = D.DAY_ORD(+)
			AND     A.RACE_NO       = D.RACE_NO(+)
			AND     A.RACE_REG_NO   = D.RACE_REG_NO(+)
			AND     D.VOIL_CD       = E.VOIL_CD(+)
			AND     A.RACER_NO      = ?
			GROUP BY
			      A.STND_YEAR
			    , A.TMS
			    , A.DAY_ORD
			    , A.RACE_NO
			    , A.RANK
			    , A.ENTRY_COURSE
			ORDER BY STND_YEAR, TMS, DAY_ORD, RACE_NO
        ]]>
    </query>     
    <query id="tbeb_racer_dgre_ib001" desc="선수등급입력" fetchSize="10">
        <![CDATA[
			INSERT INTO TBEB_RACER_GRD (
			         RACER_NO
			       , CHG_DT
			       , RACER_GRD_CD
			       , RMK
			       , INST_ID
			       , INST_DTM
			       , UPDT_ID
			       , UPDT_DTM
			) VALUES (
			         ?         --      RACER_NO
			       , ?         --      CHG_DAY
			       , ?         --      RACER_GRD_CD
			       , ?         --      RMK
			       , ?         --      INST_ID
			       , SYSDATE   --      INST_DTM
			       , ?         --      UPDT_ID
			       , SYSDATE   --      UPDT_DTM
			)
        ]]>
    </query>         
    <query id="tbeb_racer_dgre_ub001" desc="선수등급수정" fetchSize="10">
        <![CDATA[
			UPDATE TBEB_RACER_GRD SET
			         RACER_GRD_CD = ?
			       , RMK          = ?
			       , UPDT_ID      = ?
			       , UPDT_DTM     = SYSDATE
			WHERE  RACER_NO       = ?
			AND    CHG_DT         = ?
        ]]>
    </query>         
</queryMap>