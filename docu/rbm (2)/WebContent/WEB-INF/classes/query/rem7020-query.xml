<?xml version="1.0" encoding='EUC-KR'?>

<queryMap desc="rem7020(지정좌석실 운영실적)">
  
    <query id="rem7020_s01" desc="지정좌석실 운영실적 조회" fetchSize="10">
      <![CDATA[
            WITH SEAT_NUM AS (	/*rem7020_s01 */--좌석수
				SELECT BRNC_CD COMM_NO, SEAT_NUM_NORMAL, SEAT_NUM_FIXED, SEAT_NUM_GREEN
				FROM TBRA_COMM_DESC
				WHERE 1=1
				AND BRNC_CD NOT IN ('29') --교차제외
				AND STND_YEAR = SUBSTR(?,0,4)
			),
			ENTER_NUM_FIXED AS (  --지정좌석실 입장인원
				SELECT TRADE_DATE, COMM_NO, CNT ENTER_FIXED FROM (
					SELECT ISSUE_DT TRADE_DATE, COMM_NO, COUNT(SEQ_NO) CNT FROM TBRC_FS_TRADE --지정좌석실
					GROUP BY ISSUE_DT, COMM_NO
					UNION ALL
					SELECT ISSUE_DT TRADE_DATE, '00' COMM_NO, SUM(QTY) QTY FROM TBRC_FS_TRADE_KM --지정좌석실광명
					GROUP BY ISSUE_DT
					UNION ALL
					SELECT  /* 경주사업 지정좌석관리(대전, 올림픽지점) */
                    	 SALES_DT TRADE_DATE
						,BRNC_CD COMM_NO
						,SUM(CASE WHEN REFUND_YN = 'N' THEN 1 ELSE 0 END) QTY
                    FROM   TBRB_APPO_SEAT_MANA
                    GROUP BY SALES_DT, BRNC_CD
				)
				WHERE TRADE_DATE BETWEEN ? AND ?
			),
			SALES_FIXED AS (	--지정좌석실 매출액
				SELECT
					RACE_DAY, COMM_NO,
					SUM(AMT) SOLD_AMT
				FROM TBJI_PC_TELMP_FIXEDSEAT
				WHERE 1=1
				AND RACE_DAY BETWEEN ? AND ?
				AND GRN_ZN_CD IN ('002','003')
				GROUP BY RACE_DAY, COMM_NO
			)
			
			SELECT
				DECODE(COMM_NO, '98', '09', COMM_NO) ORD_NO,
				COMM_NO,
				FC_CODE_NM('018',COMM_NO) COMM_NM,
				SEAT_NUM_FIXED,
			
				ENTER_FIXED_TOT,
				SOLD_AMT_TOT,
				ROUND(ENTER_FIXED_TOT/SALES_DAY_CNT,2) ENTER_FIXED_AVG,
				ROUND(SOLD_AMT_TOT/SALES_DAY_CNT,2) SOLD_AMT_AVG,
				SALES_DAY_CNT,
			
			
				ENTER_FIXED_WED,
				ROUND(ENTER_FIXED_WED/ENTER_FIXED_TOT*100,2) ENTER_FIXED_WED_RATIO,
				ENTER_FIXED_THU,
				ROUND(ENTER_FIXED_THU/ENTER_FIXED_TOT*100,2) ENTER_FIXED_THU_RATIO,
				ENTER_FIXED_FRI,
				ROUND(ENTER_FIXED_FRI/ENTER_FIXED_TOT*100,2) ENTER_FIXED_FRI_RATIO,
				ENTER_FIXED_SAT,
				ROUND(ENTER_FIXED_SAT/ENTER_FIXED_TOT*100,2) ENTER_FIXED_SAT_RATIO,
				ENTER_FIXED_SUN,
				ROUND(ENTER_FIXED_SUN/ENTER_FIXED_TOT*100,2) ENTER_FIXED_SUN_RATIO,
			
				SOLD_AMT_WED,
				ROUND(SOLD_AMT_WED/SOLD_AMT_TOT*100,2) SOLD_AMT_WED_RATIO,
				SOLD_AMT_THU,
				ROUND(SOLD_AMT_THU/SOLD_AMT_TOT*100,2) SOLD_AMT_THU_RATIO,
				SOLD_AMT_FRI,
				ROUND(SOLD_AMT_FRI/SOLD_AMT_TOT*100,2) SOLD_AMT_FRI_RATIO,
				SOLD_AMT_SAT,
				ROUND(SOLD_AMT_SAT/SOLD_AMT_TOT*100,2) SOLD_AMT_SAT_RATIO,
				SOLD_AMT_SUN,
				ROUND(SOLD_AMT_SUN/SOLD_AMT_TOT*100,2) SOLD_AMT_SUN_RATIO
			FROM (
				SELECT S2.COMM_NO, SEAT_NUM_FIXED,
					ENTER_FIXED_TOT, ENTER_FIXED_WED, ENTER_FIXED_THU, ENTER_FIXED_FRI, ENTER_FIXED_SAT, ENTER_FIXED_SUN,
					SOLD_AMT_TOT, SOLD_AMT_WED, SOLD_AMT_THU, SOLD_AMT_FRI, SOLD_AMT_SAT, SOLD_AMT_SUN, SALES_DAY_CNT
				FROM (
					SELECT T5.COMM_NO,
						NVL(SUM(ENTER_FIXED),0.001) ENTER_FIXED_TOT,
						NVL(SUM(DECODE(RACE_YOIL, 'WED', ENTER_FIXED)),0) ENTER_FIXED_WED,
						NVL(SUM(DECODE(RACE_YOIL, 'THU', ENTER_FIXED)),0) ENTER_FIXED_THU,
						NVL(SUM(DECODE(RACE_YOIL, 'FRI', ENTER_FIXED)),0) ENTER_FIXED_FRI,
						NVL(SUM(DECODE(RACE_YOIL, 'SAT', ENTER_FIXED)),0) ENTER_FIXED_SAT,
						NVL(SUM(DECODE(RACE_YOIL, 'SUN', ENTER_FIXED)),0) ENTER_FIXED_SUN,
				
						NVL(SUM(SOLD_AMT),0) SOLD_AMT_TOT,
						NVL(SUM(DECODE(RACE_YOIL, 'WED', SOLD_AMT)),0) SOLD_AMT_WED,
						NVL(SUM(DECODE(RACE_YOIL, 'THU', SOLD_AMT)),0) SOLD_AMT_THU,
						NVL(SUM(DECODE(RACE_YOIL, 'FRI', SOLD_AMT)),0) SOLD_AMT_FRI,
						NVL(SUM(DECODE(RACE_YOIL, 'SAT', SOLD_AMT)),0) SOLD_AMT_SAT,
						NVL(SUM(DECODE(RACE_YOIL, 'SUN', SOLD_AMT)),0) SOLD_AMT_SUN,
						SUM(DECODE(SOLD_AMT,0,0,1)) SALES_DAY_CNT
					FROM ENTER_NUM_FIXED T3, SALES_FIXED T5, VW_SDL_INFO T6
					WHERE 1=1
					AND T6.RACE_DAY = T3.TRADE_DATE
					AND T6.RACE_DAY = T5.RACE_DAY
					AND T5.COMM_NO = T3.COMM_NO
					AND T6.MEET_CD IN ('001','003')
					AND LENGTH(ROUND(TO_NUMBER(SUBSTR(T6.MEET_CD,3,1))/3,5)) =
						( CASE WHEN ?= '003' THEN 1 --경정
							   WHEN ?= '001' THEN 6 --경륜
							   ELSE LENGTH(ROUND(TO_NUMBER(SUBSTR(T6.MEET_CD,3,1))/3,5)) --전체
							   END
						)
					GROUP BY T5.COMM_NO
				) S1, SEAT_NUM S2
				WHERE 1=1
				AND S2.COMM_NO = S1.COMM_NO 
			)
			ORDER BY 1
        ]]>
    </query> 
    
</queryMap>