<?xml version="1.0" encoding='EUC-KR'?>
<queryMap desc="tbdn_wk_sche_d06000004_mngr(주간교육일정)">

    <query id="tbdn_wk_sche_fn001" desc="기수 조회" fetchSize="10">
        <![CDATA[
			  
			   SELECT  CD  RACER_PERIO_NO
				 FROM  TBDM_SPEC_CD
				 WHERE GRP_CD  = 'D10000'
				 ORDER BY CD DESC	
		]]>
    </query>     
    
    <query id="tbdn_wk_sche_fn000" desc="주차 콤보 조회" fetchSize="10">
        <![CDATA[
			SELECT  DISTINCT(WK) AS CD              
				   ,WK || '주차' AS CD_NM
			FROM    TBDN_WK_ABS
			WHERE	RACER_PERIO_NO = NVL(?,RACER_PERIO_NO)	
			ORDER BY WK ASC	          		 		 		 		 	
		]]>
    </query>
    		   
    <query id="tbdn_wk_sche_fn002" desc="년도 조회" fetchSize="10">
        <![CDATA[
			
			SELECT DISTINCT(YY) YY       
			FROM   TBDN_WK_ABS 
			ORDER BY YY DESC	
        
        ]]>
    </query>
    
    <query id="tbdn_wk_sche_fn003" desc="강사 조회" fetchSize="10">
        <![CDATA[
			SELECT  GUD_LECTR_ID
					,NM_KOR
					,BLNG
			FROM    TBDN_GUD_LECTR
			WHERE	USE_YN 				= '001'
			        AND RACER_PERIO_NO  = ?
			ORDER BY NM_KOR				
		]]>
    </query>
    
    <query id="tbdn_wk_sche_fn004" desc="주차 조회" fetchSize="10">
        <![CDATA[
			SELECT   RACER_PERIO_NO   
					 ,YY               
					 ,MM               
					 ,WK               
					 ,STR_DT           
					 ,END_DT           
					 ,'0'       CHK
			FROM    TBDN_WK_ABS 
			WHERE   RACER_PERIO_NO = ?
			AND     TRIM(WK) = NVL(?,TRIM(WK))	 		          		 		 		 		 	
			ORDER BY TO_NUMBER(TRIM(WK)) 
		]]>
    </query>
    
    <query id="tbdn_wk_sche_fn005" desc="종합 교육개요 조회" fetchSize="10">
        <![CDATA[
			SELECT   RACER_PERIO_NO
					 ,EDU_STR_DT
					 ,EDU_END_DT
					 ,TOT_EDU_TIME
			FROM    TBDN_CMPT_EDU_OUTL
			WHERE   RACER_PERIO_NO = ?	
			
		]]>
    </query>
    
    <query id="item_code_d06000004" desc="종목코드 조회" fetchSize="10">
        <![CDATA[
			SELECT  TGC.GRP_CD      	-- 그룹코드
			      , TGC.GRP_NM      	-- 그룹명
			      , TSC.CD              -- 코드
			      , TSC.CD_NM       	-- 코드명
			      , TSC.RMK         	-- 비고
			FROM    TBDM_GRP_CD  TGC
			      , TBDM_SPEC_CD TSC
			WHERE TGC.GRP_CD = TSC.GRP_CD
			AND   TSC.DEL_YN = 'N'
			AND   TGC.GRP_CD IN ('D10030','D10064','D10010')
			ORDER BY TSC.GRP_CD,TSC.CD 
        ]]>
    </query>
    
    <query id="tbdn_wk_sche_fn006" desc="종합교육 시간배정표 조회" fetchSize="10">
        <![CDATA[
			SELECT   SECTN_CD
					,CRS_CD
					,EDU_TIME NO_RACER_TIME 
			FROM    TBDN_CMPT_EDU_ASSIGN
			WHERE   RACER_PERIO_NO = ?
		]]>
    </query>
    
    <query id="tbdn_wk_sche_fn007" desc="교육일지 교육시간 조회" fetchSize="10">
        <![CDATA[
			SELECT   DT
					,SECTN_CD
					,EDU_TIME
			FROM    TBDN_TRNG_DIARY_DETL 
			WHERE   RACER_PERIO_NO = ?
		]]>
    </query>
    
    <query id="tbdn_wk_sche_fn008" desc="주간교육일정표 조회" fetchSize="10">
        <![CDATA[
			SELECT   /* tbdn_wk_sche_fn008 */
			          RACER_PERIO_NO
					 ,YY
					 ,MM
					 ,WK
					 ,SEQ            
					 ,DT             
					 ,STR_END_TIME   
					 ,SECTN_CD       
					 ,CRS_CD         
					 ,DETL_EDU_CRS   
					 ,LECTR          
					 ,PLC            
					 ,TIME           
					 ,'0'   CHK
			FROM     TBDN_WK_SCHE 
			WHERE    RACER_PERIO_NO = ?
			AND      TRIM(WK) = NVL(?,TRIM(WK))	 		          		 		 		 		 	
			ORDER BY DT,STR_END_TIME
		]]>
    </query>
    
    <query id="tbdn_wk_sche_fn009" desc="주간교육일정 가져오기" fetchSize="10">
        <![CDATA[
			SELECT  /* tbdn_wk_sche_fn009 */
			         T1.RACER_PERIO_NO
					,T1.YY
					,T1.MM
			       	,T2.WK
			       	,T1.DT             
			       	,T1.STR_END_TIME
			       	,T1.SECTN_CD
			       	,T1.CRS_CD         
			       	,T1.DETL_EDU_CRS
			       	,T1.LECTR
			       	,T1.PLC            
			       	,T1.EDU_TIME TIME
			       	,'0' CHK
			FROM     TBDN_DETL_EDU_ASSIGN T1
					,TBDN_WK_ABS T2
			WHERE   DT >= STR_DT AND DT <= END_DT
			        AND T1.RACER_PERIO_NO = T2.RACER_PERIO_NO
			        AND T2.RACER_PERIO_NO = ?
			        AND T2.WK 			  LIKE  NVL(?, '%')
			ORDER BY T1.DT, STR_END_TIME
		]]>
    </query>

    <query id="tbdn_wk_sche_fn010" desc="주간교육일정표 조회" fetchSize="10">
    <![CDATA[
		SELECT
			  T1.RACER_PERIO_NO
			, NVL(T1.TOT_TM,0)     TOT_TM
			, NVL(T1.SIL_TM,0)     SIL_TM
			, NVL(T1.LEE_TM,0)     LEE_TM
			, NVL(T1.ETC_TM,0)     ETC_TM
			, NVL(T2.ISU_TOT_TM,0)+NVL(T3.ISU_TOT_TM,0) ISU_TOT_TM
			, NVL(T2.ISU_SIL_TM,0)+NVL(T3.ISU_SIL_TM,0) ISU_SIL_TM
			, NVL(T2.ISU_LEE_TM,0)+NVL(T3.ISU_LEE_TM,0) ISU_LEE_TM
			, NVL(T2.ISU_ETC_TM,0)+NVL(T3.ISU_ETC_TM,0) ISU_ETC_TM
			, NVL(DECODE(T1.TOT_TM,0,0,ROUND(((NVL(T2.ISU_TOT_TM,0)+NVL(T3.ISU_TOT_TM,0))/T1.TOT_TM)*100,2)),0) AS JINDO1
			, NVL(DECODE(T1.SIL_TM,0,0,ROUND(((NVL(T2.ISU_SIL_TM,0)+NVL(T3.ISU_SIL_TM,0))/T1.SIL_TM)*100,2)),0) AS JINDO2
			, NVL(DECODE(T1.LEE_TM,0,0,ROUND(((NVL(T2.ISU_LEE_TM,0)+NVL(T3.ISU_LEE_TM,0))/T1.LEE_TM)*100,2)),0) AS JINDO3
			, NVL(DECODE(T1.ETC_TM,0,0,ROUND(((NVL(T2.ISU_ETC_TM,0)+NVL(T3.ISU_ETC_TM,0))/T1.ETC_TM)*100,2)),0) AS ETC_JINDO
			, T3.EDU_STR_DT
			, T3.EDU_END_DT
		FROM
		(
			SELECT
				A.RACER_PERIO_NO,
				SUM(EDU_TIME) TOT_TM,
				SUM(DECODE(SECTN_CD,'001',EDU_TIME,0)) SIL_TM,
				SUM(DECODE(SECTN_CD,'002',EDU_TIME,0)) LEE_TM,
				SUM(DECODE(SECTN_CD,'003',EDU_TIME,0)) ETC_TM,
				MIN(DT) EDU_STR_DT,
				MAX(DT) EDU_END_DT
			FROM  TBDN_DETL_EDU_ASSIGN A, TBDN_CFM B
			WHERE 1=1
			AND A.RACER_PERIO_NO = ?
			AND A.RACER_PERIO_NO = B.RACER_PERIO_NO
			AND B.MN_ID = 'D06000003 '  --세부교육일정
			AND B.CFM_FG = 'Y'          --세부교육일정 확정
			GROUP BY A.RACER_PERIO_NO
		) T1,
		(
		 	SELECT
				A.RACER_PERIO_NO,
				SUM(EDU_TIME) ISU_TOT_TM,
				SUM(DECODE(SECTN_CD,'001',EDU_TIME,0)) ISU_SIL_TM,
				SUM(DECODE(SECTN_CD,'002',EDU_TIME,0)) ISU_LEE_TM,
				SUM(DECODE(SECTN_CD,'003',EDU_TIME,0)) ISU_ETC_TM
			FROM  TBDN_TRNG_DIARY_MST A, TBDN_TRNG_DIARY_DETL B
			WHERE 1=1
			AND A.RACER_PERIO_NO = ?
			AND A.CFG_YN = 'Y'          --교육훈련일지 확정
			AND A.RACER_PERIO_NO = B.RACER_PERIO_NO
			AND A.DT = B.DT
			AND A.DT < ?--시작일
			GROUP BY A.RACER_PERIO_NO
		) T2,
		(
		 	SELECT
				RACER_PERIO_NO,
				SUM(TIME) ISU_TOT_TM,
				SUM(DECODE(SECTN_CD,'001',TIME,0)) ISU_SIL_TM,
				SUM(DECODE(SECTN_CD,'002',TIME,0)) ISU_LEE_TM,
				SUM(DECODE(SECTN_CD,'003',TIME,0)) ISU_ETC_TM,
				MIN(DT) EDU_STR_DT,
				MAX(DT) EDU_END_DT
			FROM  TBDN_WK_SCHE
			WHERE 1=1
			AND RACER_PERIO_NO = ? --변수
			AND WK = ?
			GROUP BY RACER_PERIO_NO
		 ) T3
		WHERE 1=1
		AND T1.RACER_PERIO_NO = T2.RACER_PERIO_NO(+)
		AND T1.RACER_PERIO_NO = T3.RACER_PERIO_NO(+)		
			]]>
    </query>
    
    <query id="tbdn_wk_sche_fb010" desc="주간교육일정표 조회(PRINT)" fetchSize="10">
    <![CDATA[    			
			  SELECT  
					  SUBSTR(DT ,0,4)||'-'||SUBSTR(DT ,5,2)||'-'||SUBSTR(DT ,7,2) AS DT
					 --,SUBSTR(STR_END_TIME ,0,2) ||':'||SUBSTR(STR_END_TIME ,3,2)||' ~ '||
					 -- SUBSTR(STR_END_TIME ,5,2) ||':'||SUBSTR(STR_END_TIME ,7,2) AS STR_END_TIME
					 , RANK() OVER(PARTITION BY DT ORDER BY SEQ ASC) AS SEQ
					 ,(SELECT CD_NM  FROM TBDM_SPEC_CD WHERE GRP_CD  ='D10027' AND CD = T1.SECTN_CD  ) AS SECTN_CD 
					 ,(SELECT CD_NM  FROM TBDM_SPEC_CD WHERE GRP_CD  =(
					  CASE WHEN (SELECT CD  FROM TBDM_SPEC_CD WHERE GRP_CD  ='D10027' AND CD = T1.SECTN_CD  ) ='001' THEN 'D10030' 
					  WHEN (SELECT CD  FROM TBDM_SPEC_CD WHERE GRP_CD  ='D10027' AND CD = T1.SECTN_CD  ) ='002' THEN 'D10064' 
					  WHEN (SELECT CD  FROM TBDM_SPEC_CD WHERE GRP_CD  ='D10027' AND CD = T1.SECTN_CD  ) ='003' THEN 'D10010'  END 
					  )  AND CD = T1.CRS_CD  ) AS CRS_CD 
					 ,DETL_EDU_CRS   
					 --,(SELECT CD_NM  FROM TBDM_SPEC_CD WHERE GRP_CD  ='D10005' AND CD = T1.OBJ  ) AS OBJ
					 ,LECTR 
					 ,PLC                            
					 ,TIME           
				FROM
						 TBDN_WK_SCHE T1
				WHERE
				         RACER_PERIO_NO = ?
					AND  TRIM(WK) = ?	 		          		 		 		 		 	
				ORDER BY DT
				]]>
    </query>
    <query id="tbdn_wk_sche_fn011" desc="년월주간순서" fetchSize="10">
    <![CDATA[  
	    
	    SELECT ROWNUM AS NUM
	           ,RACER_PERIO_NO
	           ,YY
	           ,MM
	           ,WK
	    ,RACER_PERIO_NO||YY||MM||WK AS SEQ
	     FROM (
		       SELECT *
				FROM TBDN_WK_ABS 
				WHERE RACER_PERIO_NO  = ? 
				ORDER BY YY, MM , WK 
		) 
    ]]>
    </query> 
    
    <query id="tbdn_wk_sche_fn012" desc="월간교육일정조회" fetchSize="10">
    <![CDATA[  
	    
SELECT
	  MM
	, SECTN_NM
	, CRS_NM
	, DETL_EDU_CRS
	, COUNT(DISTINCT DT) DAY_CNT
	, SUM(TIME) TOT_TIME
FROM (
	SELECT
	      SUBSTR(MM,2,2) MM
	    , DT
		, SECTN_CD
		, FC_CODE_NM_003('D10027',SECTN_CD)  SECTN_NM	--과목구분
		, CRS_CD
		, CASE WHEN SECTN_CD = '001' THEN FC_CODE_NM_003('D10030',CRS_CD)  --학과
	           WHEN SECTN_CD = '002' THEN FC_CODE_NM_003('D10064',CRS_CD)  --실기
	           WHEN SECTN_CD = '003' THEN FC_CODE_NM_003('D10010',CRS_CD)  --기타
	      END CRS_NM
		, DETL_EDU_CRS
		, TIME
	FROM TBDN_WK_SCHE
	WHERE 1=1
	AND RACER_PERIO_NO = ? --변수
	AND MM = '0'||? --변수
)
GROUP BY MM, SECTN_NM, CRS_NM, DETL_EDU_CRS
ORDER BY SECTN_NM DESC, CRS_NM
 
    ]]>
    </query> 
    
    <query id="tbdn_wk_sche_in001" desc="주간교육일정표 삽입" fetchSize="10">
        <![CDATA[
			INSERT /* tbdn_wk_sche_in001 */
			       INTO TBDN_WK_SCHE (
				     RACER_PERIO_NO		        
				    ,YY   
				    ,MM
				    ,WK
				    ,SEQ          
				    ,DT           
				    ,STR_END_TIME 
				    ,SECTN_CD     
				    ,CRS_CD       
				    ,DETL_EDU_CRS 
				    ,LECTR        
				    ,PLC          
				    ,TIME     
				    ,INST_ID      
				    ,INST_DTM     
			)
			SELECT
					 ?
					,?
					,?									
					,?
					,NVL(MAX(SEQ), 0) + 1
					,?
					,?
					,?
					,?
					,?
					,?
					,?
					,?
					,?
					,SYSDATE
			FROM    TBDN_WK_SCHE
			WHERE   RACER_PERIO_NO = ?
        ]]>
    </query>
    
    <query id="tbdn_wk_sche_un001" desc="주간교육일정표 갱신" fetchSize="10">
        <![CDATA[
			UPDATE TBDN_WK_SCHE 
			SET      DT				= ?
					,STR_END_TIME	= ?
					,SECTN_CD		= ?
					,CRS_CD			= ?
					,DETL_EDU_CRS	= ?
					,LECTR			= ?
					,PLC     		= ?
					,TIME		    = ?
					,UPDT_ID        = ?
					,UPDT_DTM       = SYSDATE
			WHERE	RACER_PERIO_NO	= ?
			AND		SEQ				= ?	
        ]]>
    </query>
    
    <query id="tbdn_wk_sche_dn001" desc="주간교육일정표 삭제" fetchSize="10">
        <![CDATA[
			DELETE  TBDN_WK_SCHE 
			WHERE	RACER_PERIO_NO	= ?
			AND		SEQ				= ?	
        ]]>
    </query>
   
</queryMap>