<?xml version="1.0" encoding='EUC-KR'?>
<queryMap desc="TBDM_MN_AUTH_HIST(개인정보처리 권한관리)">
     
      <query id="d05000007_s01" desc="메뉴조회" fetchSize="10">
        <![CDATA[
			SELECT A.MN_ID
                 , A.MN_NM
                 , A.UP_MN_ID
                 , C.MN_NM UPMNNM
                 , D.MN_ID UPUP_MN_ID
                 , D.MN_NM UPUPMN_NM
                 , A.LVL 
                 , A.ORD_NO
                 , A.MN_LEVEL 
                 , ROWNUM AS SEQ
                 , '0' AS CHK
           FROM  (
                     SELECT MN_ID
                              ,MN_NM
                              ,UP_MN_ID
                              ,ORD_NO
                              ,URL
                              ,LV AS MN_LEVEL
                              ,LEVEL -1 AS LVL
                     FROM VWDM_MN
                     START WITH MN_ID = '000000000'
                     CONNECT BY PRIOR MN_ID = UP_MN_ID
                     ORDER SIBLINGS BY UP_MN_ID, ORD_NO, TO_NUMBER(LV)
                  ) A
                  , TBDM_MN B, TBDM_MN C, TBDM_MN D                    
          WHERE A.MN_ID    = B.MN_ID
            AND A.UP_MN_ID = C.MN_ID
            AND C.UP_MN_ID = D.MN_ID
            AND A.URL IS NOT NULL   
            AND B.PERSONAL_DATA_MN = 'Y'
            AND A.UP_MN_ID = NVL(? , A.UP_MN_ID)
        ORDER BY SEQ
        ]]>
    </query>
    
     <query id="d05000007_s02" desc="USERLIST쿼리" fetchSize="10">
        <![CDATA[
			SELECT A.USER_ID     -- 사용자ID         
			       , A.USER_NM     -- 사용자명   
			       , B.MENU_USE	   -- 메뉴사용 여부         
			       , B.DUTY_GRP_CD -- 업무그룹코드     
			       , A.DEPT_CD     -- 부서코드
			       , A.DEPT_NM	   -- 부서이름
			       , A.TEAM_CD	   -- 팀코드
			       , A.TEAM_NM	   -- 팀이름
			       , A.FLOC		   -- 직위코드
			       , A.FGRADE	   -- 직위         
			       , A.TEL_NO      -- 전화번호         
			       , B.HP_NO       -- 휴대폰번호
			       , A.EMAIL	   -- 이메일       
			       , B.STR_DT      -- 유효기간 시작일자
			       , B.END_DT      -- 유효기간 종료일자 
			       , C.PERSONAL_YN		--개인정보처리여부
			       , C.PERSONAL_MN_IP	--개인정보처리IP
			       , C.SRCH_YN			-- 조회권한    
			       , C.STR_DT_TM 
			       , '0' AS CHK
			FROM   VWEA_USER A, TBDM_USER B,
	             (SELECT 
	                        USER_ID    
	                      , MN_ID
	                      , STR_DT_TM    
	                      , DECODE(PERSONAL_YN, 'Y', 1, 0) PERSONAL_YN
	                      , PERSONAL_MN_IP
	                      , INST_ID    
	                      , INST_DTM    
	                      , UPDT_ID    
	                      , UPDT_DTM
	                      , SRCH_YN    
	                 FROM TBDM_MN_AUTH_HIST    
	                WHERE MN_ID = ?
	                AND   TO_CHAR(SYSDATE, 'YYYYMMDDHH24MI') BETWEEN STR_DT_TM AND END_DT_TM                    
	             ) C
			WHERE A.USER_ID = B.USER_ID(+)
	          AND A.USER_ID = C.USER_ID
			  AND B.MENU_USE = '001'
	          AND A.TEAM_NM LIKE '%' || NVL(?, A.TEAM_NM) || '%'
	          AND A.USER_NM LIKE '%' || NVL(?, A.USER_NM) || '%'
			
        ]]>
    </query>
    
    <query id="d05000007_s03" desc="동시 작업기준을 위한 작업시간을 조회" fetchSize="10">
        <![CDATA[
			SELECT TO_CHAR(SYSDATE, 'YYYYMMDDHH24MI') AS CUR_DTM -- 작업기준일시
			FROM   DUAL			
        ]]>
    </query>    
    
    <query id="d05000007_s04" desc="권한대상 사용자 조회(일반사용자)" fetchSize="10">
      <![CDATA[
            SELECT USER_ID -- 건수
			FROM   TBDM_MN_AUTH_HIST
			WHERE  USER_ID = ?
			AND    MN_ID   = ?
			AND	   ? BETWEEN STR_DT_TM AND END_DT_TM 
        ]]>
    </query> 
     
    <query id="d05000007_i01" desc="개인정보처리권한등록" fetchSize="10">
        <![CDATA[
			INSERT 
			       INTO TBDM_MN_AUTH_HIST (
			      USER_ID
			    , MN_ID
			    , STR_DT_TM
			    , END_DT_TM
			    , PERSONAL_YN
			    , INST_ID
			    , INST_DTM
			    , PERSONAL_MN_IP
			    , PERSONAL_AUTH_ID
			    , PERSONAL_AUTH_CHK
			    , PERSONAL_AUTH_DT
			    , SRCH_YN
			) VALUES (
			      ?                 -- USER_ID
			    , ?                 -- MN_ID
			    , ? 				-- 작업기준일시
			    , '299912312359'
			    , ?                 -- PERSONAL_YN
			    , ?                 -- INST_ID			    
			    , SYSDATE           -- INST_DTM
			    , ?					-- PERSONAL_MN_IP
			    , ?					-- PERSONAL_AUTH_ID
			    , ?					-- PERSONAL_AUTH_CHK
			    , ? 				-- PERSONAL_AUTH_DT
			    , ?					-- SRCH_YN
			)
        ]]>
    </query>  
     
    <query id="d05000007_i02" desc="개인정보 처리내역 저장" fetchSize="10">
        <![CDATA[
			INSERT 
			  INTO TBDM_PERSONAL_MN_AUTH_HIST (
			            SEQ_NO
			          , PERSONAL_MN_ID
			          , PERSONAL_AUTH_ID
			          , PERSONAL_AUTH_CHK
			          , PERSONAL_AUTH_DT
			          , USER_ID
			          , PERSONAL_MN_IP
				) VALUES (
				        (SELECT NVL(MAX(SEQ_NO),0)+1 FROM TBDM_PERSONAL_MN_AUTH_HIST)         -- SEQ_NO
				      , ? 		  -- PERSONAL_MN_ID
				      , ?		  -- PERSONAL_AUTH_ID
				      , ?		  -- PERSONAL_AUTH_CHK
				      , ? 		  -- PERSONAL_AUTH_DT
				      , ?		  -- USER_ID
				      , ?		  -- PERSONAL_MN_IP
			)
        ]]>
    </query>  
     
    <query id="d05000007_u01" desc="권한 수정" fetchSize="10">
        <![CDATA[
			UPDATE 
			       TBDM_MN_AUTH_HIST
			SET    PERSONAL_YN = ?				-- 개인정보처리메뉴 사용여부(Y:사용, N:미사용)
			     , PERSONAL_MN_IP = ?			-- 개인정보처리메뉴 사용자 IP
			     , PERSONAL_AUTH_ID = ?			-- 개인정보처리메뉴 권한부여자
			     , PERSONAL_AUTH_CHK = ?		-- 개인정보처리메뉴 권한체크(Y:부여, N:말소)
			     , PERSONAL_AUTH_DT = SYSDATE	-- 개인정보처리메뉴 권한부여일시 
			     , UPDT_ID = ?					-- 수정자 사번
			     , UPDT_DTM = SYSDATE			-- 수정일시
			WHERE  USER_ID = ?					-- 사용자 사번
			AND    MN_ID   = ?					-- 메뉴ID
			AND    STR_DT_TM  = ?				-- 시작일시분
        ]]>
    </query> 
     
    <query id="d05000007_i03" desc="개인정보 처리내역 저장" fetchSize="10">
        <![CDATA[
			INSERT 
			  INTO TBDM_PERSONAL_MN_AUTH_HIST (
			            SEQ_NO
			          , PERSONAL_MN_ID
			          , PERSONAL_AUTH_ID
			          , PERSONAL_AUTH_CHK
			          , PERSONAL_AUTH_DT
			          , USER_ID
			          , PERSONAL_MN_IP
				) VALUES (
				        (SELECT NVL(MAX(SEQ_NO),0)+1 FROM TBDM_PERSONAL_MN_AUTH_HIST)         -- SEQ_NO
				      , ? 		  -- PERSONAL_MN_ID
				      , ?		  -- PERSONAL_AUTH_ID
				      , ?		  -- PERSONAL_AUTH_CHK
				      , ? 		  -- PERSONAL_AUTH_DT
				      , ?		  -- USER_ID
				      , ?		  -- PERSONAL_MN_IP
			)
        ]]>
    </query>  
     
          
</queryMap>