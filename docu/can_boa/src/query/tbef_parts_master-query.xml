<?xml version="1.0" encoding='EUC-KR'?>
<queryMap desc="tbef_parts 부품 등록 ">
	<query id="tbef_parts_master_ff001" desc="부품 마스터 조회 " fetchSize="50">
        <![CDATA[
            -- 부품 마스터 조회  
			SELECT /* tbef_parts_master_ff001 */
			       ROWNUM AS NUM, TP.* 
			FROM (
				SELECT 
				      0 AS CHK, 
				      PARTS_CD,            -- 부품코드 
				      PARTS_TPE,            -- 부품구분 
				      TPM.PARTS_COM_CD,        -- 부품업체코드
				      COM_NM,            -- 부품업체명
				      PARTS_ITEM_CD_NM, -- 품명
				      SPEC,                -- 규격
				      SAFT_UNIT_CNT,    -- 안전재고
				      LOC,                -- 보관장소                                     
				      USE_YN,     		-- 사용여부
				      PARTS_YEAR		-- 부품년식	 
				FROM TBEF_PARTS_MASTER TPM, TBEF_PARTS_COM TPC 
				    WHERE TPM.PARTS_COM_CD = TPC.PARTS_COM_CD(+)
				    AND TPM.PARTS_CD LIKE ?||'%' 
				    AND TPM.PARTS_ITEM_CD_NM LIKE ?||'%'
				    AND TPM.PARTS_COM_CD LIKE ?||'%'
				    AND TPM.USE_YN = DECODE(?, NULL, TPM.USE_YN, ?)
				    AND TPM.PARTS_TPE LIKE ?||'%'
				    AND DECODE(?, 'P', 1, 0) = SIGN(ASCII('W')-ASCII(TPM.PARTS_TPE))  

				    ORDER BY TPM.PARTS_CD,TPM.PARTS_COM_CD
				)TP
        ]]>
    </query> 
    
   <query id="tbef_parts_master_ff101" desc="부품 조회(최종단가   기준 / 주문  대상 품목 조회)  " fetchSize="50">
    <![CDATA[
            -- 부품 조회(최종단가   기준 /주문   대상 품목 조회)  
            SELECT /* tbef_parts_master_ff101 */
                   ROWNUM AS NUM,  A.* 
             FROM (
				SELECT 
				    TPM.STND_YEAR,
                    TPM.MBR_CD,
				    TPM.PARTS_CD,            -- 부품코드 
				    TPM.PARTS_TPE, -- 부품 구분 
				    TPM.PARTS_COM_CD,        -- 부품업체코드
				    TPM.COM_NM,            -- 부품업체명
				    TPM.PARTS_ITEM_CD_NM, -- 품명
				    TPM.SPEC,                -- 규격
                    TPM.PARTS_YEAR,        -- 부품년식
				    TPM.SAFT_UNIT_CNT,    -- 안전재고
				    TP.CRFW_UNIT_CNT,    -- 이월재고
				    TP.NOW_UNIT_CNT,     -- 현재재고
				    TPM.LOC,                -- 보관장소                                     
				    TPM.USE_YN     -- 사용여부  
				 FROM (
   				     SELECT 
                          ? AS STND_YEAR,        -- 기준년도
			              ? AS MBR_CD,            -- 경정장코드
   				          TPM.PARTS_CD, PARTS_TPE, TPM.PARTS_COM_CD,
   				          COM_NM, PARTS_ITEM_CD_NM, SPEC, SAFT_UNIT_CNT, LOC, USE_YN, PARTS_YEAR
   				     FROM TBEF_PARTS_MASTER TPM, TBEF_PARTS_COM TPC
   				         WHERE TPM.PARTS_COM_CD = TPC.PARTS_COM_CD(+)
   				         AND TPM.PARTS_CD LIKE ?||'%' 
   				         AND TPM.PARTS_ITEM_CD_NM LIKE ?||'%'
   				         AND TPM.PARTS_COM_CD LIKE ?||'%'
   				         AND TPM.USE_YN = DECODE(?, NULL, TPM.USE_YN, ?)
				 )TPM, 
				 (           
                     SELECT 
                         TP.STND_YEAR, TP.MBR_CD, TP.PARTS_CD, TP.PARTS_YEAR, SUM(CRFW_UNIT_CNT)AS CRFW_UNIT_CNT, NVL(SUM(NOW_UNIT_CNT),0) AS NOW_UNIT_CNT, SUM(SIGHT_CNT) AS SIGHT_CNT
                     FROM  TBEF_PARTS TP
                     WHERE TP.STND_YEAR=?
                       AND TP.MBR_CD=?
                     GROUP BY TP.STND_YEAR, TP.MBR_CD, TP.PARTS_CD, TP.PARTS_YEAR
                ) TP
                WHERE  TPM.STND_YEAR = TP.STND_YEAR(+)
                AND TPM.MBR_CD = TP.MBR_CD(+)
                AND TPM.PARTS_CD = TP.PARTS_CD(+)
                AND TPM.PARTS_YEAR = TP.PARTS_YEAR(+)
                ORDER BY TPM.PARTS_CD, TPM.PARTS_YEAR
            )A
        ]]>
    </query> 
    
    
    <query id="tbef_parts_master_ff102" desc="부품 조회(현재고 기준 조회/출고 대상 품목 조회)  " fetchSize="50">
    <![CDATA[
            -- 부품 조회(현재고 기준 조회/출고 대상 품목 조회)
            SELECT /* tbef_parts_master_ff102 */
                   '' AS CHK, ROWNUM AS NUM, A.* 
            FROM(
				SELECT 
				    TP.STND_YEAR,        -- 기준년도
				    TP.MBR_CD,            -- 경정장코드
				    TP.PARTS_CD,            -- 부품코드 
				    TPM.PARTS_TPE, -- 부품 구분 
				    TP.PARTS_YEAR,           -- 부품년식 
				    TPM.PARTS_COM_CD,        -- 부품업체코드
				    TPM.COM_NM,            -- 부품업체명
				    TPM.PARTS_ITEM_CD_NM, -- 품명
				    TPM.SPEC,                -- 규격
				    TPM.SAFT_UNIT_CNT,    -- 안전재고
				    TP.CRFW_UNIT_CNT,    -- 이월재고
				    NVL(TP.NOW_UNIT_CNT,0) AS NOW_UNIT_CNT,     -- 현재재고
				    TPM.LOC,                -- 보관장소                                     
				    TPM.USE_YN 	-- 사용여부  
				FROM (
				    SELECT 
				          PARTS_CD, PARTS_TPE, TPM.PARTS_COM_CD,
				          COM_NM, PARTS_ITEM_CD_NM, SPEC, SAFT_UNIT_CNT, LOC, USE_YN, PARTS_YEAR 
				    FROM TBEF_PARTS_MASTER TPM, TBEF_PARTS_COM TPC 
				        WHERE TPM.PARTS_COM_CD = TPC.PARTS_COM_CD(+)
				        AND TPM.PARTS_CD LIKE ?||'%' 
				        AND TPM.PARTS_ITEM_CD_NM LIKE ?||'%'
				        AND TPM.PARTS_COM_CD LIKE ?||'%'
				        AND TPM.USE_YN = DECODE(?, NULL, TPM.USE_YN, ?)
			            AND TPM.PARTS_TPE LIKE ?||'%'
				        AND DECODE(?, 'P', 1, 0) = SIGN(ASCII('W')-ASCII(TPM.PARTS_TPE))
				)TPM, 
				(SELECT TP.STND_YEAR, TP.MBR_CD, TP.PARTS_CD, TP.PARTS_YEAR, 
					    TP.CRFW_UNIT_CNT, TP.NOW_UNIT_CNT 
					FROM TBEF_PARTS TP
					WHERE 1=1
					AND TP.STND_YEAR=?
					AND TP.MBR_CD =?
				) TP
				WHERE TPM.PARTS_CD = TP.PARTS_CD(+)
				AND TPM.PARTS_YEAR = TP.PARTS_YEAR(+)
				   AND NVL(TP.NOW_UNIT_CNT, 0) > DECODE(NVL(?, 'N'), 'Y', 0, -999999)
				ORDER BY TPM.PARTS_CD, TP.PARTS_YEAR 
			)A
			
        ]]>
    </query> 
    
    <query id="tbef_parts_master_mf001" desc="부품 목록 정보 등록 " fetchSize="10">
        <![CDATA[
        	-- 부품 등록 
        	/* tbef_parts_master_mf001 */
			MERGE INTO TBEF_PARTS_MASTER TPM
			USING (
				SELECT 
				   ? AS PARTS_CD,		-- 부품코드 
				   ? AS PARTS_TPE, 	--부품 구분 
				   ? AS PARTS_COM_CD,	-- 부품업체코드
				   ? AS PARTS_ITEM_CD_NM, -- 품명
				   ? AS SPEC,			-- 규격
				   ? AS SAFT_UNIT_CNT,	-- 안전재고
				   ? AS LOC,				-- 보관장소 	
				   ? AS USE_YN,				-- 사용여부
				   ? AS PARTS_YEAR,			-- 부품년식 		
				   ? AS USER_ID   -- 사용여부 
			   FROM DUAL 
			) TP
			ON (
				    TPM.PARTS_CD = TP.PARTS_CD	-- 부품코드
				AND TPM.PARTS_YEAR = TP.PARTS_YEAR	-- 부품년식
			    )
			WHEN MATCHED THEN
			UPDATE 
				SET 
				   TPM.PARTS_TPE = TP.PARTS_TPE,	-- 부품업체코드
				   TPM.PARTS_COM_CD = TP.PARTS_COM_CD,	-- 부품업체코드
				   TPM.PARTS_ITEM_CD_NM = TP.PARTS_ITEM_CD_NM, -- 품명
				   TPM.SPEC = TP.SPEC,			-- 규격
				   TPM.SAFT_UNIT_CNT = TP.SAFT_UNIT_CNT,	-- 안전재고
				   TPM.LOC = TP.LOC,				-- 보관장소 	
				   TPM.USE_YN = TP.USE_YN,			-- 보관장소
			       TPM.UPDT_ID = TP.USER_ID,	-- 수정자ID
			       TPM.UPDT_DTM = SYSDATE	-- 수정일시 
			WHEN NOT MATCHED THEN
			INSERT (
				TPM.PARTS_CD,		-- 부품코드 
				TPM.PARTS_TPE,		-- 부품구분  
				TPM.PARTS_COM_CD,	-- 부품업체코드
				TPM.PARTS_ITEM_CD_NM, -- 품명
				TPM.SPEC,			-- 규격
				TPM.SAFT_UNIT_CNT,	-- 안전재고
				TPM.LOC,			-- 보관장소 	
				TPM.USE_YN,			-- 보관장소 	
				TPM.PARTS_YEAR,		-- 부품년식
				TPM.INST_ID, 	-- 작성자ID
				TPM.INST_DTM 	-- 작성일시 
			 )
			 VALUES(
				TP.PARTS_CD,		-- 부품코드 
				TP.PARTS_TPE,		-- 부품구분 
				TP.PARTS_COM_CD,	-- 부품업체코드
				TP.PARTS_ITEM_CD_NM, -- 품명
				TP.SPEC,			-- 규격
				TP.SAFT_UNIT_CNT,	-- 안전재고
				TP.LOC,				-- 보관장소 	
				TP.USE_YN,			-- 보관장소 	
				TP.PARTS_YEAR,		-- 부품년식
				TP.USER_ID, 	-- 작성자ID
				SYSDATE 	-- 작성일시 
			 )
        ]]>
    </query> 
    
    
    <query id="tbef_parts_master_df001" desc="부품 목록 정보  삭제 " fetchSize="10">
        <![CDATA[
           	-- 부품 삭제 
			DELETE /* tbef_parts_master_df001 */
			FROM TBEF_PARTS_MASTER
			WHERE  PARTS_CD    = ?	-- 부품코드 
        ]]>
    </query> 
    
    <query id="tbef_parts_master_mf002" desc="부품단가 정보 등록 " fetchSize="10">
        <![CDATA[
        	-- 부품 등록 
        	/* tbef_parts_master_mf002 */
			MERGE INTO TBEF_PARTS_PRICE DST
			USING (
				SELECT 
				   ? AS PARTS_CD,			-- 부품코드 
				   ? AS PRICE_STND_YEAR, 	-- 단가년도 
				   ? AS UNIT_PRICE,			-- 단가
				   ? AS USER_ID   			-- 입력자 사번 
			   FROM DUAL 
			) SRC
			ON (
				    DST.PARTS_CD        = SRC.PARTS_CD	-- 부품코드
				AND DST.PRICE_STND_YEAR = SRC.PRICE_STND_YEAR -- 단가년도
			    )
			WHEN MATCHED THEN
			UPDATE 
				SET 
				   DST.UNIT_PRICE = SRC.UNIT_PRICE,	-- 단가
			       DST.UPDT_ID    = SRC.USER_ID,	-- 수정자ID
			       DST.UPDT_DTM   = SYSDATE			-- 수정일시 
			WHEN NOT MATCHED THEN
			INSERT (
				PARTS_CD,			-- 부품코드 
				PRICE_STND_YEAR,	-- 단가년도  
				UNIT_PRICE,			-- 단가
				INST_ID, 			-- 작성자ID
				INST_DTM 			-- 작성일시 
			 )
			 VALUES(
				SRC.PARTS_CD,		-- 부품코드 
				SRC.PRICE_STND_YEAR,-- 단가년도 
				SRC.UNIT_PRICE,		-- 단가
				SRC.USER_ID, 		-- 작성자ID
				SYSDATE 			-- 작성일시 
			 )
        ]]>
    </query> 
    
    
    <query id="tbef_parts_master_df002" desc="부품 목록 정보  삭제 " fetchSize="10">
        <![CDATA[
           	-- 부품단가 삭제 
			DELETE /* tbef_parts_master_df002 */
			FROM TBEF_PARTS_PRICE
			WHERE  PARTS_CD    		= ?	-- 부품코드 
			AND    PRICE_STND_YEAR 	= ? -- 단가기준년도
        ]]>
    </query> 
    
</queryMap>