<?xml version="1.0" encoding='EUC-KR'?>
<queryMap desc="tbef_parts 부품 등록 ">
	
    <query id="tbef_parts_mf001" desc="부품 저장   " fetchSize="10">
        <![CDATA[
			-- 부품  저장
			MERGE INTO TBEF_PARTS TMP
			USING (
				SELECT 
				   ? AS STND_YEAR,  -- 기준년도 
				   ? AS MBR_CD,     -- 경정장코드
				   ? AS PARTS_CD,   -- 부품코드
				   ? AS PARTS_YEAR,   -- 부품년식
				   ? AS CRFW_UNIT_CNT,   -- 이월재고 
				   ? AS NOW_UNIT_CNT,    -- 현재고 
				   --? AS USE_YN,   -- 사용여부 
				   ? AS USER_ID   -- 사용여부 
			   FROM DUAL 
			) TP
			ON (
				TMP.STND_YEAR = TP.STND_YEAR	-- 기준년도 
				AND TMP.MBR_CD = TP.MBR_CD	-- 경정장 코드 
				AND TMP.PARTS_CD = TP.PARTS_CD	-- 부품코드
				AND TMP.PARTS_YEAR = TP.PARTS_YEAR	-- 부품년식
			    )
			WHEN MATCHED THEN
			UPDATE 
				SET 
				   TMP.CRFW_UNIT_CNT = TP.CRFW_UNIT_CNT,  -- 이월재고 
				   TMP.NOW_UNIT_CNT = TP.NOW_UNIT_CNT,    -- 현재고 
				   --TMP.USE_YN = TP.USE_YN,   -- 사용여부 
			       TMP.UPDT_ID = TP.USER_ID,	-- 수정자ID
			       TMP.UPDT_DTM = SYSDATE	-- 수정일시 
			WHEN NOT MATCHED THEN
			INSERT (
				TMP.STND_YEAR,  -- 기준년도 
				TMP.MBR_CD,     -- 경정장코드
				TMP.PARTS_CD,   -- 부품코드
				TMP.PARTS_YEAR,   -- 부품 단가 년도
				TMP.CRFW_UNIT_CNT,   -- 이월재고 
				TMP.NOW_UNIT_CNT,    -- 현재고 
				--TMP.USE_YN,   -- 사용여부 
				TMP.INST_ID, 	-- 작성자ID
				TMP.INST_DTM 	-- 작성일시 
			 )
			 VALUES(
				TP.STND_YEAR,  -- 기준년도 
				TP.MBR_CD,     -- 경정장코드
				TP.PARTS_CD,   -- 부품코드
				TP.PARTS_YEAR,   -- 부품 단가 년도
				TP.CRFW_UNIT_CNT,   -- 이월재고 
				TP.NOW_UNIT_CNT,    -- 현재고 
				--TP.USE_YN,   -- 사용여부 
				TP.USER_ID, 	-- 작성자ID
				SYSDATE 	-- 작성일시 
			 )
        ]]>
    </query> 
  
    <query id="tbef_parts_df001" desc="부품 삭제 " fetchSize="10">
        <![CDATA[
           	-- 부품 삭제 
			DELETE /* tbef_parts_df001 */
			FROM TBEF_PARTS
			WHERE  STND_YEAR    = ?	-- 기준년도 
			AND  MBR_CD    = ?	-- 경정장코드 
			AND  PARTS_CD    = ?	-- 부품코드 
			AND  PRICE_STND_YEAR    = DECODE(?, NULL, PRICE_STND_YEAR, ?)	-- 부품코드 
        ]]>
    </query> 
    
    
    <query id="tbef_parts_df002" desc="부품 삭제 " fetchSize="10">
        <![CDATA[
           	-- 부품 사용내역  삭제 
			DELETE /* tbef_parts_df002 */
			FROM  TBEF_PARTS
			WHERE STND_YEAR = ?	-- 기준년도 
	  		  AND MBR_CD    = ?	-- 경정장코드 
			  AND PARTS_CD IN (	-- 소모품 여부	
					             SELECT PARTS_CD
					             FROM   TBEF_PARTS_MASTER
					             WHERE  DECODE(?, 'P', 1, 0) = SIGN(ASCII('W')-ASCII(PARTS_TPE))
			                  )
        ]]>
    </query> 
    
    
    <query id="tbef_parts_sf001" desc="최종 이월내역 조회 " fetchSize="10">
        <![CDATA[
			SELECT /* tbef_parts_sf001 : 최종 이월내역 조회 */
			       DECODE(M.PARTS_TPE, 'W', 'W', 'P') PARTS_TPE, 
			       MAX(STND_YEAR) STND_YEAR
			FROM TBEF_PARTS P, TBEF_PARTS_MASTER M
			WHERE P.PARTS_CD = M.PARTS_CD
			GROUP BY DECODE(M.PARTS_TPE, 'W', 'W', 'P')
        ]]>
    </query> 
    
</queryMap>