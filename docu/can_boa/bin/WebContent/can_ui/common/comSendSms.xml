<?xml version="1.0" encoding="euc-kr"?>
<Window>
	<Form Height="460" Id="comSendSms" Left="8" OnLoadCompleted="fcFormLoadSetting" OnUnloadCompleted="fcFormUnloadProcess" PidAttrib="7" Title="SMS" Top="8" Ver="1.0" Width="350" WorkArea="true">
		<Datasets>
			<Dataset DataSetType="Dataset" Id="dsSendSms">
				<Contents>
					<colinfo id="SEND_USER_ID" size="256" summ="default" type="STRING"/>
					<colinfo id="SEND_USER_NAME" size="256" summ="default" type="STRING"/>
					<colinfo id="RECEIVE_PHONE_NUMBER" size="256" summ="default" type="STRING"/>
					<colinfo id="RECEIVE_NAME" size="256" summ="default" type="STRING"/>
					<colinfo id="SEND_SUBJECT" size="256" summ="default" type="STRING"/>
					<colinfo id="SEND_PHONE_NUMBER" size="256" summ="default" type="STRING"/>
					<colinfo id="RECEIVE_USER_ID" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="dsRecvUser">
				<Contents>
					<colinfo id="USER_ID" size="256" summ="default" type="STRING"/>
					<colinfo id="USER_NM" size="256" summ="default" type="STRING"/>
					<colinfo id="HP_NO" size="256" summ="default" type="STRING"/>
					<colinfo id="CHK" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="dsUserPhone">
				<Contents>
					<colinfo id="USER_ID" size="256" summ="default" type="STRING"/>
					<colinfo id="USER_NM" size="256" summ="default" type="STRING"/>
					<colinfo id="HP_NO" size="256" summ="default" type="STRING"/>
					<colinfo id="CHK" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
		</Datasets>
		<Static Align="Center" Border="Flat" Height="136" Id="Static1" Left="8" Style="snis_m_lable" TabOrder="4" Text="내용" Top="26" VAlign="Middle" Width="80"></Static>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="20" Id="btnSend" ImageID="btn_txt_04" Left="96" OnClick="fcSave" TabOrder="2" Text="전송" Top="431" Width="76"></Button>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="20" Id="btnPopClose" ImageID="btn_txt_04" Left="184" OnClick="fcEnd" TabOrder="3" Text="닫기" Top="432" Width="76"></Button>
		<Static Font="Default,10,Bold" Height="22" Id="d" Left="28" Style="snis_m_title" TabOrder="6" Text="SMS&#32;전송" Top="3" VAlign="Middle" Width="118"></Static>
		<Image Height="20" Id="imgFormTitle" ImageID="m_titleblet" Left="7" TabOrder="5" Top="5" Width="17"></Image>
		<TextArea BindDataset="dsSendSms" Border="Flat" CheckLength="Byte" Column="SEND_SUBJECT" Height="136" Id="taSendSubject" ImeMode="native" Left="96" MaxLength="2000" Style="snis_if_input01" TabOrder="1" Top="24" Width="224"></TextArea>
		<Static Align="Center" Border="Flat" Height="24" Id="Static0" Left="8" Style="snis_m_lable" TabOrder="7" Text="보내는사람" Top="169" VAlign="Middle" Width="80"></Static>
		<Edit AutoSelect="TRUE" BindDataset="dsSendSms" Border="Flat" CheckLength="Byte" Column="SEND_USER_NAME" Height="21" Id="edendUserName" Left="96" LeftMargin="2" MaxLength="100" Readonly="TRUE" Style="snis_if_input01" TabOrder="8" Top="172" Width="96"></Edit>
		<Edit AutoSelect="TRUE" BindDataset="dsSendSms" Border="Flat" CheckLength="Byte" Column="SEND_PHONE_NUMBER" Height="21" Id="edSendPhoneNumber" Left="194" LeftMargin="2" MaxLength="100" Readonly="TRUE" Style="snis_if_input01" TabOrder="9" Top="172" Width="126"></Edit>
		<Grid AutoEnter="TRUE" AutoFit="TRUE" AutoFitEndLine="Hide" BindDataset="dsRecvUser" BKColor="user15" BkColor2="user16" BkSelColor="user17" BoldHead="true" Border="Flat" BorderColor="user22" Bottom="426" ColSizing="TRUE" Editable="TRUE" Enable="true" EndLineColor="default" HeadBorder="Flat" HeadHeight="20" Height="208" Id="grdRecvUser" InputPanel="FALSE" Left="8" LineColor="user18" MinWidth="100" OnHeadClick="fcGridSort" Right="344" SelColor="user19" Style="snis_grid" TabOrder="10" TabStop="true" Top="218" UseDBuff="true" UsePopupMenu="true" UseSelColor="true" Visible="true" VLineColor="default" WheelScrollRow="1" Width="336">
			<contents>
				<format id="Default">
					<columns>
						<col width="29"/>
						<col width="109"/>
						<col width="106"/>
						<col width="226"/>
					</columns>
					<head>
						<cell bkcolor="user20" col="0" color="user21" display="text" text="√"/>
						<cell bkcolor="user20" col="1" color="user21" display="text" font="굴림,9,Bold" text="사용자ID"/>
						<cell bkcolor="user20" col="2" color="user21" display="text" font="굴림,9,Bold" text="사용자명"/>
						<cell bkcolor="user20" col="3" color="user21" display="text" font="굴림,9,Bold" text="이동전화번호"/>
					</head>
					<body>
						<cell col="0" colid="CHK" display="checkbox" edit="checkbox"/>
						<cell align="center" col="1" colid="USER_ID" display="text"/>
						<cell align="center" col="2" colid="USER_NM" display="text"/>
						<cell align="left" col="3" colid="HP_NO" display="text" multiline="true"/>
					</body>
				</format>
			</contents>
		</Grid>
		<Static Font="굴림,10,Bold" Height="22" Id="Static2" Left="23" Style="snis_m_title" TabOrder="11" Text="전송대상&#32;목록" Top="197" VAlign="Middle" Width="105"></Static>
		<Image Height="20" Id="Image0" ImageID="m_titleblet2" Left="10" TabOrder="12" Top="200" Width="8"></Image>
	</Form>
	<Script><![CDATA[
/***************************************************************************************************
*                                         공통 Script Include                                      *
***************************************************************************************************/
#include "lib::can_common_script.js";
#include "lib::can_app_script.js";

/***************************************************************************************************
*                                          화면 변수 선언부                                        *
***************************************************************************************************/
var sFormId       =  this.getform().id;
var sBUTTONLIST   = 'TTTTTT';                          //공통기능정의(버튼순으로 T or F)
var sUSERAUTH     = '';                                //사용자별 프로그램 사용 권한
var sFORMCAPTION  = '';                                //Form의 Title 정보
var sFORMLOCATION = '';                                //Form의 Location 정보
var sUSERLAVEL    = '';                                //Form의 사용  Level
var vREVOBJ       = Array(9);                          //결과값 처리를 위한 오브젝트 
var sGRDTIT       = "";                                //그리드 제목
var sCUROBJ       ;                                    //현재 LOST FOCUS 오브젝트

var sMenuGrpNum     = "0";                         // 메뉴그룹의 갯수보관
var sMenuListNum    = "0";                          // 메뉴리스트의 갯수보관
var sMenuUpId       = "";
var sMenuUpNm       = "";

var sRaceDt       = "";
var sBrncCd       = "";
var sBrncNm       = "";
var sMeetCd		  = "";
var sSeq		  = "";
var sGbn 	  	  = "";
var sUserId 	  = "";
var sSendPhoneNumber 	= "";
var sSendUserId  		= "";
var sSendUserName  		= "";
var sReceivePhoneNumber = "";
var sReceiveName  		= "";
var sReceiveId  		= "";
var sSendSubject  		= "";

/***************************************************************************************************
*                                         공통 Event 처리 부분                                     *
***************************************************************************************************/
/*-------------------------------------------------------------------------------------------------+
>>  최초 화면 Load時 처리 할 사항
+-------------------------------------------------------------------------------------------------*/
function fcFormLoadSetting(obj) { 

	dsSendSms.ClearData();
	var nRow = dsSendSms.AddRow();
	
    dsSendSms.SetColumn(nRow,"SEND_PHONE_NUMBER",sSendPhoneNumber);		// 송신자 번호
    dsSendSms.SetColumn(nRow,"SEND_USER_ID",sSendUserId);					// 송신자 사번
    dsSendSms.SetColumn(nRow,"SEND_USER_NAME",sSendUserName);				// 송신자 성명
    dsSendSms.SetColumn(nRow,"RECEIVE_PHONE_NUMBER",sReceivePhoneNumber);  // 수신자 번호, 여러명인경우 ; 로 구분 
    dsSendSms.SetColumn(nRow,"RECEIVE_NAME",sReceiveName);					// 수신자명, 여러명인경우 ; 로 구분 
    
   dsUserPhone.ClearData();
   var nTmpRow = -1;
   
   var aReceivePhone = split(dsSendSms.GetColumn(0,"RECEIVE_PHONE_NUMBER"),";");
   var aReceiveId = split(sReceiveId,";");
   var aReceiveNm = split(sReceiveName,";");      
   
   for(var i = 0; i < aReceiveId.length;i++){
	  //if (length(trim(aReceivePhone[i])) == 0) continue;
	  nTmpRow = dsUserPhone.AddRow();
	  dsUserPhone.setColumn(nTmpRow,"CHK", "1");
	  dsUserPhone.setColumn(nTmpRow,"USER_ID", aReceiveId[i]);
	  dsUserPhone.setColumn(nTmpRow,"HP_NO"  , aReceivePhone[i]);
	  dsUserPhone.setColumn(nTmpRow,"USER_NM", aReceiveNm[i]);
   }
    
	taSendSubject.SetFocus();
	dsRecvUser.copy(dsUserPhone);
}

/*-------------------------------------------------------------------------------------------------+
>>  최초 화면 UNLoad時 처리 할 사항
+-------------------------------------------------------------------------------------------------*/
function fcFormUnloadProcess(obj) {

}

/*-------------------------------------------------------------------------------------------------+
>>  단축키 처리(Form KeyDown)
+-------------------------------------------------------------------------------------------------*/
function fcHotKey(obj,objSenderObj,nChar,bShift,bControl,bAlt,nLLParam,nHLParam) {

	// Return Key Press時 Next Component focus
	if ( nChar == 13 ) {
		var oFocusComponent = GetNextComponent(true);
		oFocusComponent.setfocus();
		return;
	}

}

/***************************************************************************************************
*                                      공통 버튼 Event 처리 부분                                   *
***************************************************************************************************/

/*-------------------------------------------------------------------------------------------------+
>>  저장 하기전에 필수항목 체크
+-------------------------------------------------------------------------------------------------*/
function fcSaveCheck(obj) {

	// 필수항목체크
	oDataSet          = dsSendSms;
	sMandatoryColID   = "SEND_USER_ID|RECEIVE_PHONE_NUMBER|RECEIVE_NAME|RECEIVE_USER_ID|SEND_PHONE_NUMBER|SEND_SUBJECT";
	sMandatoryColName = "송신자 사번|송신자번호|수신자명|수신자 사번|수신자 번호|전송내용";
	oGrid             = grdSendSms;
	if ( fnc_GetMandatoryViolateRow(oDataSet, sMandatoryColID, sMandatoryColName, oGrid) > -1 ) {
		return false;
	}
	
	
	return true;
}

/*-------------------------------------------------------------------------------------------------+
>>  저장 버튼 클릭 時 처리
+-------------------------------------------------------------------------------------------------*/
function fcSave(obj) {

   var aReceivePhone = split(dsSendSms.GetColumn(0,"RECEIVE_PHONE_NUMBER"),";");
   var aReceiveName = split(dsSendSms.GetColumn(0,"RECEIVE_NAME"),";");
   var aReceiveId = split(sReceiveId,";");
   
   
   var sReceivePhone="";
   var sReceiveName="";
   var sReceiveId ="";
   
   for(var i = 0; i < dsRecvUser.GetRowCount();i++){
	
		if(dsRecvUser.GetColumn(i,"CHK") == "1"){
		
			sReceivePhone += dsRecvUser.GetColumn(i,"HP_NO") +",";
			sReceiveName  += dsRecvUser.GetColumn(i,"USER_NM")+",";
			sReceiveId    += dsRecvUser.GetColumn(i,"USER_ID")+",";
  
		}
   }
   
   if(Length(sReceiveId) >0) {
   
      sReceivePhone= sReceivePhone.SubStr(0,Length(sReceivePhone)-1);
	  sReceiveName=sReceiveName.SubStr(0,Length(sReceiveName)-1);
	  sReceiveId =sReceiveId.SubStr(0,Length(sReceiveId)-1);
	   
	  fcd_SendSms(	 dsSendSms.GetColumn(0,"SEND_PHONE_NUMBER")	    // 송신자 번호
					, dsSendSms.GetColumn(0,"SEND_USER_ID")		    // 송신자 사번 
					, dsSendSms.GetColumn(0,"SEND_USER_NAME")	    // 송신자 성명
					, sReceivePhone      //수신자 번호
					, sReceiveName 	     //수신자명
					, sTitle
					, sReceiveId
					, dsSendSms.GetColumn(0,"SEND_SUBJECT"));
	
	
	   fnc_Message(SNIS_COM_1037,"N","SMS 전송");
	  
	   
	   fcEnd();			
   }
 
 
 
}




/*-------------------------------------------------------------------------------------------------+
>>  화면 종료(닫기) 버튼 클릭 時 처리
+-------------------------------------------------------------------------------------------------*/
function fcEnd(obj) {
	// 화면 종료
	Close();
}




/***************************************************************************************************
*                                      사용자 정의  처리 부분                                      *
***************************************************************************************************/
/*-------------------------------------------------------------------------------------------------+
>>  Transaction 후 처리 해야 할 내용!
+-------------------------------------------------------------------------------------------------*/
function fcCallBack(sServiceName, ErrorCode, ErrorMSG) {
	if ( !fnc_result(ErrorCode, ErrorMSG) ) return;
	

}
]]></Script>
</Window>