<!DOCTYPE html>
<html lang="en">

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

	<title>발그레 | 관리자페이지</title>
   	
   	#parse ("/advertiser/layout/common_css.vm")	
   	
   	<link href="https://cdn.datatables.net/1.10.13/css/jquery.dataTables.min.css" rel="stylesheet">
   	<link href="https://cdn.datatables.net/buttons/1.2.4/css/buttons.dataTables.min.css" rel="stylesheet">
   	<link href="https://cdn.datatables.net/buttons/1.2.4/css/buttons.bootstrap.min.css" rel="stylesheet">
   	<link href="https://cdn.datatables.net/select/1.2.1/css/select.dataTables.min.css" rel="stylesheet">
	<link href="https://cdn.datatables.net/responsive/2.0.2/css/responsive.dataTables.min.css" rel="stylesheet" />
</head>

<body class="nav-md footer_fixed">
	<div class="container body">
		<div>
			#parse ("/advertiser/layout/header.vm")
			<!-- page content -->
			<div class="right_col" role="main">
				<div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>결제내역 <small>목록</small></h2>
                    <ul class="nav navbar-right">
                    </ul>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <table id="datatables" class="table table-striped table-bordered dt-responsive nowrap" cellspacing="0" width="100%">
                      <thead>
                        <tr>
                        	<th>주문ID</th>
                        	<th>제품명</th>
            			    <th>옵션명</th>
            			    <th>금액</th>
            			    <th>수량</th>
            			    <th>주문자</th>
            			    <th>이메일</th>
            			    <th>전화번호</th>
            			    <th>우편번호</th>
            			    <th>주소</th>
            			    <th>배송요청사항</th>
            			    <th>송장번호</th>
            			    <th>택배사</th>
            			    <th>공급가</th>
            			    <th>주문일</th>
                        </tr>
                      </thead>
                      <tbody>	
                      	<tr>
                      		<td></td>
                      		<td></td>
                      		<td></td>
                      		<td></td>
                      		<td></td>
            			    <td></td>
            			    <td></td>
            			    <td></td>
                      		<td></td>
                      		<td></td>
            			    <td></td>
            			    <td></td>
            			    <td></td>
            			    <td></td>
            			    <td></td>
                        </tr>
                      </tbody>
                    </table>
              </div>
			</div>
			</div>
		</div>
		<!-- page content end-->
		#parse ("/advertiser/layout/footer.vm")
	</div>
</div>
		#parse ("/advertiser/layout/common_js.vm")
	<script src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/buttons/1.2.4/js/dataTables.buttons.min.js"></script>
	<script src="https://cdn.datatables.net/buttons/1.2.4/js/buttons.flash.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js"></script>
	<script src="https://cdn.datatables.net/buttons/1.2.4/js/buttons.html5.min.js"></script>
	<script src="https://cdn.datatables.net/buttons/1.2.4/js/buttons.print.min.js"></script>
	<script src="https://cdn.datatables.net/select/1.2.1/js/dataTables.select.min.js"></script>
	<script src="https://cdn.datatables.net/responsive/2.0.2/js/dataTables.responsive.min.js"></script>
    <script>
    var myTable;
    var itemTable;
    $(document).ready(function() {
        myTable = $('#datatables').DataTable({
        	dom: 'Bfrtip',
            buttons: [
                'pageLength','copy', 'excel', 'print'
                #if($!{type} == "E" || $!{type} == "D")
                ,{
		              text: '송장번호 입력',
		              action: function ( e, dt, button, config ) {
		            	 var rowData = myTable.rows( '.selected' ).data().toArray();
		            	 addDelivery(rowData);
		              }
		          }
                #end
                #if($!{type} == "D" || $!{type} == "P" )
                ,{
		              text: '주문 확인',
		              action: function ( e, dt, button, config ) {
		            	 var rowData = myTable.rows( '.selected' ).data().toArray();
		            	 addConfirm(rowData);
		              }
		          }
                #end
            ],
			stateSave: true,	
          	"processing": true,
          	"serverSide": true,
          	"order": [],
          	"lengthChange": true,
          	"pageLength": 50,
          	"ajax": {
          		"url": "list_processing?type=$!{type}",
          		"data": function(data) {
          			planify(data);
                },
                dataSrc: function(d){
                    return d.data;    
                }
          	},
          	select:true,
          	columns: [
					{"data": "paymentId", "name": "paymentId"},
					{"data": "prodName", "name": "prodName"},
					{"data": "itemName", "name": "itemName"},
					{"data": "amount", "name": "amount"},
					{"data": "orderCount", "name": "orderCount"},
					{"data": "buyer_name", "name": "buyer_name"},
					{"data": "buyer_email", "name": "buyer_email"},
					{"data": "buyer_tel", "name": "buyer_tel"},
					{"data": "buyer_postcode", "name": "buyer_postcode"},
					{"data": "buyer_addr", "name": "buyer_addr"},
					{"data": "note", "name": "note"},
					{"data": "deliveryNumber", "name": "deliveryNumber"},
					{"data": "deliveryName", "name": "deliveryName"},
					{"data": "supply_price", "name": "supply_price"},
					{"data": "regDate", "name": "regDate"}
				],
				"columnDefs": [
							{
							   "targets": 0,//index of column starting from 0
							    "data": "paymentId", //this name should exist in your JSON response
							    "render": function ( data, type, full, meta ) {
							    	return data + "_" + full.piId;		
							    }
							},
							{
			  				   "targets": 14,//index of column starting from 0
			  				    "data": "regDate", //this name should exist in your JSON response
			  				    "render": function ( data, type, full, meta ) {
			  				    	return new Date(data).format("yyyy-MM-dd HH:mm:ss");		
			  				    }
			  				}
					],
					responsive: {
				        details: {
				            display: $.fn.dataTable.Responsive.display.modal()
				        }
				    }
        });
        
        
        myTable.on( 'select', function () {
            var selectedRows = myTable.rows( { selected: true } ).count();
            
            if(selectedRows > 0) { 
//            	myTable.button( 5 ).enable();
//            	myTable.button( 4 ).enable();
            }
            
           
            e();
        } );
        
        myTable.on( 'deselect', function () {
            var selectedRows = myTable.rows( { selected: true } ).count();
  
            
            if(selectedRows > 0) { 
//            	myTable.button( 4 ).enable();
            }
            e();
        } );
        
    } );
    
    function planify(data) {
        for (var i = 0; i < data.columns.length; i++) {
            column = data.columns[i];
            column.searchRegex = column.search.regex;
            column.searchValue = column.search.value;
            delete(column.search);
        }
    }

    function addConfirm(rowData) {
    	bootbox.prompt({
    	    title: "주문 확인 상태를 선택하세요.",
    	    inputType: 'select',
    	    inputOptions: [
	             {
	       	            text: '선택하세요.',
	       	            value: ''
	       	     },
    	        {
    	            text: '주문 확인',
    	            value: '1'
    	        },
    	        {
    	            text: '주문 확인 취소',
    	            value: '0',
    	        }
    	    ],
    	    callback: function (result) {
    	    	if(result) {
    	    		$.ajax({
    	    			url: "prodConfirm?status=" + result,
    	    			contentType: 'application/json',
    	    		    mimeType: 'application/json',
    	    		    dataType: 'json', 
    	    		    data: JSON.stringify(rowData), 
    	    			type: 'POST',
    	    			success: function(result){
    	    				if(result.resultCode == 200) {
    	    					myTable.ajax.reload();
    	    				} else {
    	    					bootbox.alert(result.message, function() {});
    	    				}
    	    			},
    	    			error: function(){
    	    				bootbox.alert("오류가 발생였습니다.\n잠시 후 다시 시도해 주세요.", function() {});
    	    			}
    	    		});
    	    	}
    	    }
    	});
    }
    
    function addDelivery(rowData) {
    	var delCode = "01";
		if(rowData[0].deliveryCode) {
			delCode = rowData[0].deliveryCode;			
		}    	
		
    	bootbox.prompt({
    	    title: "택배사를 선택하세요.",
    	    inputType: 'select',
    	    buttons: {
    	        confirm: {
    	            label: '다음',
    	            className: 'btn-success'
    	        },
    	        cancel: {
    	            label: '취소',
    	            className: 'btn-danger'
    	        }
    	    },
    	    inputOptions: [
    	         #foreach($dv in $!{delivery}) 
	    	        {
	    	            text: '$!{dv.name}',
	    	            value:'$!{dv.code}'
	    	        } #if( $foreach.hasNext ), #end
    	         #end
    	    ],
    	    value: delCode,
    	    callback: function (result) {
    	    	if(result) {
    	    		delCode = result;
    	    		bootbox.prompt("운송장번호를 입력하세요.", function(result){ 
    	    			console.log(result); 
    	    			if(result) {
    	    				saveDelivery(rowData, delCode, result);
    	    			}
    	    		});
    	    	}
    	    }
    	});
    }
    
    function saveDelivery(rowData, code, num) {
    	$.ajax({
			url: "saveDelivery?code=" + code + "&number=" + num,
			contentType: 'application/json',
		    mimeType: 'application/json',
		    dataType: 'json', 
		    data: JSON.stringify(rowData), 
			type: 'POST',
			success: function(result){
				if(result.resultCode == 200) {
					myTable.ajax.reload();
				} else {
					bootbox.alert(result.message, function() {});
				}
			},
			error: function(){
				bootbox.alert("오류가 발생였습니다.\n잠시 후 다시 시도해 주세요.", function() {});
			}
		});
    }
    </script>
    <!-- /Datatables -->
    
</body>
</html>