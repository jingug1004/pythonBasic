<!DOCTYPE html>
<html lang="en">

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>발그레 | 관리자페이지</title>

	#parse ("/admin/layout/common_css.vm")
    <!-- Summernote -->
    <link href="/vendors/summernote/summernote.css" rel="stylesheet">
    <!-- cropper -->
    <link href="/vendors/cropper/dist/cropper.min.css" rel="stylesheet">
    
    <style type="text/css">
    	div.detail_note{
		    border-radius: 15px;
		    display: inline-block;
		    font-size: 15px;
		    margin: 15px 0;
		    padding: 3px 10px;
		   font-weight: bold;
		}
		
		.main_color{
		   color: #FFFFFF;
		   background: #6fc5db;
		   border: 0px;
		}
    </style>
  </head>

<body class="nav-md">
	<div class="container body">
		<div class="main_container">
			#parse ("/admin/layout/header.vm")
			<!-- page content -->
			<div class="right_col" role="main">
            	<div class="clearfix"></div>
            		<div class="row">
						<div class="col-md-12 col-sm-12 col-xs-12">
                			<div class="x_panel">
                  				<div class="x_title">
                    				<h2>기획전 <small>등록</small></h2>
                    				<div class="clearfix"></div>
                  				</div>
                  			<div class="x_content">
                    			<form class="form-horizontal form-label-left" id="dForm">
                    				<input type="hidden" name="pid" value="$!{plan.pid}"/>
                    				<input type="hidden" name="action" value="$!{action}"/>
  	              					<div id="def_p" class="form-group">
                        				<label class="control-label col-md-2 col-sm-2 col-xs-12">기획전 명 <span class="required">*</span></label>
                         				<div class="col-md-10 col-sm-10 col-xs-12">
			              					<input type="text" id="title" name="title" class="form-control" placeholder="기획전 명을 입력하세요." required="required" value="$!{plan.title}">
			            				</div>
                      				</div>
                      				#if ($!plan.thumbnail)
                      				<div class="form-group">
                        				<label class="control-label col-md-2 col-sm-2 col-xs-12">등록된 썸네일 <span class="required">*</span></label>
                        				<div class="col-md-8 col-sm-8 col-xs-12">
        	              					<img src="$!{image_url}$!{plan.thumbnail}" alt="Picture" width="300px">
            		    				</div>
            		  				</div>
                      				#end
                      				<div class="form-group">
                        				<label class="control-label col-md-2 col-sm-2 col-xs-12" for="subject">썸네일 <span class="required">*</span></label>
                        				<div class="col-md-10 col-sm-10 col-xs-12">
                            			<!-- image cropping -->
		                				<div class="container cropper">
		                  				<div class="row">
		                    				<div class="col-md-12 col-xs-12">
		                      					<div class="img-container">
		                        					<img id="image" alt="Picture">
		                      					</div>
		                    				</div>
		                  				</div>
										<div class="row">
					                    	<div class="col-md-12 docs-buttons">
					                      	<!-- <h3 class="page-header">Toolbar:</h3> -->
					                      	<div class="btn-group">
					                        <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="move" title="Move">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;setDragMode&quot;, &quot;move&quot;)">
					                            <span class="fa fa-arrows"></span>
					                          </span>
					                        </button>
					                        <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="crop" title="Crop">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;setDragMode&quot;, &quot;crop&quot;)">
					                            <span class="fa fa-crop"></span>
					                          </span>
					                        </button>
					                      </div>
					
					                      <div class="btn-group">
					                        <button type="button" class="btn btn-primary" data-method="zoom" data-option="0.1" title="Zoom In">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;zoom&quot;, 0.1)">
					                            <span class="fa fa-search-plus"></span>
					                          </span>
					                        </button>
					                        <button type="button" class="btn btn-primary" data-method="zoom" data-option="-0.1" title="Zoom Out">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;zoom&quot;, -0.1)">
					                            <span class="fa fa-search-minus"></span>
					                          </span>
					                        </button>
					                      </div>
					
					                      <div class="btn-group">
					                        <button type="button" class="btn btn-primary" data-method="move" data-option="-10" data-second-option="0" title="Move Left">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;move&quot;, -10, 0)">
					                            <span class="fa fa-arrow-left"></span>
					                          </span>
					                        </button>
					                        <button type="button" class="btn btn-primary" data-method="move" data-option="10" data-second-option="0" title="Move Right">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;move&quot;, 10, 0)">
					                            <span class="fa fa-arrow-right"></span>
					                          </span>
					                        </button>
					                        <button type="button" class="btn btn-primary" data-method="move" data-option="0" data-second-option="-10" title="Move Up">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;move&quot;, 0, -10)">
					                            <span class="fa fa-arrow-up"></span>
					                          </span>
					                        </button>
					                        <button type="button" class="btn btn-primary" data-method="move" data-option="0" data-second-option="10" title="Move Down">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;move&quot;, 0, 10)">
					                            <span class="fa fa-arrow-down"></span>
					                          </span>
					                        </button>
					                      </div>
					
					                      <div class="btn-group">
					                        <button type="button" class="btn btn-primary" data-method="rotate" data-option="-45" title="Rotate Left">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;rotate&quot;, -45)">
					                            <span class="fa fa-rotate-left"></span>
					                          </span>
					                        </button>
					                        <button type="button" class="btn btn-primary" data-method="rotate" data-option="45" title="Rotate Right">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;rotate&quot;, 45)">
					                            <span class="fa fa-rotate-right"></span>
					                          </span>
					                        </button>
					                      </div>
					
					                      <div class="btn-group">
					                        <button type="button" class="btn btn-primary" data-method="scaleX" data-option="-1" title="Flip Horizontal">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;scaleX&quot;, -1)">
					                            <span class="fa fa-arrows-h"></span>
					                          </span>
					                        </button>
					                        <button type="button" class="btn btn-primary" data-method="scaleY" data-option="-1" title="Flip Vertical">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;scaleY&quot;, -1)">
					                            <span class="fa fa-arrows-v"></span>
					                          </span>
					                        </button>
					                      </div>
					
					                      <div class="btn-group">
					                        <button type="button" class="btn btn-primary" data-method="crop" title="Crop">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;crop&quot;)">
					                            <span class="fa fa-check"></span>
					                          </span>
					                        </button>
					                        <button type="button" class="btn btn-primary" data-method="clear" title="Clear">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;clear&quot;)">
					                            <span class="fa fa-remove"></span>
					                          </span>
					                        </button>
					                      </div>
					
					                      <div class="btn-group">
					                        <button type="button" class="btn btn-primary" data-method="disable" title="Disable">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;disable&quot;)">
					                            <span class="fa fa-lock"></span>
					                          </span>
					                        </button>
					                        <button type="button" class="btn btn-primary" data-method="enable" title="Enable">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;enable&quot;)">
					                            <span class="fa fa-unlock"></span>
					                          </span>
					                        </button>
					                      </div>
					
					                      <div class="btn-group">
					                        <button type="button" class="btn btn-primary" data-method="reset" title="Reset">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;reset&quot;)">
					                            <span class="fa fa-refresh"></span>
					                          </span>
					                        </button>
					                        <label class="btn btn-primary btn-upload" for="inputImage" title="Upload image file">
					                          <input type="file" class="sr-only" id="inputImage" name="file" accept="image/*">
					                          <span class="docs-tooltip" data-toggle="tooltip" title="Import image with Blob URLs">
					                            <span class="fa fa-upload"></span>
					                          </span>
					                        </label>
					                      </div>
					                    </div><!-- /.docs-buttons -->
					                  </div>
			                			</div>
			                			<!-- /image cropping -->
                        				</div>
                      				</div>
        	              			<div class="ln_solid"></div>
                      				<div class="form-group">
                        				<div class="col-md-6 col-md-offset-3">
                        					<button type="button" class="btn btn-primary" onclick="javascript:history.back();">취소</button>
                        					#if($action == 'update')
                          						<button id="send" type="submit" class="btn btn-success">수정하기</button>
                          					#else
                          						<button id="send" type="submit" class="btn btn-success">등록하기</button>
                          					#end
                        				</div>
                      				</div>
                    			</form>
                  			</div>
                		</div>
              		</div>
            	</div>
        	</div>
        	<!-- /page content -->
		#parse ("/admin/layout/footer.vm")
	</div>
</div>

	#parse ("/admin/layout/common_js.vm")
	<!-- Cropper -->
    <script src="/vendors/cropper/dist/cropper.min.js"></script>
	
    <!-- Cropper -->
    <script>
      $(document).ready(function() {
        var image = $('#image');
        var dataX = $('#dataX');
        var dataY = $('#dataY');
        var dataHeight = $('#dataHeight');
        var dataWidth = $('#dataWidth');
        var dataRotate = $('#dataRotate');
        var dataScaleX = $('#dataScaleX');
        var dataScaleY = $('#dataScaleY');
        var options = {
             // aspectRatio: 4 / 3,
              preview: '.img-preview',
              crop: function (e) {
                dataX.val(Math.round(e.x));
                dataY.val(Math.round(e.y));
                dataHeight.val(Math.round(e.height));
                dataWidth.val(Math.round(e.width));
                dataRotate.val(e.rotate);
                dataScaleX.val(e.scaleX);
                dataScaleY.val(e.scaleY);
              }
            };


        // Tooltip
        $('[data-toggle="tooltip"]').tooltip();


        // Cropper
        image.on({
          'build.cropper': function (e) {
            console.log(e.type);
          },
          'built.cropper': function (e) {
            console.log(e.type);
          },
          'cropstart.cropper': function (e) {
            console.log(e.type, e.action);
          },
          'cropmove.cropper': function (e) {
            console.log(e.type, e.action);
          },
          'cropend.cropper': function (e) {
            console.log(e.type, e.action);
          },
          'crop.cropper': function (e) {
            console.log(e.type, e.x, e.y, e.width, e.height, e.rotate, e.scaleX, e.scaleY);
          },
          'zoom.cropper': function (e) {
            console.log(e.type, e.ratio);
          }
        }).cropper(options);


        // Buttons
        if (!$.isFunction(document.createElement('canvas').getContext)) {
          $('button[data-method="getCroppedCanvas"]').prop('disabled', true);
        }

        if (typeof document.createElement('cropper').style.transition === 'undefined') {
          $('button[data-method="rotate"]').prop('disabled', true);
          $('button[data-method="scale"]').prop('disabled', true);
        }

        // Options
        $('.docs-toggles').on('change', 'input', function () {
          var name = $(this).attr('name');
          var type = $(this).prop('type');
          var cropBoxData;
          var canvasData;

          if (!image.data('cropper')) {
            return;
          }

          if (type === 'checkbox') {
            options[name] = $(this).prop('checked');
            cropBoxData = image.cropper('getCropBoxData');
            canvasData = image.cropper('getCanvasData');

            options.built = function () {
              image.cropper('setCropBoxData', cropBoxData);
              image.cropper('setCanvasData', canvasData);
            };
          } else if (type === 'radio') {
            options[name] = $(this).val();
          }

          image.cropper('destroy').cropper(options);
        });


        // Methods
        $('.docs-buttons').on('click', '[data-method]', function () {
          var data = $(this).data();
          var target;
          var result;

          if ($(this).prop('disabled') || $(this).hasClass('disabled')) {
            return;
          }

          if (image.data('cropper') && data.method) {
            data = $.extend({}, data); // Clone a new one

            if (typeof data.target !== 'undefined') {
              target = $(data.target);

              if (typeof data.option === 'undefined') {
                try {
                  data.option = JSON.parse($target.val());
                } catch (e) {
                  console.log(e.message);
                }
              }
            }

            result = image.cropper(data.method, data.option, data.secondOption);

            switch (data.method) {
              case 'scaleX':
              case 'scaleY':
                $(this).data('option', -data.option);
                break;
            }

            if ($.isPlainObject(result) && $target) {
              try {
                target.val(JSON.stringify(result));
              } catch (e) {
                console.log(e.message);
              }
            }

          }
        });

        // Keyboard
        $(document.body).on('keydown', function (e) {
          if (!image.data('cropper') || this.scrollTop > 300) {
            return;
          }

          switch (e.which) {
            case 37:
              e.preventDefault();
              image.cropper('move', -1, 0);
              break;

            case 38:
              e.preventDefault();
              image.cropper('move', 0, -1);
              break;

            case 39:
              e.preventDefault();
              image.cropper('move', 1, 0);
              break;

            case 40:
              e.preventDefault();
              image.cropper('move', 0, 1);
              break;
          }
        });

        // Import image
        var inputImage = $('#inputImage');
        var URL = window.URL || window.webkitURL;
        var blobURL;

        if (URL) {
          inputImage.change(function () {
            var files = this.files;
            var file;

            if (!image.data('cropper')) {
              return;
            }

            if (files && files.length) {
              file = files[0];

              if (/^image\/\w+$/.test(file.type)) {
                blobURL = URL.createObjectURL(file);
                image.one('built.cropper', function () {

                  // Revoke when load complete
                  URL.revokeObjectURL(blobURL);
                }).cropper('reset').cropper('replace', blobURL);
                inputImage.val('');
              } else {
                window.alert('Please choose an image file.');
              }
            }
          });
        } else {
          inputImage.prop('disabled', true).parent().addClass('disabled');
        }
      });
    </script>
    <!-- /Cropper -->
	<!-- validator -->
	<script>
      // initialize the validator function
      validator.message.date = 'not a real date';

      // validate a field on "blur" event, a 'select' on 'change' event & a '.reuired' classed multifield on 'keyup':
      $('form')
        .on('blur', 'input[required], input.optional, select.required', validator.checkField)
        .on('change', 'select.required', validator.checkField)
        .on('keypress', 'input[required][pattern]', validator.keypress);

      $('.multi.required').on('keyup blur', 'input', function() {
        validator.checkField.apply($(this).siblings().last()[0]);
      });

      $('form').submit(function(e) {
        e.preventDefault();
        var submit = true;

        // evaluate the form using generic validaing
        if (!validator.checkAll($(this))) {
          submit = false;
        }
        
        if (submit) {
			insertData();
        }
        	
          //this.submit();

        return false;
      });
      
	function insertData() {

		var params = $("#dForm").serializeObject();
		
		var result = $('#image').cropper("getCroppedCanvas");
  		if(result.toDataURL) {
  			params.thumbUrl = result.toDataURL();
  		} else {
  			if("$!{action}" == "write") {
  				bootbox.alert("썸네일을 등록해 주세요.", function() {});
  				return;
  			}
  		}
  		
  		
  		console.log(params);
		$.ajax({
			type: 'POST',
		    url: "save",
		    contentType: 'application/json',
		    mimeType: 'application/json',
		    dataType: 'json', 
		    data: JSON.stringify(params),
	        success: function(result){
	        	if(result.resultCode == 200) {
	        		bootbox.alert(result.message, function() {
						history.back();
					});
    			} else {
    				bootbox.alert(result.message, function() {});
    			}
		     },
			 error: function(){
				bootbox.alert("오류가 발생였습니다.\n잠시 후 다시 시도해 주세요.", function() {});
			 }
	  	});
    }
    </script>
    <!-- /validator -->
</body>
</html>