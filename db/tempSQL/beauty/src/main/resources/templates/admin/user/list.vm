<!DOCTYPE html>
<html lang="en">

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

   	#parse ("/admin/layout/common_css.vm")	
    <!-- Datatables -->
   	<link href="https://cdn.datatables.net/1.10.13/css/jquery.dataTables.min.css" rel="stylesheet">
   	<link href="https://cdn.datatables.net/buttons/1.2.4/css/buttons.dataTables.min.css" rel="stylesheet">
   	<link href="https://cdn.datatables.net/buttons/1.2.4/css/buttons.bootstrap.min.css" rel="stylesheet">
   	<link href="https://cdn.datatables.net/select/1.2.1/css/select.dataTables.min.css" rel="stylesheet">
	<link href="https://cdn.datatables.net/responsive/2.0.2/css/responsive.dataTables.min.css" rel="stylesheet" />
    
  </head>

<body class="nav-md">
	<div class="container body">
		<div class="main_container">
			#parse ("/admin/layout/header.vm")
			<!-- page content -->
			<div class="right_col" role="main">
				<div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>
                    	#if(${type} == "u")
                    		#if(${role} == 1) 관리자
                    		#elseif(${role} == 2) 업체
                    		#elseif(${role} == 3) 회원
                    		#else 회원
                    		#end
                    	#elseif(${type} == "l")탈퇴 회원
                    	#end
                    	<small>목록</small></h2>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <table id="datatables" class="table table-striped table-bordered dt-responsive nowrap" cellspacing="0" width="100%">
                      <thead>
                        <tr>
                          <th>EMAIL</th>
                          <th>추천코드</th>
                          <th>이름</th>
                          <th>성별</th>
                          <th>생년월일</th>
                          <th>전화번호</th>
                          <th>피부</th>
                          <th>가입</th>
                          <th>SMS수신</th>
                          <th>이메일수신</th>
                          <th>가입일</th>
                        </tr>
                      </thead>
                      <tbody>
                      	<tr>
                      		<td></td>
                      		<td></td>
                      		<td></td>
                      		<td></td>
                      		<td></td>
                      		<td></td>
                      		<td></td>
                      		<td></td>
                      		<td></td>
                      		<td></td>
                      		<td></td>
                      	</tr>
                      </tbody>
                    </table>

                  </div>
              </div>
			</div>
			#parse ("/admin/user/device_modal.vm")
			#parse ("/admin/user/point_modal.vm")
			#parse ("/admin/user/user_modal.vm")
		</div>
		<!-- page content end-->
		#parse ("/admin/layout/footer.vm")
	</div>
</div>
	#parse ("/admin/layout/common_js.vm")
    <!-- Datatables -->
	<script src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/buttons/1.2.4/js/dataTables.buttons.min.js"></script>
	<script src="https://cdn.datatables.net/select/1.2.1/js/dataTables.select.min.js"></script>
	<script src="https://cdn.datatables.net/responsive/2.0.2/js/dataTables.responsive.min.js"></script>
    <script>
 	var myTable;
    $(document).ready(function() {
        myTable = $('#datatables').DataTable({
        	 dom: 'Bfrtip',
			stateSave: true,	
          	"processing": true,
          	"serverSide": true,
          	"order": [],
          	"ajax": {
          		"url": "list_processing?type=$!{type}&role=$!{role}",
          		"data": function(data) {
          			planify(data);
                }
          	},
          	select:true,
          	columns: [
  					{"data": "email", "name": "email"},
  					{"data": "myCode", "name": "myCode"},
  					{"data": "name", "name": "name"},
  					{"data": "gender", "name": "gender"},
  					{"data": "birthday", "name": "birthday"},
  					{"data": "phone", "name": "phone"},
  					{"data": "skinType", "name": "skinType"},
  					{"data": "joinType", "name": "joinType"},
  					{"data": "smsAgree", "name": "smsAgree"},
  					{"data": "emailAgree", "name": "emailAgree"},
  					{"data": "regDate", "name": "regDate"}
  			],
  			"columnDefs": [
				{
  				   "targets": 3,//index of column starting from 0
  				    "data": "gender", //this name should exist in your JSON response
  				    "render": function ( data, type, full, meta ) {
  				    	if(data == 'F') {
  				    		 return '<span class="label label-danger">여성</span>';		
  				    	} else {
  				    		 return '<span class="label label-primary">남성</span>';
  				    	}
  				    }
  				},
  				{
    				   "targets": 6,//index of column starting from 0
    				    "data": "skinType", //this name should exist in your JSON response
    				    "render": function ( data, type, full, meta ) {
    				    	if(data == 0) {
    				    		 return '<span class="label label-success">건성</span>';		
    				    	} else if(data == 1) {
    				    		 return '<span class="label label-info">중성</span>';		
    				    	} else if(data == 2) {
    				    		 return '<span class="label label-warning">지성</span>';		
    				    	} else {
    				    		 return '<span class="label label-danger">복합성</span>';
    				    	}
    				     
    				    }
    			},
  				{
   				   "targets": 7,//index of column starting from 0
   				    "data": "joinType", //this name should exist in your JSON response
   				    "render": function ( data, type, full, meta ) {
   				    	if(data == 'N') {
   				    		 return '<span class="label label-success">네이버</span>';		
   				    	} else if(data == 'F') {
   				    		 return '<span class="label label-primary">페이스북</span>';		
   				    	} else if(data == 'K') {
   				    		 return '<span class="label label-warning">카카오톡</span>';		
   				    	} else {
   				    		 return '<span class="label label-default">기타</span>';
   				    	}
   				     
   				    }
   				},
  				{
    				   "targets": 8,//index of column starting from 0
    				    "data": "joinType", //this name should exist in your JSON response
    				    "render": function ( data, type, full, meta ) {
      				    	if(data == 'Y') {
      				    		 return '<span class="label label-success">동의</span>';		
      				    	} else {
      				    		return '<span class="label label-danger">미동의</span>';
      				    	}
    				    }
    			},
  				{
   				   "targets": 9,//index of column starting from 0
   				    "data": "joinType", //this name should exist in your JSON response
   				    "render": function ( data, type, full, meta ) {
   				    	if(data == 'Y') {
   				    		return '<span class="label label-success">동의</span>';		
   				    	} else {
   				    	 	return '<span class="label label-danger">미동의</span>';
   				    	}
   				    }
   				},
  				{
   				   "targets": 10,//index of column starting from 0
   				    "data": "regDate", //this name should exist in your JSON response
   				    "render": function ( data, type, full, meta ) {
   				    	e();
   				    	return new Date(data).format("yy-MM-dd HH:mm:ss");
   				    }
   				}
			],
			buttons: [
				'pageLength',
				{
      				text: '상세정보',
      				enabled: false,
      				action: function ( e, dt, button, config ) {
      					var rowData = myTable.rows( '.selected' ).data().toArray();
      					openUserDetail(rowData[0].userId);
      				}
  				},
  				{
      				text: '포인트',
      				enabled: false,
      				action: function ( e, dt, button, config ) {
    	  				var rowData = myTable.rows( '.selected' ).data().toArray();
    	  				openUserPoint(rowData[0].userId);
      				}
  				},
  				{
      				text: '추천인',
      				enabled: false,
      				action: function ( e, dt, button, config ) {
    	  				var rowData = myTable.rows( '.selected' ).data().toArray();
    	  				location.href="update?eid=" + rowData[0].eid;
      				}
  				},
  				{
      				text: '디바이스',
      				enabled: false,
      				action: function ( e, dt, button, config ) {
    	  				var rowData = myTable.rows( '.selected' ).data().toArray();
    	  				openDeviceInfo(rowData[0].userId);
      				}
  				}
			],
			responsive: true
        });
        
        myTable.on( 'select', function () {
            var selectedRows = myTable.rows( { selected: true } ).count();
            if(${role} == 3 || ${role} == 0) {
            	myTable.button( 4 ).enable( selectedRows === 1 );
            	myTable.button( 3 ).enable( selectedRows === 1 );
            	myTable.button( 2 ).enable( selectedRows === 1 );
            }
            myTable.button( 1 ).enable( selectedRows === 1 );
        } );
        
        myTable.on( 'deselect', function () {
            var selectedRows = myTable.rows( { selected: true } ).count();
            if(selectedRows == 0) {
            	if(${role} == 3 || ${role} == 0) {
        	    	myTable.button( 4 ).disable();
    	        	myTable.button( 3 ).disable();
	           		myTable.button( 2 ).disable();
            	}
           		myTable.button( 1 ).disable();
            }
            
            if(selectedRows == 1) { 
            	 if(${role} == 3 || ${role} == 0) {
            		myTable.button( 4 ).enable();
            		myTable.button( 3 ).enable();
            		myTable.button( 2 ).enable();
            	}
            	myTable.button( 1 ).enable();
            }
        } );
        if(${role} != 3 && ${role} != 0) {
        	myTable.button(4).remove();
        	myTable.button(3).remove();
        	myTable.button(2).remove();
        	
        }
    } );
    
    function planify(data) {
        for (var i = 0; i < data.columns.length; i++) {
            column = data.columns[i];
            column.searchRegex = column.search.regex;
            column.searchValue = column.search.value;
            delete(column.search);
        }
    }
      
      function openUserPoint(user_id) {
    	  $("#point_table tr:not(:first)").remove();
    	  ///admin/point/user?user_id=$!{user.id}
    	  $.ajax({
  		     type: "GET",
  		     url: "/admin/point/user?user_id="+user_id,
  		     data:null,
  	         success: function(data){
  	        	$('#user_point').text(data.user.name + " 포인트 내역");
  	        	$('#totalPoint').text(data.totalPoint + " Point / " + data.usePoint + " Point / " + data.myPoint + " Point");
  	        	var list = data.userPoint;
  	        	
  	        	var str;
  	        	for(i=0; i<list.length; i++) {
  	        		str = "";
  	        		str += "<tr><td>";
  	        		str += list[i].point;
  	        		str += "</td><td>";
  	        		str += list[i].note;
  	        		str += "</td><td>";
  	        		str += new Date(list[i].regDate).format("yy/MM/dd HH:mm:ss");
  	        		str += "</td></tr>";
  	        		
  	        		$("#point_table > tbody:last").append(str);
  	        	}
  	        	
				$('#point_modal').modal();
  		     },
  			 error: function(){
  				bootbox.alert("오류가 발생였습니다.\n잠시 후 다시 시도해 주세요.", function() {});
  			 }
  	  	  });
      }
      
      function openDeviceInfo(user_id) {
    	  $("#device_table tr:not(:first)").remove();
    	  ///admin/point/user?user_id=$!{user.id}
    	  $.ajax({
  		     type: "GET",
  		     url: "getDevice?user_id="+user_id,
  		     data:null,
  	         success: function(data){
  	        	//var list = data.length;
  	        	var str;
  	        	for(i=0; i<data.length; i++) {
  	        		str = "";
  	        		str += "<tr><td>";
  	        		str += data[i].deviceId;
  	        		str += "</td><td>";
  	        		str += data[i].os;
  	        		str += "</td><td>";
  	        		str += data[i].osVersion;
  	        		str += "</td><td>";
  	        		str += data[i].modelName;
  	        		str += "</td><td>";
  	        		str += data[i].appVersion;
  	        		str += "</td><td>";
  	        		str += new Date(data[i].regDate).format("yy/MM/dd HH:mm:ss");
  	        		str += "</td></tr>";
  	        		
  	        		$("#device_table > tbody:last").append(str);
  	        	}
  	        	
				$('#device_modal').modal();
  		     },
  			 error: function(){
  				bootbox.alert("오류가 발생였습니다.\n잠시 후 다시 시도해 주세요.", function() {});
  			 }
  	  	  });
      }
      
      
      function openUserDetail(user_id) {
    	  $.ajax({
 		     type: "GET",
 		     url: "getUser?user_id="+user_id,
 		     data:null,
 	         success: function(user){
 	        	$('#name').text(user.name);
 	        	$('#user_id').val(user.userId);
 	        	if(user.gender == "F") {
 	        		$('#gender').text("여자");
 	        	} else if(user.gender == "M") {
 	        		$('#gender').text("남자");
 	        	} else {
 	        		$('#gender').text("알수없음");
 	        	}
 	        	
 	        	$('#birthday').text(user.birthday + " ( " + user.age + "세 )");
 	        	$('#email').text(user.email);
 	        	$('#phone').text(user.phone);
 	        	$('#regDate').text(new Date(user.regDate).format("yyyy-MM-dd HH:mm:ss"));
        		for(i=0;i<user.roles.length; i++) {
	        		if(user.roles[i].role == "ADMIN") {
	        			$('#role').text("관리자");
	        		} else if(user.roles[i].role == "ADVERTISER") {
	        			$('#role').text("업체");	
	        		} else {
	        			$('#role').text("일반");
	        		}
 	        	}
 	        	
 	        	if("$!{type}" == "l") {
 	        		$('#reason').text(user.reason);
 	        		$('#delDate').text(new Date(user.delDate).format("yyyy-MM-dd HH:mm:ss"));
 	        	}
 	        	$('#user_modal').modal();
 		     },
 			 error: function(){
 				bootbox.alert("오류가 발생였습니다.\n잠시 후 다시 시도해 주세요.", function() {});
 			 }
 	  	  }); 
      }
      
	function updateUser() {
		var formData = new FormData();
		formData.append("user_id", $("#user_id").val());
    		bootbox.prompt({
    		    title: "회원 권한 선택",
    		    inputType: 'select',
    		    inputOptions: [
    		        {
    		            text: '선택 해 주세요...',
    		            value: '',
    		        },
    		        {
    		            text: '관리자',
    		            value: 'ADMIN',
    		        },
    		        {
    		            text: '업체',
    		            value: 'ADVERTISER',
    		        },
    		        {
    		            text: '일반회원',
    		            value: 'MEMBER',
    		        }
    		    ],
    		    callback: function (result) {
    		    	if(result) {
	    		    	if(result == "") {
	    		    		bootbox.alert("권한을 선택해주세요.", function() {});
	    		    	} else {
	    		    		formData.append("role", result);
	    		    		update(formData);
	    		    	}
    		    	}
    		    }
    		});
	}
	
	function update(formData) {
		$.ajax({
			url: "auth",
			processData: false,
			contentType: false,
			data: formData,
			type: 'POST',
			success: function(result){
				if(result == "success") {
					bootbox.alert("수정되었습니다.", function() {
						window.location.reload(true);
					});
				} else {
					bootbox.alert("오류가 발생였습니다.\n잠시 후 다시 시도해 주세요.", function() {});
				}
			},
			error: function(){
				bootbox.alert("오류가 발생였습니다.\n잠시 후 다시 시도해 주세요.", function() {});
			}
		});
	}
	
	function leaveCancel(user_id) {
		bootbox.confirm({
		    message: "탈퇴 취소 하시겠습니까?",
		    buttons: {
		        confirm: {
		            label: 'Yes',
		            className: 'btn-success'
		        },
		        cancel: {
		            label: 'No',
		            className: 'btn-danger'
		        }
		    },
		    callback: function (result) {
		    	if(result) {
		    		$.ajax({
		    			url: "leave_cancel?user_id=" + $("#user_id").val(),
		    			processData: false,
		    			contentType: false,
		    			data: null,
		    			type: 'POST',
		    			success: function(result){
		    				if(result == "success") {
		    					bootbox.alert("탈퇴 취소 처리가 완료되었습니다.", function() {
		    						window.location.reload(true);
		    					});
		    				} else {
		    					bootbox.alert("오류가 발생였습니다.\n잠시 후 다시 시도해 주세요.", function() {});
		    				}
		    			},
		    			error: function(){
		    				bootbox.alert("오류가 발생였습니다.\n잠시 후 다시 시도해 주세요.", function() {});
		    			}
		    		});
		    	}
		    }
		});
	}
    </script>
    <!-- /Datatables -->
</body>
</html>